<!DOCTYPE html>
<html lang="en">
<head>
    <title>IO::Buffer</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='["IO", "Buffer"]'>


    <meta property="og:title" value="IO::Buffer">

  
    
    <meta name="description" content="IO::Buffer is a low-level efficient buffer for input/output.">
    <meta property="og:description" content="IO::Buffer is a low-level efficient buffer for input/output.">
  

    <meta name="keywords" content="IO::Buffer class, for, map, new, inspect, hexdump, to_s, size, valid?, transfer, null?, empty?, external?, internal?, mapped?, locked?, readonly?, locked, slice, <=>, resize, clear, free, get_value, set_value, copy, get_string, set_string, read, pread, write, pwrite">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            IO::Buffer
            
                <span class="parent">&lt;
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../files/ruby/ext/io/console/console_c.html">ruby/ext/io/console/console.c</a></li>
            
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p><a href="Buffer.html"><code>IO::Buffer</code></a> is a low-level efficient buffer for input/output. There are three ways of using buffer:</p>
<ul><li>
<p>Create an empty buffer with <a href="Buffer.html#method-c-new"><code>::new</code></a>, fill it with data using <a href="Buffer.html#method-i-copy"><code>copy</code></a> or <a href="Buffer.html#method-i-set_value"><code>set_value</code></a>, <a href="Buffer.html#method-i-set_string"><code>set_string</code></a>, get data with <a href="Buffer.html#method-i-get_string"><code>get_string</code></a>;</p>
</li><li>
<p>Create a buffer mapped to some string with <a href="Buffer.html#method-c-for"><code>::for</code></a>, then it could be used both for reading with <a href="Buffer.html#method-i-get_string"><code>get_string</code></a> or <a href="Buffer.html#method-i-get_value"><code>get_value</code></a>, and writing (writing will change the source string, too);</p>
</li><li>
<p>Create a buffer mapped to some file with <a href="Buffer.html#method-c-map"><code>::map</code></a>, then it could be used for reading and writing the underlying file.</p>
</li></ul>

<p>Interaction with string and file memory is performed by efficient low-level C mechanisms like ‘memcpy`.</p>

<p>The class is meant to be an utility for implementing more high-level mechanisms like <a href="../Fiber/SchedulerInterface.html#method-i-io_read"><code>Fiber::SchedulerInterface#io_read</code></a> and <a href="../Fiber/SchedulerInterface.html#method-i-io_write"><code>Fiber::SchedulerInterface#io_write</code></a>.</p>

<p><strong>Examples of usage:</strong></p>

<p>Empty buffer:</p>

<pre><code>buffer = IO::Buffer.new(8)  # create empty 8-byte buffer
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5d1a5c50+8 INTERNAL&gt;
# ...
buffer
#  =&gt;
# &lt;IO::Buffer 0x0000555f5d156ab0+8 INTERNAL&gt;
# 0x00000000  00 00 00 00 00 00 00 00
buffer.set_string(&#39;test&#39;, 2) # put there bytes of the &quot;test&quot; string, starting from offset 2
# =&gt; 4
buffer.get_string  # get the result
# =&gt; &quot;\x00\x00test\x00\x00&quot;
</code></pre>

<p>Buffer from string:</p>

<pre><code>string = &#39;data&#39;
buffer = IO::Buffer.for(str)
#  =&gt;
# #&lt;IO::Buffer 0x00007f3f02be9b18+4 SLICE&gt;
# ...
buffer
#  =&gt;
# #&lt;IO::Buffer 0x00007f3f02be9b18+4 SLICE&gt;
# 0x00000000  64 61 74 61                                     data

buffer.get_string(2)  # read content starting from offset 2
# =&gt; &quot;ta&quot;
buffer.set_string(&#39;---&#39;, 1) # write content, starting from offset 1
# =&gt; 3
buffer
#  =&gt;
# #&lt;IO::Buffer 0x00007f3f02be9b18+4 SLICE&gt;
# 0x00000000  64 2d 2d 2d                                     d---
string  # original string changed, too
# =&gt; &quot;d---&quot;
</code></pre>

<p>Buffer from file:</p>

<pre><code>File.write(&#39;test.txt&#39;, &#39;test data&#39;)
# =&gt; 9
buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;))
#  =&gt;
# #&lt;IO::Buffer 0x00007f3f0768c000+9 MAPPED IMMUTABLE&gt;
# ...
buffer.get_string(5, 2) # read 2 bytes, starting from offset 5
# =&gt; &quot;da&quot;
buffer.set_string(&#39;---&#39;, 1) # attempt to write
# in `set_string&#39;: Buffer is not writable! (IO::Buffer::AccessError)

# To create writable file-mapped buffer
# Open file for read-write, pass size, offset, and flags=0
buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;, &#39;r+&#39;), 9, 0, 0)
buffer.set_string(&#39;---&#39;, 1)
# =&gt; 3 -- bytes written
File.read(&#39;test.txt&#39;)
# =&gt; &quot;t--- data&quot;
</code></pre>

<p><strong>The class is experimental and the interface is subject to change.</strong></p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Buffer/AccessError.html">IO::Buffer::AccessError</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Buffer/AllocationError.html">IO::Buffer::AllocationError</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Buffer/InvalidatedError.html">IO::Buffer::InvalidatedError</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Buffer/LockedError.html">IO::Buffer::LockedError</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>#</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-3C-3D-3E">&lt;=&gt;</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-clear">clear</a>,
              </li>
            
              
              <li>
                <a href="#method-i-copy">copy</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-empty-3F">empty?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-external-3F">external?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-for">for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-free">free</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-get_string">get_string</a>,
              </li>
            
              
              <li>
                <a href="#method-i-get_value">get_value</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-hexdump">hexdump</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-inspect">inspect</a>,
              </li>
            
              
              <li>
                <a href="#method-i-internal-3F">internal?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-locked">locked</a>,
              </li>
            
              
              <li>
                <a href="#method-i-locked-3F">locked?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-map">map</a>,
              </li>
            
              
              <li>
                <a href="#method-i-mapped-3F">mapped?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>,
              </li>
            
              
              <li>
                <a href="#method-i-null-3F">null?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-pread">pread</a>,
              </li>
            
              
              <li>
                <a href="#method-i-pwrite">pwrite</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-read">read</a>,
              </li>
            
              
              <li>
                <a href="#method-i-readonly-3F">readonly?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-resize">resize</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-set_string">set_string</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_value">set_value</a>,
              </li>
            
              
              <li>
                <a href="#method-i-size">size</a>,
              </li>
            
              
              <li>
                <a href="#method-i-slice">slice</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-to_s">to_s</a>,
              </li>
            
              
              <li>
                <a href="#method-i-transfer">transfer</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-valid-3F">valid?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>W</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-write">write</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="../Comparable.html">
              Comparable
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    
      <!-- Section constants -->
      <h2 class="sectiontitle">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">BIG_ENDIAN</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_BIG_ENDIAN)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">DEFAULT_SIZE</td>
            <td>=</td>
            <td class="attr-value">SIZET2NUM(RUBY_IO_BUFFER_DEFAULT_SIZE)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">EXTERNAL</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_EXTERNAL)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">HOST_ENDIAN</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_HOST_ENDIAN)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">INTERNAL</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_INTERNAL)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LITTLE_ENDIAN</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_LITTLE_ENDIAN)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LOCKED</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_LOCKED)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAPPED</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_MAPPED)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NETWORK_ENDIAN</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_NETWORK_ENDIAN)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PAGE_SIZE</td>
            <td>=</td>
            <td class="attr-value">SIZET2NUM(RUBY_IO_BUFFER_PAGE_SIZE)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">PRIVATE</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_PRIVATE)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">READONLY</td>
            <td>=</td>
            <td class="attr-value">RB_INT2NUM(RB_IO_BUFFER_READONLY)</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-for">
            
              <b>IO::Buffer.for(string) &rarr; io_buffer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-c-for" name="method-c-for" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Creates a <a href="Buffer.html"><code>IO::Buffer</code></a> from the given string’s memory. The buffer remains associated with the string, and writing to a buffer will update the string’s contents.</p>

<p>Until <a href="Buffer.html#method-i-free"><code>free</code></a> is invoked on the buffer, either explicitly or via the garbage collector, the source string will be locked and cannot be modified.</p>

<p>If the string is frozen, it will create a read-only buffer which cannot be modified.</p>

<pre><code>string = &#39;test&#39;
buffer = IO::Buffer.for(str)
buffer.external? #=&gt; true

buffer.get_string(0, 1)
# =&gt; &quot;t&quot;
string
# =&gt; &quot;best&quot;

buffer.resize(100)
# in `resize&#39;: Cannot resize external buffer! (IO::Buffer::AccessError)
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-for_source')" id="l_method-c-for_source">show</a>
                
              </p>
              <div id="method-c-for_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_type_for(VALUE klass, VALUE string)
{
    io_buffer_experimental();

    StringValue(string);

    VALUE instance = rb_io_buffer_type_allocate(klass);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(instance, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    rb_str_locktmp(string);

    enum rb_io_buffer_flags flags = RB_IO_BUFFER_EXTERNAL;

    if (RB_OBJ_FROZEN(string))
        flags |= RB_IO_BUFFER_READONLY;

    io_buffer_initialize(data, RSTRING_PTR(string), RSTRING_LEN(string), flags, string);

    return instance;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-map">
            
              <b>IO::Buffer.map(file, [size, [offset, [flags]]]) &rarr; io_buffer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-c-map" name="method-c-map" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create an <a href="Buffer.html"><code>IO::Buffer</code></a> for reading from <code>file</code> by memory-mapping the file. <code>file_io</code> should be a <code>File</code> instance, opened for reading.</p>

<p>Optional <code>size</code> and <code>offset</code> of mapping can be specified.</p>

<p>By default, the buffer would be immutable (read only); to create a writable mapping, you need to open a file in read-write mode, and explicitly pass <code>flags</code> argument without IO::Buffer::IMMUTABLE.</p>

<pre><code>File.write(&#39;test.txt&#39;, &#39;test&#39;)

buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;), nil, 0, IO::Buffer::READONLY)
# =&gt; #&lt;IO::Buffer 0x00000001014a0000+4 MAPPED READONLY&gt;

buffer.readonly?   # =&gt; true

buffer.get_string
# =&gt; &quot;test&quot;

buffer.set_string(&#39;b&#39;, 0)
# `set_string&#39;: Buffer is not writable! (IO::Buffer::AccessError)

# create read/write mapping: length 4 bytes, offset 0, flags 0
buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;, &#39;r+&#39;), 4, 0)
buffer.set_string(&#39;b&#39;, 0)
# =&gt; 1

# Check it
File.read(&#39;test.txt&#39;)
# =&gt; &quot;best&quot;
</code></pre>

<p>Note that some operating systems may not have cache coherency between mapped buffers and file reads.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-map_source')" id="l_method-c-map_source">show</a>
                
              </p>
              <div id="method-c-map_source" class="dyn-source">
                <pre>static VALUE
io_buffer_map(int argc, VALUE *argv, VALUE klass)
{
    if (argc &lt; 1 || argc &gt; 4) {
        rb_error_arity(argc, 2, 4);
    }

    // We might like to handle a string path?
    VALUE io = argv[0];

    size_t size;
    if (argc &gt;= 2 &amp;&amp; !RB_NIL_P(argv[1])) {
        size = RB_NUM2SIZE(argv[1]);
    }
    else {
        off_t file_size = rb_file_size(io);

        // Compiler can confirm that we handled file_size &lt; 0 case:
        if (file_size &lt; 0) {
            rb_raise(rb_eArgError, &quot;Invalid negative file size!&quot;);
        }
        // Here, we assume that file_size is positive:
        else if ((uintmax_t)file_size &gt; SIZE_MAX) {
            rb_raise(rb_eArgError, &quot;File larger than address space!&quot;);
        }
        else {
            // This conversion should be safe:
            size = (size_t)file_size;
        }
    }

    off_t offset = 0;
    if (argc &gt;= 3) {
        offset = NUM2OFFT(argv[2]);
    }

    enum rb_io_buffer_flags flags = 0;
    if (argc &gt;= 4) {
        flags = RB_NUM2UINT(argv[3]);
    }

    return rb_io_buffer_map(io, size, offset, flags);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-c-new">
            
              <b>IO::Buffer.new([size = DEFAULT_SIZE, [flags = 0]]) &rarr; io_buffer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a new zero-filled <a href="Buffer.html"><code>IO::Buffer</code></a> of <code>size</code> bytes. By default, the buffer will be <em>internal</em>: directly allocated chunk of the memory. But if the requested <code>size</code> is more than OS-specific IO::Bufer::PAGE_SIZE, the buffer would be allocated using the virtual memory mechanism (anonymous <code>mmap</code> on Unix, <code>VirtualAlloc</code> on Windows). The behavior can be forced by passing <a href="Buffer.html#MAPPED"><code>IO::Buffer::MAPPED</code></a> as a second parameter.</p>

<p>Examples</p>

<pre><code>buffer = IO::Buffer.new(4)
# =&gt;
#  #&lt;IO::Buffer 0x000055b34497ea10+4 INTERNAL&gt;
#  0x00000000  00 00 00 00                                     ....

buffer.get_string(0, 1) # =&gt; &quot;\x00&quot;

buffer.set_string(&quot;test&quot;)
buffer
#  =&gt;
# #&lt;IO::Buffer 0x000055b34497ea10+4 INTERNAL&gt;
# 0x00000000  74 65 73 74                                     test
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_initialize(int argc, VALUE *argv, VALUE self)
{
    io_buffer_experimental();

    if (argc &lt; 0 || argc &gt; 2) {
        rb_error_arity(argc, 0, 2);
    }

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    size_t size;

    if (argc &gt; 0) {
        size = RB_NUM2SIZE(argv[0]);
    } else {
        size = RUBY_IO_BUFFER_DEFAULT_SIZE;
    }

    enum rb_io_buffer_flags flags = 0;
    if (argc &gt;= 2) {
        flags = RB_NUM2UINT(argv[1]);
    }
    else {
        flags |= io_flags_for_size(size);
    }

    io_buffer_initialize(data, NULL, size, flags, Qnil);

    return self;
}</pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-3C-3D-3E">
            
              <b><=>(other) &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-3C-3D-3E" name="method-i-3C-3D-3E" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Buffers are compared by size and exact contents of the memory they are referencing using <code>memcmp</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-3C-3D-3E_source')" id="l_method-i-3C-3D-3E_source">show</a>
                
              </p>
              <div id="method-i-3C-3D-3E_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_compare(VALUE self, VALUE other)
{
    const void *ptr1, *ptr2;
    size_t size1, size2;

    rb_io_buffer_get_bytes_for_reading(self, &amp;ptr1, &amp;size1);
    rb_io_buffer_get_bytes_for_reading(other, &amp;ptr2, &amp;size2);

    if (size1 &lt; size2) {
        return RB_INT2NUM(-1);
    }

    if (size1 &gt; size2) {
        return RB_INT2NUM(1);
    }

    return RB_INT2NUM(memcmp(ptr1, ptr2, size1));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-clear">
            
              <b>clear(value = 0, [offset, [length]]) &rarr; self
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-clear" name="method-i-clear" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Fill buffer with <code>value</code>, starting with <code>offset</code> and going for <code>length</code> bytes.</p>

<pre><code>buffer = IO::Buffer.for(&#39;test&#39;)
# =&gt;
#   &lt;IO::Buffer 0x00007fca40087c38+4 SLICE&gt;
#   0x00000000  74 65 73 74         test

buffer.clear
# =&gt;
#   &lt;IO::Buffer 0x00007fca40087c38+4 SLICE&gt;
#   0x00000000  00 00 00 00         ....

buf.clear(1) # fill with 1
# =&gt;
#   &lt;IO::Buffer 0x00007fca40087c38+4 SLICE&gt;
#   0x00000000  01 01 01 01         ....

buffer.clear(2, 1, 2) # fill with 2, starting from offset 1, for 2 bytes
# =&gt;
#   &lt;IO::Buffer 0x00007fca40087c38+4 SLICE&gt;
#   0x00000000  01 02 02 01         ....

buffer.clear(2, 1) # fill with 2, starting from offset 1
# =&gt;
#   &lt;IO::Buffer 0x00007fca40087c38+4 SLICE&gt;
#   0x00000000  01 02 02 02         ....
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-clear_source')" id="l_method-i-clear_source">show</a>
                
              </p>
              <div id="method-i-clear_source" class="dyn-source">
                <pre>static VALUE
io_buffer_clear(int argc, VALUE *argv, VALUE self)
{
    if (argc &gt; 3) rb_error_arity(argc, 0, 3);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    uint8_t value = 0;
    if (argc &gt;= 1) {
        value = NUM2UINT(argv[0]);
    }

    size_t offset = 0;
    if (argc &gt;= 2) {
        offset = NUM2SIZET(argv[1]);
    }

    size_t length;
    if (argc &gt;= 3) {
        length = NUM2SIZET(argv[2]);
    } else {
        length = data-&gt;size - offset;
    }

    rb_io_buffer_clear(self, value, offset, length);

    return self;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-copy">
            
              <b>copy(source, [offset, [length, [source_offset]]]) &rarr; size
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-copy" name="method-i-copy" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Efficiently copy data from a source <a href="Buffer.html"><code>IO::Buffer</code></a> into the buffer, at <code>offset</code> using <code>memcpy</code>. For copying <a href="../String.html"><code>String</code></a> instances, see <a href="Buffer.html#method-i-set_string"><code>set_string</code></a>.</p>

<pre><code>buffer = IO::Buffer.new(32)
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5ca22520+32 INTERNAL&gt;
# 0x00000000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
# 0x00000010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................  *

buffer.copy(IO::Buffer.for(&quot;test&quot;), 8)
# =&gt; 4 -- size of data copied
buffer
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5cf8fe40+32 INTERNAL&gt;
# 0x00000000  00 00 00 00 00 00 00 00 74 65 73 74 00 00 00 00 ........test....
# 0x00000010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ *
</code></pre>

<p><a href="Buffer.html#method-i-copy"><code>copy</code></a> can be used to put data into strings associated with buffer:</p>

<pre><code>string= &quot;data:    &quot;
# =&gt; &quot;data:    &quot;
buffer = IO::Buffer.for(str)
buffer.copy(IO::Buffer.for(&quot;test&quot;), 5)
# =&gt; 4
string
# =&gt; &quot;data:test&quot;
</code></pre>

<p>Attempt to copy into a read-only buffer will fail:</p>

<pre><code>File.write(&#39;test.txt&#39;, &#39;test&#39;)
buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;), nil, 0, IO::Buffer::READONLY)
buffer.copy(IO::Buffer.for(&quot;test&quot;), 8)
# in `copy&#39;: Buffer is not writable! (IO::Buffer::AccessError)
</code></pre>

<p>See <a href="Buffer.html#method-c-map"><code>::map</code></a> for details of creation of mutable file mappings, this will work:</p>

<pre><code>buffer = IO::Buffer.map(File.open(&#39;test.txt&#39;, &#39;r+&#39;))
buffer.copy(&quot;boom&quot;, 0)
# =&gt; 4
File.read(&#39;test.txt&#39;)
# =&gt; &quot;boom&quot;
</code></pre>

<p>Attempt to copy the data which will need place outside of buffer’s bounds will fail:</p>

<pre><code>buffer = IO::Buffer.new(2)
buffer.copy(&#39;test&#39;, 0)
# in `copy&#39;: Specified offset+length exceeds source size! (ArgumentError)
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-copy_source')" id="l_method-i-copy_source">show</a>
                
              </p>
              <div id="method-i-copy_source" class="dyn-source">
                <pre>static VALUE
io_buffer_copy(int argc, VALUE *argv, VALUE self)
{
    if (argc &lt; 1 || argc &gt; 4) rb_error_arity(argc, 1, 4);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    VALUE source = argv[0];
    const void *source_base;
    size_t source_size;

    rb_io_buffer_get_bytes_for_reading(source, &amp;source_base, &amp;source_size);

    return io_buffer_copy_from(data, source_base, source_size, argc-1, argv+1);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-empty-3F">
            
              <b>external? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-empty-3F" name="method-i-empty-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <pre><code>If the buffer is _external_, meaning it references from memory which is not
allocated or mapped by the buffer itself.

A buffer created using ::for has an external reference to the string&#39;s
memory.
</code></pre>

<p>External buffer can’t be resized.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-empty-3F_source')" id="l_method-i-empty-3F_source">show</a>
                
              </p>
              <div id="method-i-empty-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_empty_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;size == 0);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-external-3F">
            
              <b>external?</b>()
            
            <a href="../../classes/IO/Buffer.html#method-i-external-3F" name="method-i-external-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-external-3F_source')" id="l_method-i-external-3F_source">show</a>
                
              </p>
              <div id="method-i-external-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_external_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;flags &amp; RB_IO_BUFFER_EXTERNAL);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-free">
            
              <b>free &rarr; self
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-free" name="method-i-free" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>If the buffer references memory, release it back to the operating system.</p>
<ul><li>
<p>for a <em>mapped</em> buffer (e.g. from file): unmap.</p>
</li><li>
<p>for a buffer created from scratch: free memory.</p>
</li><li>
<p>for a buffer created from string: undo the association.</p>
</li></ul>

<p>After the buffer is freed, no further operations can’t be performed on it.</p>

<pre><code>buffer = IO::Buffer.for(&#39;test&#39;)
buffer.free
# =&gt; #&lt;IO::Buffer 0x0000000000000000+0 NULL&gt;

buffer.get_value(:U8, 0)
# in `get_value&#39;: The buffer is not allocated! (IO::Buffer::AllocationError)

buffer.get_string
# in `get_string&#39;: The buffer is not allocated! (IO::Buffer::AllocationError)

buffer.null?
# =&gt; true
</code></pre>

<p>You can resize a freed buffer to re-allocate it.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-free_source')" id="l_method-i-free_source">show</a>
                
              </p>
              <div id="method-i-free_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_free(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    if (data-&gt;flags &amp; RB_IO_BUFFER_LOCKED) {
        rb_raise(rb_eIOBufferLockedError, &quot;Buffer is locked!&quot;);
    }

    io_buffer_free(data);

    return self;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_string">
            
              <b>get_string([offset, [length, [encoding]]]) &rarr; string
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-get_string" name="method-i-get_string" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Read a chunk or all of the buffer into a string, in the specified <code>encoding</code>. If no encoding is provided <code>Encoding::BINARY</code> is used.</p>

<pre><code>buffer = IO::Buffer.for(&#39;test&#39;)
buffer.get_string
# =&gt; &quot;test&quot;
buffer.get_string(2)
# =&gt; &quot;st&quot;
buffer.get_string(2, 1)
# =&gt; &quot;s&quot;
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-get_string_source')" id="l_method-i-get_string_source">show</a>
                
              </p>
              <div id="method-i-get_string_source" class="dyn-source">
                <pre>static VALUE
io_buffer_get_string(int argc, VALUE *argv, VALUE self)
{
    if (argc &gt; 3) rb_error_arity(argc, 0, 3);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    const void *base;
    size_t size;
    io_buffer_get_bytes_for_reading(data, &amp;base, &amp;size);

    size_t offset = 0;
    size_t length = size;
    rb_encoding *encoding = rb_ascii8bit_encoding();

    if (argc &gt;= 1) {
        offset = NUM2SIZET(argv[0]);
    }

    if (argc &gt;= 2 &amp;&amp; !RB_NIL_P(argv[1])) {
        length = NUM2SIZET(argv[1]);
    } else {
        length = size - offset;
    }

    if (argc &gt;= 3) {
        encoding = rb_find_encoding(argv[2]);
    }

    io_buffer_validate_range(data, offset, length);

    return rb_enc_str_new((const char*)base + offset, length, encoding);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-get_value">
            
              <b>get_value(type, offset) &rarr; numeric
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-get_value" name="method-i-get_value" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Read from buffer a value of <code>type</code> at <code>offset</code>. <code>type</code> should be one of symbols:</p>
<ul><li>
<p><code>:U8</code>: unsigned integer, 1 byte</p>
</li><li>
<p><code>:S8</code>: signed integer, 1 byte</p>
</li><li>
<p><code>:u16</code>: unsigned integer, 2 bytes, little-endian</p>
</li><li>
<p><code>:U16</code>: unsigned integer, 2 bytes, big-endian</p>
</li><li>
<p><code>:s16</code>: signed integer, 2 bytes, little-endian</p>
</li><li>
<p><code>:S16</code>: signed integer, 2 bytes, big-endian</p>
</li><li>
<p><code>:u32</code>: unsigned integer, 4 bytes, little-endian</p>
</li><li>
<p><code>:U32</code>: unsigned integer, 4 bytes, big-endian</p>
</li><li>
<p><code>:s32</code>: signed integer, 4 bytes, little-endian</p>
</li><li>
<p><code>:S32</code>: signed integer, 4 bytes, big-endian</p>
</li><li>
<p><code>:u64</code>: unsigned integer, 8 bytes, little-endian</p>
</li><li>
<p><code>:U64</code>: unsigned integer, 8 bytes, big-endian</p>
</li><li>
<p><code>:s64</code>: signed integer, 8 bytes, little-endian</p>
</li><li>
<p><code>:S64</code>: signed integer, 8 bytes, big-endian</p>
</li><li>
<p><code>:f32</code>: float, 4 bytes, little-endian</p>
</li><li>
<p><code>:F32</code>: float, 4 bytes, big-endian</p>
</li><li>
<p><code>:f64</code>: double, 8 bytes, little-endian</p>
</li><li>
<p><code>:F64</code>: double, 8 bytes, big-endian</p>
</li></ul>

<p>Example:</p>

<pre><code>string = [1.5].pack(&#39;f&#39;)
# =&gt; &quot;\x00\x00\xC0?&quot;
IO::Buffer.for(string).get_value(:f32, 0)
# =&gt; 1.5
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-get_value_source')" id="l_method-i-get_value_source">show</a>
                
              </p>
              <div id="method-i-get_value_source" class="dyn-source">
                <pre>static VALUE
io_buffer_get_value(VALUE self, VALUE type, VALUE _offset)
{
    const void *base;
    size_t size;
    size_t offset = NUM2SIZET(_offset);

    rb_io_buffer_get_bytes_for_reading(self, &amp;base, &amp;size);

    return rb_io_buffer_get_value(base, size, RB_SYM2ID(type), offset);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-hexdump">
            
              <b>hexdump</b>()
            
            <a href="../../classes/IO/Buffer.html#method-i-hexdump" name="method-i-hexdump" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-hexdump_source')" id="l_method-i-hexdump_source">show</a>
                
              </p>
              <div id="method-i-hexdump_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_hexdump(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    VALUE result = Qnil;

    if (io_buffer_validate(data) &amp;&amp; data-&gt;base) {
        result = rb_str_buf_new(data-&gt;size*3 + (data-&gt;size/16)*12 + 1);

        io_buffer_hexdump(result, 16, data-&gt;base, data-&gt;size, 1);
    }

    return result;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-inspect">
            
              <b>inspect</b>()
            
            <a href="../../classes/IO/Buffer.html#method-i-inspect" name="method-i-inspect" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-inspect_source')" id="l_method-i-inspect_source">show</a>
                
              </p>
              <div id="method-i-inspect_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_inspect(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    VALUE result = rb_io_buffer_to_s(self);

    if (io_buffer_validate(data)) {
        // Limit the maximum size genearted by inspect.
        if (data-&gt;size &lt;= 256) {
            io_buffer_hexdump(result, 16, data-&gt;base, data-&gt;size, 0);
        }
    }

    return result;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-internal-3F">
            
              <b>internal? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-internal-3F" name="method-i-internal-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>If the buffer is <em>internal</em>, meaning it references memory allocated by the buffer itself.</p>

<p>An internal buffer is not associated with any external memory (e.g. string) or file mapping.</p>

<p>Internal buffers are created using <a href="Buffer.html#method-c-new"><code>::new</code></a> and is the default when the requested size is less than the <a href="Buffer.html#PAGE_SIZE"><code>IO::Buffer::PAGE_SIZE</code></a> and it was not requested to be mapped on creation.</p>

<p>Internal buffers can be resized, and such an operation will typically invalidate all slices, but not always.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-internal-3F_source')" id="l_method-i-internal-3F_source">show</a>
                
              </p>
              <div id="method-i-internal-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_internal_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;flags &amp; RB_IO_BUFFER_INTERNAL);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-locked">
            
              <b>locked { ... }
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-locked" name="method-i-locked" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Allows to process a buffer in exclusive way, for concurrency-safety. While the block is performed, the buffer is considered locked, and no other code can enter the lock. Also, locked buffer can’t be changed with <a href="Buffer.html#method-i-resize"><code>resize</code></a> or <a href="Buffer.html#method-i-free"><code>free</code></a>.</p>

<pre><code>buffer = IO::Buffer.new(4)
buffer.locked? #=&gt; false

Fiber.schedule do
  buffer.locked do
    buffer.write(io) # theoretical system call interface
  end
end

Fiber.schedule do
  # in `locked&#39;: Buffer already locked! (IO::Buffer::LockedError)
  buffer.locked do
    buffer.set_string(...)
  end
end
</code></pre>

<p>The following operations acquire a lock: <a href="Buffer.html#method-i-resize"><code>resize</code></a>, <a href="Buffer.html#method-i-free"><code>free</code></a>.</p>

<p>Locking is not thread safe. It is designed as a safety net around non-blocking system calls. You can only share a buffer between threads with appropriate synchronisation techniques.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-locked_source')" id="l_method-i-locked_source">show</a>
                
              </p>
              <div id="method-i-locked_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_locked(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    if (data-&gt;flags &amp; RB_IO_BUFFER_LOCKED) {
        rb_raise(rb_eIOBufferLockedError, &quot;Buffer already locked!&quot;);
    }

    data-&gt;flags |= RB_IO_BUFFER_LOCKED;

    VALUE result = rb_yield(self);

    data-&gt;flags &amp;= ~RB_IO_BUFFER_LOCKED;

    return result;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-locked-3F">
            
              <b>locked? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-locked-3F" name="method-i-locked-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>If the buffer is <em>locked</em>, meaning it is inside <a href="Buffer.html#method-i-locked"><code>locked</code></a> block execution. Locked buffer can’t be resized or freed, and another lock can’t be acquired on it.</p>

<p>Locking is not thread safe, but is a semantic used to ensure buffers don’t move while being used by a system call.</p>

<pre><code>buffer.locked do
  buffer.write(io) # theoretical system call interface
end
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-locked-3F_source')" id="l_method-i-locked-3F_source">show</a>
                
              </p>
              <div id="method-i-locked-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_locked_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;flags &amp; RB_IO_BUFFER_LOCKED);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-mapped-3F">
            
              <b>mapped? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-mapped-3F" name="method-i-mapped-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>If the buffer is <em>mapped</em>, meaning it references memory mapped by the buffer.</p>

<p>Mapped buffers are either anonymous, if created by <a href="Buffer.html#method-c-new"><code>::new</code></a> with the <a href="Buffer.html#MAPPED"><code>IO::Buffer::MAPPED</code></a> flag or if the size was at least <a href="Buffer.html#PAGE_SIZE"><code>IO::Buffer::PAGE_SIZE</code></a>, or backed by a file if created with <a href="Buffer.html#method-c-map"><code>::map</code></a>.</p>

<p>Mapped buffers can usually be resized, and such an operation will typically invalidate all slices, but not always.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-mapped-3F_source')" id="l_method-i-mapped-3F_source">show</a>
                
              </p>
              <div id="method-i-mapped-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_mapped_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;flags &amp; RB_IO_BUFFER_MAPPED);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-null-3F">
            
              <b>null? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-null-3F" name="method-i-null-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>If the buffer was freed with <a href="Buffer.html#method-i-free"><code>free</code></a> or was never allocated in the first place.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-null-3F_source')" id="l_method-i-null-3F_source">show</a>
                
              </p>
              <div id="method-i-null-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_null_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(data-&gt;base == NULL);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-pread">
            
              <b>pread</b>(p1, p2, p3)
            
            <a href="../../classes/IO/Buffer.html#method-i-pread" name="method-i-pread" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-pread_source')" id="l_method-i-pread_source">show</a>
                
              </p>
              <div id="method-i-pread_source" class="dyn-source">
                <pre>static VALUE
io_buffer_pread(VALUE self, VALUE io, VALUE length, VALUE offset)
{
    return rb_io_buffer_pread(self, io, RB_NUM2SIZE(length), NUM2OFFT(offset));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-pwrite">
            
              <b>pwrite</b>(p1, p2, p3)
            
            <a href="../../classes/IO/Buffer.html#method-i-pwrite" name="method-i-pwrite" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-pwrite_source')" id="l_method-i-pwrite_source">show</a>
                
              </p>
              <div id="method-i-pwrite_source" class="dyn-source">
                <pre>static VALUE
io_buffer_pwrite(VALUE self, VALUE io, VALUE length, VALUE offset)
{
    return rb_io_buffer_pwrite(self, io, RB_NUM2SIZE(length), NUM2OFFT(offset));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-read">
            
              <b>read</b>(p1, p2)
            
            <a href="../../classes/IO/Buffer.html#method-i-read" name="method-i-read" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-read_source')" id="l_method-i-read_source">show</a>
                
              </p>
              <div id="method-i-read_source" class="dyn-source">
                <pre>static VALUE
io_buffer_read(VALUE self, VALUE io, VALUE length)
{
    return rb_io_buffer_read(self, io, RB_NUM2SIZE(length));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-readonly-3F">
            
              <b>readonly?</b>()
            
            <a href="../../classes/IO/Buffer.html#method-i-readonly-3F" name="method-i-readonly-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-readonly-3F_source')" id="l_method-i-readonly-3F_source">show</a>
                
              </p>
              <div id="method-i-readonly-3F_source" class="dyn-source">
                <pre>static VALUE
io_buffer_readonly_p(VALUE self)
{
    return RBOOL(rb_io_buffer_readonly_p(self));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-resize">
            
              <b>resize(new_size) &rarr; self
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-resize" name="method-i-resize" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Resizes a buffer to a <code>new_size</code> bytes, preserving its content. Depending on the old and new size, the memory area associated with the buffer might be either extended, or rellocated at different address with content being copied.</p>

<pre><code>buffer = IO::Buffer.new(4)
buffer.set_string(&quot;test&quot;, 0)
buffer.resize(8) # resize to 8 bytes
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5d1a1630+8 INTERNAL&gt;
# 0x00000000  74 65 73 74 00 00 00 00                         test....
</code></pre>

<p>External buffer (created with <a href="Buffer.html#method-c-for"><code>::for</code></a>), and locked buffer can not be resized.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-resize_source')" id="l_method-i-resize_source">show</a>
                
              </p>
              <div id="method-i-resize_source" class="dyn-source">
                <pre>static VALUE
io_buffer_resize(VALUE self, VALUE size)
{
    rb_io_buffer_resize(self, NUM2SIZET(size));

    return self;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_string">
            
              <b>set_string</b>(*args)
            
            <a href="../../classes/IO/Buffer.html#method-i-set_string" name="method-i-set_string" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-set_string_source')" id="l_method-i-set_string_source">show</a>
                
              </p>
              <div id="method-i-set_string_source" class="dyn-source">
                <pre>static VALUE
io_buffer_set_string(int argc, VALUE *argv, VALUE self)
{
    if (argc &lt; 1 || argc &gt; 4) rb_error_arity(argc, 1, 4);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    VALUE string = rb_str_to_str(argv[0]);

    const void *source_base = RSTRING_PTR(string);
    size_t source_size = RSTRING_LEN(string);

    return io_buffer_copy_from(data, source_base, source_size, argc-1, argv+1);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-set_value">
            
              <b>set_value(type, offset, value) &rarr; offset
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-set_value" name="method-i-set_value" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Write to a buffer a <code>value</code> of <code>type</code> at <code>offset</code>. <code>type</code> should be one of symbols described in <a href="Buffer.html#method-i-get_value"><code>get_value</code></a>.</p>

<pre><code>buffer = IO::Buffer.new(8)
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5c9a2d50+8 INTERNAL&gt;
# 0x00000000  00 00 00 00 00 00 00 00
buffer.set_value(:U8, 1, 111)
# =&gt; 1
buffer
#  =&gt;
# #&lt;IO::Buffer 0x0000555f5c9a2d50+8 INTERNAL&gt;
# 0x00000000  00 6f 00 00 00 00 00 00                         .o......
</code></pre>

<p>Note that if the <code>type</code> is integer and <code>value</code> is <a href="../Float.html"><code>Float</code></a>, the implicit truncation is performed:</p>

<pre><code>buffer = IO::Buffer.new(8)
buffer.set_value(:U32, 0, 2.5)
buffer
#   =&gt;
#  #&lt;IO::Buffer 0x0000555f5c9a2d50+8 INTERNAL&gt;
#  0x00000000  00 00 00 02 00 00 00 00
#                       ^^ the same as if we&#39;d pass just integer 2
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-set_value_source')" id="l_method-i-set_value_source">show</a>
                
              </p>
              <div id="method-i-set_value_source" class="dyn-source">
                <pre>static VALUE
io_buffer_set_value(VALUE self, VALUE type, VALUE _offset, VALUE value)
{
    void *base;
    size_t size;
    size_t offset = NUM2SIZET(_offset);

    rb_io_buffer_get_bytes_for_writing(self, &amp;base, &amp;size);

    rb_io_buffer_set_value(base, size, RB_SYM2ID(type), offset, value);

    return SIZET2NUM(offset);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-size">
            
              <b>size &rarr; integer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-size" name="method-i-size" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Returns the size of the buffer that was explicitly set (on creation with <a href="Buffer.html#method-c-new"><code>::new</code></a> or on <a href="Buffer.html#method-i-resize"><code>resize</code></a>), or deduced on buffer’s creation from string or file.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-size_source')" id="l_method-i-size_source">show</a>
                
              </p>
              <div id="method-i-size_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_size(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return SIZET2NUM(data-&gt;size);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-slice">
            
              <b>slice(offset, length) &rarr; io_buffer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-slice" name="method-i-slice" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Produce another <a href="Buffer.html"><code>IO::Buffer</code></a> which is a slice (or view into) the current one starting at <code>offset</code> bytes and going for <code>length</code> bytes.</p>

<p>The slicing happens without copying of memory, and the slice keeps being associated with the original buffer’s source (string, or file), if any.</p>

<p>Raises <a href="../RuntimeError.html"><code>RuntimeError</code></a> if the &lt;tt&gt;offset+length&lt;tt&gt; is out of the current buffer’s bounds.</p>

<pre><code>string = &#39;test&#39;
buffer = IO::Buffer.for(string)

slice = buffer.slice(1, 2)
# =&gt;
#  #&lt;IO::Buffer 0x00007fc3d34ebc49+2 SLICE&gt;
#  0x00000000  65 73                                           es

# Put &quot;o&quot; into 0s position of the slice
slice.set_string(&#39;o&#39;, 0)
slice
# =&gt;
#  #&lt;IO::Buffer 0x00007fc3d34ebc49+2 SLICE&gt;
#  0x00000000  6f 73                                           os

# it is also visible at position 1 of the original buffer
buffer
# =&gt;
#  #&lt;IO::Buffer 0x00007fc3d31e2d80+4 SLICE&gt;
#  0x00000000  74 6f 73 74                                     tost

# ...and original string
string
# =&gt; tost
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-slice_source')" id="l_method-i-slice_source">show</a>
                
              </p>
              <div id="method-i-slice_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_slice(VALUE self, VALUE _offset, VALUE _length)
{
    // TODO fail on negative offets/lengths.
    size_t offset = NUM2SIZET(_offset);
    size_t length = NUM2SIZET(_length);

    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    io_buffer_validate_range(data, offset, length);

    VALUE instance = rb_io_buffer_type_allocate(rb_class_of(self));
    struct rb_io_buffer *slice = NULL;
    TypedData_Get_Struct(instance, struct rb_io_buffer, &amp;rb_io_buffer_type, slice);

    slice-&gt;base = (char*)data-&gt;base + offset;
    slice-&gt;size = length;

    // The source should be the root buffer:
    if (data-&gt;source != Qnil)
        slice-&gt;source = data-&gt;source;
    else
        slice-&gt;source = self;

    return instance;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-to_s">
            
              <b>to_s &rarr; string
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-to_s" name="method-i-to_s" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Short representation of the buffer. It includes the address, size and symbolic flags. This format is subject to change.</p>

<pre><code>puts IO::Buffer.new(4) # uses to_s internally
# #&lt;IO::Buffer 0x000055769f41b1a0+4 INTERNAL&gt;
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-to_s_source')" id="l_method-i-to_s_source">show</a>
                
              </p>
              <div id="method-i-to_s_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_to_s(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    VALUE result = rb_str_new_cstr(&quot;#&lt;&quot;);

    rb_str_append(result, rb_class_name(CLASS_OF(self)));
    rb_str_catf(result, &quot; %p+%&quot;PRIdSIZE, data-&gt;base, data-&gt;size);

    if (data-&gt;base == NULL) {
        rb_str_cat2(result, &quot; NULL&quot;);
    }

    if (data-&gt;flags &amp; RB_IO_BUFFER_EXTERNAL) {
        rb_str_cat2(result, &quot; EXTERNAL&quot;);
    }

    if (data-&gt;flags &amp; RB_IO_BUFFER_INTERNAL) {
        rb_str_cat2(result, &quot; INTERNAL&quot;);
    }

    if (data-&gt;flags &amp; RB_IO_BUFFER_MAPPED) {
        rb_str_cat2(result, &quot; MAPPED&quot;);
    }

    if (data-&gt;flags &amp; RB_IO_BUFFER_LOCKED) {
        rb_str_cat2(result, &quot; LOCKED&quot;);
    }

    if (data-&gt;flags &amp; RB_IO_BUFFER_READONLY) {
        rb_str_cat2(result, &quot; READONLY&quot;);
    }

    if (data-&gt;source != Qnil) {
        rb_str_cat2(result, &quot; SLICE&quot;);
    }

    if (!io_buffer_validate(data)) {
        rb_str_cat2(result, &quot; INVALID&quot;);
    }

    return rb_str_cat2(result, &quot;&gt;&quot;);
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-transfer">
            
              <b>transfer &rarr; new_io_buffer
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-transfer" name="method-i-transfer" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Transfers ownership to a new buffer, deallocating the current one.</p>

<pre><code>buffer = IO::Buffer.new(&#39;test&#39;)
other = buffer.transfer
other
#  =&gt;
# #&lt;IO::Buffer 0x00007f136a15f7b0+4 SLICE&gt;
# 0x00000000  74 65 73 74                                     test
buffer
#  =&gt;
# #&lt;IO::Buffer 0x0000000000000000+0 NULL&gt;
buffer.null?
# =&gt; true
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-transfer_source')" id="l_method-i-transfer_source">show</a>
                
              </p>
              <div id="method-i-transfer_source" class="dyn-source">
                <pre>VALUE
rb_io_buffer_transfer(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    if (data-&gt;flags &amp; RB_IO_BUFFER_LOCKED) {
        rb_raise(rb_eIOBufferLockedError, &quot;Cannot transfer ownership of locked buffer!&quot;);
    }

    VALUE instance = rb_io_buffer_type_allocate(rb_class_of(self));
    struct rb_io_buffer *transferred;
    TypedData_Get_Struct(instance, struct rb_io_buffer, &amp;rb_io_buffer_type, transferred);

    *transferred = *data;
    io_buffer_zero(data);

    return instance;
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-valid-3F">
            
              <b>valid? &rarr; true or false
</b>
            
            <a href="../../classes/IO/Buffer.html#method-i-valid-3F" name="method-i-valid-3F" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Returns whether the buffer data is accessible.</p>

<p>A buffer becomes invalid if it is a slice of another buffer which has been freed.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-valid-3F_source')" id="l_method-i-valid-3F_source">show</a>
                
              </p>
              <div id="method-i-valid-3F_source" class="dyn-source">
                <pre>static VALUE
rb_io_buffer_valid_p(VALUE self)
{
    struct rb_io_buffer *data = NULL;
    TypedData_Get_Struct(self, struct rb_io_buffer, &amp;rb_io_buffer_type, data);

    return RBOOL(io_buffer_validate(data));
}</pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-write">
            
              <b>write</b>(p1, p2)
            
            <a href="../../classes/IO/Buffer.html#method-i-write" name="method-i-write" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-write_source')" id="l_method-i-write_source">show</a>
                
              </p>
              <div id="method-i-write_source" class="dyn-source">
                <pre>static VALUE
io_buffer_write(VALUE self, VALUE io, VALUE length)
{
    return rb_io_buffer_write(self, io, RB_NUM2SIZE(length));
}</pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
