<!DOCTYPE html>
<html lang="en">
<head>
    <title>Gem::Security::Policy</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script type="text/javascript" charset="utf-8">
document.addEventListener("turbolinks:load", function() {
  // Only initialize panel if not yet initialized
  if(!$('#panel .tree ul li').length) {
    $('#links').hide();
    var panel = new Searchdoc.Panel($('#panel'), search_data, tree, '/');
    $('#search').focus();
    var s = window.location.search.match(/\?q=([^&]+)/);
    if (s) {
      s = decodeURIComponent(s[1]).replace(/\+/g, ' ');
      if (s.length > 0) {
        $('#search').val(s);
        panel.search(s, true);
      }
    }
    panel.toggle(["Gem", "Security", "Policy"]);
  }
})
</script>



    <meta property="og:title" value="Gem::Security::Policy">

  
    
    <meta name="description" content="A Gem::Security::Policy object encapsulates the settings for verifying signed gem files.  This is the base class.">
    <meta property="og:description" content="A Gem::Security::Policy object encapsulates the settings for verifying signed gem files.  This is the base class.">
  

    <meta name="keywords" content="Gem::Security::Policy class, new, check_chain, check_data, check_cert, check_key, check_root, check_trust, verify, verify_signatures">
</head>

<body>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<div class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</div>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            Gem::Security::Policy
            
                <span class="parent">&lt;
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../../files/ruby/lib/rubygems/commands/unpack_command_rb.html">ruby/lib/rubygems/commands/unpack_command.rb</a></li>
            
            <li><a href="../../../files/ruby/lib/rubygems/security/policy_rb.html">ruby/lib/rubygems/security/policy.rb</a></li>
            
            <li><a href="../../../files/ruby/lib/rubygems/security_option_rb.html">ruby/lib/rubygems/security_option.rb</a></li>
            
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>A <a href="Policy.html"><code>Gem::Security::Policy</code></a> object encapsulates the settings for verifying signed gem files.  This is the base class.  You can either declare an instance of this or use one of the preset security policies in Gem::Security::Policies.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-check_cert">check_cert</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_chain">check_chain</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_data">check_data</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_key">check_key</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_root">check_root</a>,
              </li>
            
              
              <li>
                <a href="#method-i-check_trust">check_trust</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-verify">verify</a>,
              </li>
            
              
              <li>
                <a href="#method-i-verify_signatures">verify_signatures</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="../UserInteraction.html">
              Gem::UserInteraction
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>name</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>only_signed</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>only_trusted</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>to_s</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>verify_chain</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>verify_data</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>verify_root</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>verify_signer</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-new">
            
              <b>new</b>(name, policy = {}, opt = {})
            
            <a href="../../../classes/Gem/Security/Policy.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Create a new <a href="Policy.html"><code>Gem::Security::Policy</code></a> object with the given mode and options.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L27" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 27</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">policy</span> = {}, <span class="ruby-identifier">opt</span> = {})
  <span class="ruby-identifier">require</span> <span class="ruby-string">&#39;openssl&#39;</span>

  <span class="ruby-ivar">@name</span> = <span class="ruby-identifier">name</span>

  <span class="ruby-ivar">@opt</span> = <span class="ruby-identifier">opt</span>

  <span class="ruby-comment"># Default to security</span>
  <span class="ruby-ivar">@only_signed</span>   = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@only_trusted</span>  = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@verify_chain</span>  = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@verify_data</span>   = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@verify_root</span>   = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@verify_signer</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-identifier">policy</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">key</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:verify_data</span>   <span class="ruby-keyword">then</span> <span class="ruby-ivar">@verify_data</span>   = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:verify_signer</span> <span class="ruby-keyword">then</span> <span class="ruby-ivar">@verify_signer</span> = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:verify_chain</span>  <span class="ruby-keyword">then</span> <span class="ruby-ivar">@verify_chain</span>  = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:verify_root</span>   <span class="ruby-keyword">then</span> <span class="ruby-ivar">@verify_root</span>   = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:only_trusted</span>  <span class="ruby-keyword">then</span> <span class="ruby-ivar">@only_trusted</span>  = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:only_signed</span>   <span class="ruby-keyword">then</span> <span class="ruby-ivar">@only_signed</span>   = <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-check_cert">
            
              <b>check_cert</b>(signer, issuer, time)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_cert" name="method-i-check_cert" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Ensures that <code>signer</code> is valid for <code>time</code> and was signed by the <code>issuer</code>. If the <code>issuer</code> is <code>nil</code> no verification is performed.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_cert_source')" id="l_method-i-check_cert_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L88" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_cert_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 88</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_cert</span>(<span class="ruby-identifier">signer</span>, <span class="ruby-identifier">issuer</span>, <span class="ruby-identifier">time</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing signing certificate&#39;</span> <span class="ruby-keyword">unless</span>
    <span class="ruby-identifier">signer</span>

  <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;certificate #{signer.subject}&quot;</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">not_before</span> = <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">not_before</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">not_before</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">time</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
          <span class="ruby-node">&quot;#{message} not valid before #{not_before}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">not_after</span> = <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">not_after</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">not_after</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">time</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;#{message} not valid after #{not_after}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">issuer</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">verify</span> <span class="ruby-identifier">issuer</span>.<span class="ruby-identifier">public_key</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
          <span class="ruby-node">&quot;#{message} was not issued by #{issuer.subject}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_chain">
            
              <b>check_chain</b>(chain, time)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_chain" name="method-i-check_chain" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Verifies each certificate in <code>chain</code> has signed the following certificate and is valid for the given <code>time</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_chain_source')" id="l_method-i-check_chain_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L58" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_chain_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 58</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_chain</span>(<span class="ruby-identifier">chain</span>, <span class="ruby-identifier">time</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing signing chain&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">chain</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;empty signing chain&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">each_cons</span> <span class="ruby-value">2</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">issuer</span>, <span class="ruby-identifier">cert</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">check_cert</span> <span class="ruby-identifier">cert</span>, <span class="ruby-identifier">issuer</span>, <span class="ruby-identifier">time</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;invalid signing chain: #{e.message}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_data">
            
              <b>check_data</b>(public_key, digest, signature, data)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_data" name="method-i-check_data" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Verifies that <code>data</code> matches the <code>signature</code> created by <code>public_key</code> and the <code>digest</code> algorithm.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_data_source')" id="l_method-i-check_data_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L77" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_data_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 77</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_data</span>(<span class="ruby-identifier">public_key</span>, <span class="ruby-identifier">digest</span>, <span class="ruby-identifier">signature</span>, <span class="ruby-identifier">data</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&quot;invalid signature&quot;</span> <span class="ruby-keyword">unless</span>
    <span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">verify</span> <span class="ruby-identifier">digest</span>.<span class="ruby-identifier">new</span>, <span class="ruby-identifier">signature</span>, <span class="ruby-identifier">data</span>.<span class="ruby-identifier">digest</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_key">
            
              <b>check_key</b>(signer, key)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_key" name="method-i-check_key" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Ensures the public key of <code>key</code> matches the public key in <code>signer</code></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_key_source')" id="l_method-i-check_key_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L114" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_key_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 114</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_key</span>(<span class="ruby-identifier">signer</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">signer</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">key</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@only_signed</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing key or signature&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
    <span class="ruby-node">&quot;certificate #{signer.subject} does not match the signing key&quot;</span> <span class="ruby-keyword">unless</span>
      <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_pem</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">key</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_pem</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_root">
            
              <b>check_root</b>(chain, time)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_root" name="method-i-check_root" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Ensures the root certificate in <code>chain</code> is self-signed and valid for <code>time</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_root_source')" id="l_method-i-check_root_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L132" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_root_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 132</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_root</span>(<span class="ruby-identifier">chain</span>, <span class="ruby-identifier">time</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing signing chain&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">chain</span>

  <span class="ruby-identifier">root</span> = <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">first</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing root certificate&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">root</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
        <span class="ruby-node">&quot;root certificate #{root.subject} is not self-signed &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-node">&quot;(issuer #{root.issuer})&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">root</span>.<span class="ruby-identifier">issuer</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">root</span>.<span class="ruby-identifier">subject</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-comment"># HACK to_s is for ruby 1.8</span>

  <span class="ruby-identifier">check_cert</span> <span class="ruby-identifier">root</span>, <span class="ruby-identifier">root</span>, <span class="ruby-identifier">time</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-check_trust">
            
              <b>check_trust</b>(chain, digester, trust_dir)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-check_trust" name="method-i-check_trust" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Ensures the root of <code>chain</code> has a trusted certificate in <code>trust_dir</code> and the digests of the two certificates match according to <code>digester</code></p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-check_trust_source')" id="l_method-i-check_trust_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L151" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-check_trust_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_trust</span>(<span class="ruby-identifier">chain</span>, <span class="ruby-identifier">digester</span>, <span class="ruby-identifier">trust_dir</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing signing chain&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">chain</span>

  <span class="ruby-identifier">root</span> = <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">first</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;missing root certificate&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">root</span>

  <span class="ruby-identifier">path</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span>.<span class="ruby-identifier">trust_dir</span>.<span class="ruby-identifier">cert_path</span> <span class="ruby-identifier">root</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">path</span>
    <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;root cert #{root.subject} is not trusted&quot;</span>.<span class="ruby-identifier">dup</span>

    <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; (root of signing cert #{chain.last.subject})&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-identifier">message</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">save_cert</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">X509</span><span class="ruby-operator">::</span><span class="ruby-constant">Certificate</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span> <span class="ruby-identifier">path</span>
  <span class="ruby-identifier">save_dgst</span> = <span class="ruby-identifier">digester</span>.<span class="ruby-identifier">digest</span> <span class="ruby-identifier">save_cert</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_s</span>

  <span class="ruby-identifier">pkey_str</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">public_key</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">cert_dgst</span> = <span class="ruby-identifier">digester</span>.<span class="ruby-identifier">digest</span> <span class="ruby-identifier">pkey_str</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
        <span class="ruby-node">&quot;trusted root certificate #{root.subject} checksum &quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;does not match signing root certificate checksum&quot;</span> <span class="ruby-keyword">unless</span>
    <span class="ruby-identifier">save_dgst</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cert_dgst</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-verify">
            
              <b>verify</b>(chain, key = nil, digests = {}, signatures = {}, full_name = &#39;(unknown)&#39;)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-verify" name="method-i-verify" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>For <code>full_name</code>, verifies the certificate <code>chain</code> is valid, the <code>digests</code> match the signatures <code>signatures</code> created by the signer depending on the <code>policy</code> settings.</p>

<p>If <code>key</code> is given it is used to validate the signing certificate.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-verify_source')" id="l_method-i-verify_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L211" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-verify_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 211</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verify</span>(<span class="ruby-identifier">chain</span>, <span class="ruby-identifier">key</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">digests</span> = {}, <span class="ruby-identifier">signatures</span> = {},
           <span class="ruby-identifier">full_name</span> = <span class="ruby-string">&#39;(unknown)&#39;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">signatures</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@only_signed</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>,
        <span class="ruby-node">&quot;unsigned gems are not allowed by the #{name} policy&quot;</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">digests</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-comment"># lack of signatures is irrelevant if there is nothing to check</span>
      <span class="ruby-comment"># against</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;#{full_name} is not signed&quot;</span>
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">opt</span>       = <span class="ruby-ivar">@opt</span>
  <span class="ruby-identifier">digester</span>  = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">DIGEST_ALGORITHM</span>
  <span class="ruby-identifier">trust_dir</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-value">:trust_dir</span>]
  <span class="ruby-identifier">time</span>      = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>

  <span class="ruby-identifier">_</span>, <span class="ruby-identifier">signer_digests</span> = <span class="ruby-identifier">digests</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">algorithm</span>, <span class="ruby-identifier">file_digests</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">file_digests</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">DIGEST_NAME</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@verify_data</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&#39;no digests provided (probable bug)&#39;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">signer_digests</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">signer_digests</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">signer_digests</span> = {}
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">signer</span> = <span class="ruby-identifier">chain</span>.<span class="ruby-identifier">last</span>

  <span class="ruby-identifier">check_key</span> <span class="ruby-identifier">signer</span>, <span class="ruby-identifier">key</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">key</span>

  <span class="ruby-identifier">check_cert</span> <span class="ruby-identifier">signer</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">time</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@verify_signer</span>

  <span class="ruby-identifier">check_chain</span> <span class="ruby-identifier">chain</span>, <span class="ruby-identifier">time</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@verify_chain</span>

  <span class="ruby-identifier">check_root</span> <span class="ruby-identifier">chain</span>, <span class="ruby-identifier">time</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@verify_root</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@only_trusted</span>
    <span class="ruby-identifier">check_trust</span> <span class="ruby-identifier">chain</span>, <span class="ruby-identifier">digester</span>, <span class="ruby-identifier">trust_dir</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">signatures</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">digests</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-comment"># trust is irrelevant if there&#39;s no signatures to verify</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;#{subject signer} is not trusted for #{full_name}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">signatures</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">_</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">digest</span> = <span class="ruby-identifier">signer_digests</span>[<span class="ruby-identifier">file</span>]

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;missing digest for #{file}&quot;</span> <span class="ruby-keyword">unless</span>
      <span class="ruby-identifier">digest</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">signer_digests</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">digest</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">signature</span> = <span class="ruby-identifier">signatures</span>[<span class="ruby-identifier">file</span>]

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Security</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;missing signature for #{file}&quot;</span> <span class="ruby-keyword">unless</span>
      <span class="ruby-identifier">signature</span>

    <span class="ruby-identifier">check_data</span> <span class="ruby-identifier">signer</span>.<span class="ruby-identifier">public_key</span>, <span class="ruby-identifier">digester</span>, <span class="ruby-identifier">signature</span>, <span class="ruby-identifier">digest</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@verify_data</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-verify_signatures">
            
              <b>verify_signatures</b>(spec, digests, signatures)
            
            <a href="../../../classes/Gem/Security/Policy.html#method-i-verify_signatures" name="method-i-verify_signatures" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Extracts the certificate chain from the <code>spec</code> and calls <a href="Policy.html#method-i-verify"><code>verify</code></a> to ensure the signatures and certificate chain is valid according to the policy..</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-verify_signatures_source')" id="l_method-i-verify_signatures_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/46274982bb14fa0ba0a8d22c80be8d7154385b96/lib/rubygems/security/policy.rb#L283" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-verify_signatures_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/rubygems/security/policy.rb, line 283</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verify_signatures</span>(<span class="ruby-identifier">spec</span>, <span class="ruby-identifier">digests</span>, <span class="ruby-identifier">signatures</span>)
  <span class="ruby-identifier">chain</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cert_chain</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cert_pem</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">X509</span><span class="ruby-operator">::</span><span class="ruby-constant">Certificate</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">cert_pem</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">verify</span> <span class="ruby-identifier">chain</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">digests</span>, <span class="ruby-identifier">signatures</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">full_name</span>

  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
  </body>
</html>
