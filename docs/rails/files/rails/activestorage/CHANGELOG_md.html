<!DOCTYPE html>
<html lang="en">
<head>
    <title>CHANGELOG.md</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='[]'>

</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            CHANGELOG.md
        </h2>
        <ul class="files">
            
            <li>
                rails/activestorage/CHANGELOG.md
                
                    <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activestorage/CHANGELOG.md" target="_blank" class="github_url">on GitHub</a>
                
            </li>
            <li>Last modified: 2024-06-28 01:29:16 +0300</li>
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h2 id="label-Rails+7.1.3.4+-28June+04-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.4 (June 04, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.3+-28May+16-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.3 (May 16, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.2+-28February+21-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.2 (February 21, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.1+-28February+21-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.1 (February 21, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3+-28January+16-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3 (January 16, 2024)</h2>
<ul><li>
<p>Fix N+1 query when fetching preview images for non-image assets.</p>

<p><em>Aaron Patterson &amp; Justin Searls</em></p>
</li><li>
<p>Fix all Active Storage database related models to respect <code>ActiveRecord::Base.table_name_prefix</code> configuration.</p>

<p><em>Chedli Bourguiba</em></p>
</li><li>
<p>Fix <code>ActiveStorage::Representations::ProxyController</code> not returning the proper preview image variant for previewable files.</p>

<p><em>Chedli Bourguiba</em></p>
</li><li>
<p>Fix <code>ActiveStorage::Representations::ProxyController</code> to proxy untracked variants.</p>

<p><em>Chedli Bourguiba</em></p>
</li><li>
<p>Fix direct upload forms when submit button contains nested elements.</p>

<p><em>Marc Köhlbrugge</em></p>
</li><li>
<p>When using the <code>preprocessed: true</code> option, avoid enqueuing transform jobs for blobs that are not representable.</p>

<p><em>Chedli Bourguiba</em></p>
</li><li>
<p>Process preview image variant when calling <code>ActiveStorage::Preview#processed</code>. For example, <code>attached_pdf.preview(:thumb).processed</code> will now immediately generate the full-sized preview image and the <code>:thumb</code> variant of it. Previously, the <code>:thumb</code> variant would not be generated until a further call to e.g. <code>processed.url</code>.</p>

<p><em>Chedli Bourguiba</em> and <em>Jonathan Hefner</em></p>
</li><li>
<p>Prevent <code>ActiveRecord::StrictLoadingViolationError</code> when strict loading is enabled and the variant of an Active Storage preview has already been processed (for example, by calling <code>ActiveStorage::Preview#url</code>).</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Fix <code>preprocessed: true</code> option for named variants of previewable files.</p>

<p><em>Nico Wenterodt</em></p>
</li></ul>

<h2 id="label-Rails+7.1.2+-28November+10-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.2 (November 10, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.1+-28October+11-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.1 (October 11, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.0+-28October+05-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0 (October 05, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.0.rc2+-28October+01-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.rc2 (October 01, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.0.rc1+-28September+27-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.rc1 (September 27, 2023)</h2>
<ul><li>
<p>Add <code>expires_at</code> option to <code>ActiveStorage::Blob#signed_id</code>.</p>

<pre><code>rails_blob_path(user.avatar, disposition: &quot;attachment&quot;, expires_at: 30.minutes.from_now)
&lt;%= image_tag rails_blob_path(user.avatar.variant(resize: &quot;100x100&quot;), expires_at: 30.minutes.from_now) %&gt;
</code></pre>

<p><em>Aki</em></p>
</li><li>
<p>Allow attaching <a href="../../../classes/File.html"><code>File</code></a> and <a href="../../../classes/Pathname.html"><code>Pathname</code></a> when assigning attributes, e.g.</p>

<pre><code>User.create!(avatar: File.open(&quot;image.jpg&quot;))
User.create!(avatar: file_fixture(&quot;image.jpg&quot;))
</code></pre>

<p><em>Dorian Marié</em></p>
</li></ul>

<h2 id="label-Rails+7.1.0.beta1+-28September+13-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.beta1 (September 13, 2023)</h2>
<ul><li>
<p>Disables the session in <code>ActiveStorage::Blobs::ProxyController</code> and <code>ActiveStorage::Representations::ProxyController</code> in order to allow caching by default in some CDNs as CloudFlare</p>

<p>Fixes #44136</p>

<p><em>Bruno Prieto</em></p>
</li><li>
<p>Add <code>tags</code> to <code>ActiveStorage::Analyzer::AudioAnalyzer</code> output</p>

<p><em>Keaton Roux</em></p>
</li><li>
<p>Add an option to preprocess variants</p>

<p>ActiveStorage variants are processed on the fly when they are needed but sometimes we're sure that they are accessed and want to processed them upfront.</p>

<p><code>preprocessed</code> option is added when declaring variants.</p>

<pre><code>class User &lt; ApplicationRecord
  has_one_attached :avatar do |attachable|
    attachable.variant :thumb, resize_to_limit: [100, 100], preprocessed: true
  end
end
</code></pre>

<p><em>Shouichi Kamiya</em></p>
</li><li>
<p>Fix variants not included when eager loading multiple records containing a single attachment</p>

<p>When using the <code>with_attached_#{name}</code> scope for a <code>has_one_attached</code> relation, attachment variants were not eagerly loaded.</p>

<p><em>Russell Porter</em></p>
</li><li>
<p>Allow an ActiveStorage attachment to be removed via a form post</p>

<p>Attachments can already be removed by updating the attachment to be nil such as:</p>

<pre><code>User.find(params[:id]).update!(avatar: nil)
</code></pre>

<p>However, a form cannot post a nil param, it can only post an empty string. But, posting an empty string would result in an <code>ActiveSupport::MessageVerifier::InvalidSignature: mismatched digest</code> error being raised, because it's being treated as a signed blob id.</p>

<p>Now, nil and an empty string are treated as a delete, which allows attachments to be removed via:</p>

<pre><code>User.find(params[:id]).update!(params.require(:user).permit(:avatar))
</code></pre>

<p><em>Nate Matykiewicz</em></p>
</li><li>
<p>Remove mini_mime usage in favour of marcel.</p>

<p>We have two libraries that are have similar usage. This change removes dependency on mini_mime and makes use of similar methods from marcel.</p>

<p><em>Vipul A M</em></p>
</li><li>
<p>Allow destroying active storage variants</p>

<pre><code>User.first.avatar.variant(resize_to_limit: [100, 100]).destroy
</code></pre>

<p><em>Shouichi Kamiya</em>, <em>Yuichiro NAKAGAWA</em>, <em>Ryohei UEDA</em></p>
</li><li>
<p>Add <code>sample_rate</code> to <code>ActiveStorage::Analyzer::AudioAnalyzer</code> output</p>

<p><em>Matija Čupić</em></p>
</li><li>
<p>Remove deprecated <code>purge</code> and <code>purge_later</code> methods from the attachments association.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated behavior when assigning to a collection of attachments.</p>

<p>Instead of appending to the collection, the collection is now replaced.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveStorage::Current#host</code> and <code>ActiveStorage::Current#host=</code> methods.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated invalid default content types in Active Storage configurations.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Add missing preview event to <code>ActiveStorage::LogSubscriber</code></p>

<p>A <code>preview</code> event is being instrumented in <code>ActiveStorage::Previewer</code>. However it was not added inside ActiveStorage's LogSubscriber class.</p>

<p>This will allow to have logs for when a preview happens in the same fashion as all other ActiveStorage events such as <code>upload</code> and <code>download</code> inside <code>Rails.logger</code>.</p>

<p><em>Chedli Bourguiba</em></p>
</li><li>
<p>Fix retrieving rotation value from FFmpeg on version 5.0+.</p>

<p>In FFmpeg version 5.0+ the rotation value has been removed from tags. Instead the value can be found in side_data_list. Along with this update it's possible to have values of -90, -270 to denote the video has been rotated.</p>

<p><em>Haroon Ahmed</em></p>
</li><li>
<p>Touch all corresponding model records after <a href="../../../classes/ActiveStorage/Blob.html"><code>ActiveStorage::Blob</code></a> is analyzed</p>

<p>This fixes a race condition where a record can be requested and have a cache entry built, before the initial <code>analyze_later</code> completes, which will not be invalidated until something else updates the record. This also invalidates cache entries when a blob is re-analyzed, which is helpful if a bug is fixed in an analyzer or a new analyzer is added.</p>

<p><em>Nate Matykiewicz</em></p>
</li><li>
<p>Add ability to use pre-defined variants when calling <code>preview</code> or <code>representation</code> on an attachment.</p>

<pre><code>class User &lt; ActiveRecord::Base
  has_one_attached :file do |attachable|
    attachable.variant :thumb, resize_to_limit: [100, 100]
  end
end

&lt;%= image_tag user.file.representation(:thumb) %&gt;
</code></pre>

<p><em>Richard Böhme</em></p>
</li><li>
<p><a href="../../../classes/Method.html"><code>Method</code></a> <code>attach</code> always returns the attachments except when the record is persisted, unchanged, and saving it fails, in which case it returns <code>nil</code>.</p>

<p><em>Santiago Bartesaghi</em></p>
</li><li>
<p>Fixes multiple <code>attach</code> calls within transaction not uploading files correctly.</p>

<p>In the following example, the code failed to upload all but the last file to the configured service.</p>

<pre><code>ActiveRecord::Base.transaction do
  user.attachments.attach({
    content_type: &quot;text/plain&quot;,
    filename: &quot;dummy.txt&quot;,
    io: ::StringIO.new(&quot;dummy&quot;),
  })
  user.attachments.attach({
    content_type: &quot;text/plain&quot;,
    filename: &quot;dummy2.txt&quot;,
    io: ::StringIO.new(&quot;dummy2&quot;),
  })
end

assert_equal 2, user.attachments.count
assert user.attachments.first.service.exist?(user.attachments.first.key)  # Fails
</code></pre>

<p>This was addressed by keeping track of the subchanges pending upload, and uploading them once the transaction is committed.</p>

<p>Fixes #41661</p>

<p><em>Santiago Bartesaghi</em>, <em>Bruno Vezoli</em>, <em>Juan Roig</em>, <em>Abhay Nikam</em></p>
</li><li>
<p>Raise an exception if <code>config.active_storage.service</code> is not set.</p>

<p>If Active Storage is configured and <code>config.active_storage.service</code> is not set in the respective environment's configuration file, then an exception is raised with a meaningful message when attempting to use Active Storage.</p>

<p><em>Ghouse Mohamed</em></p>
</li><li>
<p>Fixes proxy downloads of files over 5mb</p>

<p>Previously, trying to view and/or download files larger than 5mb stored in services like S3 via proxy mode could return corrupted files at around 5.2mb or cause random halts in the download. Now, <code>ActiveStorage::Blobs::ProxyController</code> correctly handles streaming these larger files from the service to the client without any issues.</p>

<p>Fixes #44679</p>

<p><em>Felipe Raul</em></p>
</li><li>
<p>Saving attachment(s) to a record returns the blob/blobs object</p>

<p>Previously, saving attachments did not return the blob/blobs that were attached. Now, saving attachments to a record with <code>#attach</code> method returns the blob or array of blobs that were attached to the record. If it fails to save the attachment(s), then it returns <code>false</code>.</p>

<p><em>Ghouse Mohamed</em></p>
</li><li>
<p>Don't stream responses in redirect mode</p>

<p>Previously, both redirect mode and proxy mode streamed their responses which caused a new thread to be created, and could end up leaking connections in the connection pool. But since redirect mode doesn't actually send any data, it doesn't need to be streamed.</p>

<p><em>Luke Lau</em></p>
</li><li>
<p>Safe for direct upload on Libraries or Frameworks</p>

<p>Enable the use of custom headers during direct uploads, which allows for the inclusion of Authorization bearer tokens or other forms of authorization tokens through headers.</p>

<p><em>Radamés Roriz</em></p>
</li></ul>

<p>Please check <a href="https://github.com/rails/rails/blob/7-0-stable/activestorage/CHANGELOG.md">7-0-stable</a> for previous changes.</p>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
    
    
    
  
</div>

    </main>
  </body>
</html>
