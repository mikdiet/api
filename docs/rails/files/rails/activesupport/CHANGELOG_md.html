<!DOCTYPE html>
<html lang="en">
<head>
    <title>CHANGELOG.md</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='[]'>

</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            CHANGELOG.md
        </h2>
        <ul class="files">
            
            <li>
                rails/activesupport/CHANGELOG.md
                
                    <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/CHANGELOG.md" target="_blank" class="github_url">on GitHub</a>
                
            </li>
            <li>Last modified: 2024-06-28 01:29:16 +0300</li>
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h2 id="label-Rails+7.1.3.4+-28June+04-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.4 (June 04, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.3+-28May+16-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.3 (May 16, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.2+-28February+21-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.2 (February 21, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3.1+-28February+21-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3.1 (February 21, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.3+-28January+16-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.3 (January 16, 2024)</h2>
<ul><li>
<p>Handle nil <code>backtrace_locations</code> in <code>ActiveSupport::SyntaxErrorProxy</code>.</p>

<p><em>Eugene Kenny</em></p>
</li><li>
<p>Fix <code>ActiveSupport::JSON.encode</code> to prevent duplicate keys.</p>

<p>If the same key exist in both <a href="../../../classes/String.html"><code>String</code></a> and <a href="../../../classes/Symbol.html"><code>Symbol</code></a> form it could lead to the same key being emitted twice.</p>

<p><em>Manish Sharma</em></p>
</li><li>
<p>Fix <code>ActiveSupport::Cache::Store#read_multi</code> when using a cache namespace and local cache strategy.</p>

<p><em>Mark Oleson</em></p>
</li><li>
<p>Fix <code>Time.now/DateTime.now/Date.today</code> to return results in a system timezone after <code>#travel_to</code>.</p>

<p>There is a bug in the current implementation of travel_to: it remembers a timezone of its argument, and all stubbed methods start returning results in that remembered timezone. However, the expected behaviour is to return results in a system timezone.</p>

<p><em>Aleksei Chernenkov</em></p>
</li><li>
<p>Fix <code>:unless_exist</code> option for <code>MemoryStore#write</code> (et al) when using a cache namespace.</p>

<p><em>S. Brent Faulkner</em></p>
</li><li>
<p>Fix <a href="../../../classes/ActiveSupport/Deprecation.html"><code>ActiveSupport::Deprecation</code></a> to handle blaming generated code.</p>

<p><em>Jean Boussier</em>, <em>fatkodima</em></p>
</li></ul>

<h2 id="label-Rails+7.1.2+-28November+10-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.2 (November 10, 2023)</h2>
<ul><li>
<p>Fix <code>:expires_in</code> option for <code>RedisCacheStore#write_multi</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix deserialization of non-string "purpose" field in Message serializer</p>

<p><em>Jacopo Beschi</em></p>
</li><li>
<p>Prevent global cache options being overwritten when setting dynamic options inside a <code>ActiveSupport::Cache::Store#fetch</code> block.</p>

<p><em>Yasha Krasnou</em></p>
</li><li>
<p>Fix missing <code>require</code> resulting in <code>NoMethodError</code> when running <code>bin/rails secrets:show</code> or <code>bin/rails secrets:edit</code>.</p>

<p><em>Stephen Ierodiaconou</em></p>
</li><li>
<p>Ensure <code>{down,up}case_first</code> returns non-frozen string.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Fix <code>#to_fs(:human_size)</code> to correctly work with negative numbers.</p>

<p><em>Earlopain</em></p>
</li><li>
<p>Fix <code>BroadcastLogger#dup</code> so that it duplicates the logger's <code>broadcasts</code>.</p>

<p><em>Andrew Novoselac</em></p>
</li><li>
<p>Fix issue where <code>bootstrap.rb</code> overwrites the <code>level</code> of a <code>BroadcastLogger</code>'s <code>broadcasts</code>.</p>

<p><em>Andrew Novoselac</em></p>
</li><li>
<p>Fix <code>ActiveSupport::Cache</code> to handle outdated Marshal payload from <a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 format.</p>

<p>Active Support's Cache is supposed to treat a Marshal payload that can no longer be deserialized as a cache miss. It fail to do so for compressed payload in the <a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 legacy format.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix <code>OrderedOptions#dig</code> for array indexes.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix time travel helpers to work when nested using with separate classes.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix <code>delete_matched</code> for file cache store to work with keys longer than the max filename size.</p>

<p><em>fatkodima</em> and <em>Jonathan Hefner</em></p>
</li><li>
<p>Fix compatibility with the <code>semantic_logger</code> gem.</p>

<p>The <code>semantic_logger</code> gem doesn't behave exactly like stdlib logger in that <code>SemanticLogger#level</code> returns a <a href="../../../classes/Symbol.html"><code>Symbol</code></a> while stdlib <code>Logger#level</code> returns an <a href="../../../classes/Integer.html"><code>Integer</code></a>.</p>

<p>This caused the various <code>LogSubscriber</code> classes in <a href="../../../classes/Rails.html"><code>Rails</code></a> to break when assigned a <code>SemanticLogger</code> instance.</p>

<p><em>Jean Boussier</em>, <em>ojab</em></p>
</li></ul>

<h2 id="label-Rails+7.1.1+-28October+11-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.1 (October 11, 2023)</h2>
<ul><li>
<p>Add support for keyword arguments when delegating calls to custom loggers from <code>ActiveSupport::BroadcastLogger</code>.</p>

<p><em>Edouard Chin</em></p>
</li><li>
<p><code>NumberHelper</code>: handle objects responding <code>to_d</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix RedisCacheStore to properly set the TTL when incrementing or decrementing.</p>

<p>This bug was only impacting Redis server older than 7.0.</p>

<p><em>Thomas Countz</em></p>
</li><li>
<p>Fix MemoryStore to prevent race conditions when incrementing or decrementing.</p>

<p><em>Pierre Jambet</em></p>
</li></ul>

<h2 id="label-Rails+7.1.0+-28October+05-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0 (October 05, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.1.0.rc2+-28October+01-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.rc2 (October 01, 2023)</h2>
<ul><li>
<p>Fix <code>AS::MessagePack</code> with <code>ENV[&quot;RAILS_MAX_THREADS&quot;]</code>.</p>

<p><em>Jonathan Hefner</em></p>
</li></ul>

<h2 id="label-Rails+7.1.0.rc1+-28September+27-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.rc1 (September 27, 2023)</h2>
<ul><li>
<p>Add a new public API for broadcasting logs</p>

<p>This feature existed for a while but was until now a private API. Broadcasting log allows to send log message to difference sinks (STDOUT, a file ...) and is used by default in the development environment to write logs both on STDOUT and in the "development.log" file.</p>

<p>Basic usage:</p>

<pre><code>stdout_logger = Logger.new(STDOUT)
file_logger = Logger.new(&quot;development.log&quot;)
broadcast = ActiveSupport::BroadcastLogger.new(stdout_logger, file_logger)

broadcast.info(&quot;Hello!&quot;) # The &quot;Hello!&quot; message is written on STDOUT and in the log file.
</code></pre>

<p>Adding other sink(s) to the broadcast:</p>

<pre><code>broadcast = ActiveSupport::BroadcastLogger.new
broadcast.broadcast_to(Logger.new(STDERR))
</code></pre>

<p>Remove a sink from the broadcast:</p>

<pre><code>stdout_logger = Logger.new(STDOUT)
broadcast = ActiveSupport::BroadcastLogger.new(stdout_logger)

broadcast.stop_broadcasting_to(stdout_logger)
</code></pre>

<p><em>Edouard Chin</em></p>
</li><li>
<p>Fix <a href="../../../classes/Range.html#method-i-overlap-3F"><code>Range#overlap?</code></a> not taking empty ranges into account on Ruby &lt; 3.3</p>

<p><em>Nobuyoshi Nakada</em>, <em>Shouichi Kamiya</em>, <em>Hartley McGuire</em></p>
</li><li>
<p>Use Ruby 3.3 <a href="../../../classes/Range.html#method-i-overlap-3F"><code>Range#overlap?</code></a> if available</p>

<p><em>Yasuo Honda</em></p>
</li></ul>

<h2 id="label-Rails+7.1.0.beta1+-28September+13-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1.0.beta1 (September 13, 2023)</h2>
<ul><li>
<p>Add <code>bigdecimal</code> as Active Support dependency that is a bundled gem candidate for Ruby 3.4.</p>

<p><code>bigdecimal</code> 3.1.4 or higher version will be installed. Ruby 2.7 and 3.0 users who want <code>bigdecimal</code> version 2.0.0 or 3.0.0 behavior as a default gem, pin the <code>bigdecimal</code> version in your application <a href="../Gemfile.html">Gemfile</a>.</p>

<p><em>Koichi ITO</em></p>
</li><li>
<p>Add <code>drb</code>, <code>mutex_m</code> and <code>base64</code> that are bundled gem candidates for Ruby 3.4</p>

<p><em>Yasuo Honda</em></p>
</li><li>
<p>When using cache format version &gt;= 7.1 or a custom serializer, expired and version-mismatched cache entries can now be detected without deserializing their values.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Make all cache stores return a boolean for <code>#delete</code></p>

<p>Previously the <code>RedisCacheStore#delete</code> would return <code>1</code> if the entry exists and <code>0</code> otherwise. Now it returns true if the entry exists and false otherwise, just like the other stores.</p>

<p>The <code>FileStore</code> would return <code>nil</code> if the entry doesn't exists and returns <code>false</code> now as well.</p>

<p><em>Petrik de Heus</em></p>
</li><li>
<p>Active Support cache stores now support replacing the default compressor via a <code>:compressor</code> option. The specified compressor must respond to <code>deflate</code> and <code>inflate</code>. For example:</p>

<p>"'ruby  module MyCompressor  def self.deflate(string)  # compression logic...  end</p>

<pre><code>def self.inflate(compressed)
  # decompression logic...
end
</code></pre>

<p>end</p>

<p>config.cache_store = :redis_cache_store, { compressor: MyCompressor }  "'</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Active Support cache stores now support a <code>:serializer</code> option. Similar to the <code>:coder</code> option, serializers must respond to <code>dump</code> and <code>load</code>. However, serializers are only responsible for serializing a cached value, whereas coders are responsible for serializing the entire <code>ActiveSupport::Cache::Entry</code> instance. Additionally, the output from serializers can be automatically compressed, whereas coders are responsible for their own compression.</p>

<p>Specifying a serializer instead of a coder also enables performance optimizations, including the bare string optimization introduced by cache format version 7.1.</p>

<p>The <code>:serializer</code> and <code>:coder</code> options are mutually exclusive. Specifying both will raise an <code>ArgumentError</code>.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Fix <code>ActiveSupport::Inflector.humanize(nil)</code> raising <code>NoMethodError: undefined method `end_with?&#39; for nil:NilClass</code>.</p>

<p><em>James Robinson</em></p>
</li><li>
<p>Don't show secrets for <code>ActiveSupport::KeyGenerator#inspect</code>.</p>

<p>Before:</p>

<pre><code>ActiveSupport::KeyGenerator.new(secret).inspect
&quot;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038 ... @secret=\&quot;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;&quot;
</code></pre>

<p>After:</p>

<pre><code>ActiveSupport::KeyGenerator::Aes256Gcm(secret).inspect
&quot;#&lt;ActiveSupport::KeyGenerator:0x0000000104888038&gt;&quot;
</code></pre>

<p><em>Petrik de Heus</em></p>
</li><li>
<p>Improve error message when EventedFileUpdateChecker is used without a compatible version of the Listen gem</p>

<p><em>Hartley McGuire</em></p>
</li><li>
<p>Add <code>:report</code> behavior for Deprecation</p>

<p>Setting <code>config.active_support.deprecation = :report</code> uses the error reporter to report deprecation warnings to <code>ActiveSupport::ErrorReporter</code>.</p>

<p>Deprecations are reported as handled errors, with a severity of <code>:warning</code>.</p>

<p>Useful to report deprecations happening in production to your bug tracker.</p>

<p><em>Étienne Barrié</em></p>
</li><li>
<p>Rename <code>Range#overlaps?</code> to <code>#overlap?</code> and add alias for backwards compatibility</p>

<p><em>Christian Schmidt</em></p>
</li><li>
<p>Fix <code>EncryptedConfiguration</code> returning incorrect values for some <code>Hash</code> methods</p>

<p><em>Hartley McGuire</em></p>
</li><li>
<p>Don't show secrets for <code>MessageEncryptor#inspect</code>.</p>

<p>Before:</p>

<pre><code>ActiveSupport::MessageEncryptor.new(secret, cipher: &quot;aes-256-gcm&quot;).inspect
&quot;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038 ... @secret=\&quot;\\xAF\\bFh]LV}q\\nl\\xB2U\\xB3 ... &gt;&quot;
</code></pre>

<p>After:</p>

<pre><code>ActiveSupport::MessageEncryptor.new(secret, cipher: &quot;aes-256-gcm&quot;).inspect
&quot;#&lt;ActiveSupport::MessageEncryptor:0x0000000104888038&gt;&quot;
</code></pre>

<p><em>Petrik de Heus</em></p>
</li><li>
<p>Don't show contents for <code>EncryptedConfiguration#inspect</code>.</p>

<p>Before:</p>

<pre><code>Rails.application.credentials.inspect
&quot;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8 ... @config={:secret=&gt;\&quot;something secret\&quot;} ... @key_file_contents=\&quot;915e4ea054e011022398dc242\&quot; ...&gt;&quot;
</code></pre>

<p>After:</p>

<pre><code>Rails.application.credentials.inspect
&quot;#&lt;ActiveSupport::EncryptedConfiguration:0x000000010d2b38e8&gt;&quot;
</code></pre>

<p><em>Petrik de Heus</em></p>
</li><li>
<p><code>ERB::Util.html_escape_once</code> always returns an <code>html_safe</code> string.</p>

<p>This method previously maintained the <code>html_safe?</code> property of a string on the return value. Because this string has been escaped, however, not marking it as <code>html_safe</code> causes entities to be double-escaped.</p>

<p>As an example, take this view snippet:</p>

<p><code>html   &lt;p&gt;&lt;%= html_escape_once(&quot;this &amp; that &amp;amp; the other&quot;) %&gt;&lt;/p&gt; </code></p>

<p>Before this change, that would be double-escaped and render as:</p>

<p><code>html   &lt;p&gt;this &amp;amp;amp; that &amp;amp;amp; the other&lt;/p&gt; </code></p>

<p>After this change, it renders correctly as:</p>

<p><code>html   &lt;p&gt;this &amp;amp; that &amp;amp; the other&lt;/p&gt; </code></p>

<p>Fixes #48256</p>

<p><em>Mike Dalessio</em></p>
</li><li>
<p>Deprecate <code>SafeBuffer#clone_empty</code>.</p>

<p>This method has not been used internally since <a href="../../../classes/Rails.html"><code>Rails</code></a> 4.2.0.</p>

<p><em>Mike Dalessio</em></p>
</li><li>
<p><code>MessageEncryptor</code>, <code>MessageVerifier</code>, and <code>config.active_support.message_serializer</code> now accept <code>:message_pack</code> and <code>:message_pack_allow_marshal</code> as serializers. These serializers require the {<code>msgpack</code> gem}[https://rubygems.org/gems/msgpack] (&gt;= 1.7.0).</p>

<p>The Message Pack format can provide improved performance and smaller payload sizes. It also supports round-tripping some Ruby types that are not supported by JSON. For example:</p>

<p>"'ruby  verifier = <a href="../../../classes/ActiveSupport/MessageVerifier.html#method-c-new"><code>ActiveSupport::MessageVerifier.new</code></a>("secret")  data = [{ a: 1 }, { b: 2 }.with_indifferent_access, 1.to_d, <a href="../../../classes/Time.html#method-c-at"><code>Time.at</code></a>(0, 123)]  message = verifier.generate(data)</p>

<p># BEFORE with config.active_support.message_serializer = :json  verifier.verified(message)  # =&gt; [{"a"=&gt;1}, {"b"=&gt;2}, "1.0", "1969-12-31T18:00:00.000-06:00"]  verifier.verified(message).map(&amp;:class)  # =&gt; [Hash, <a href="../../../classes/Hash.html"><code>Hash</code></a>, <a href="../../../classes/String.html"><code>String</code></a>, String]</p>

<p># AFTER with config.active_support.message_serializer = :message_pack  verifier.verified(message)  # =&gt; [{:a=&gt;1}, {"b"=&gt;2}, 0.1e1, 1969-12-31 18:00:00.000123 -0600]  verifier.verified(message).map(&amp;:class)  # =&gt; [Hash, <a href="../../../classes/ActiveSupport/HashWithIndifferentAccess.html"><code>ActiveSupport::HashWithIndifferentAccess</code></a>, <a href="../../../classes/BigDecimal.html"><code>BigDecimal</code></a>, Time]  "'</p>

<p>The <code>:message_pack</code> serializer can fall back to deserializing with <code>ActiveSupport::JSON</code> when necessary, and the <code>:message_pack_allow_marshal</code> serializer can fall back to deserializing with <code>Marshal</code> as well as <code>ActiveSupport::JSON</code>. Additionally, the <code>:marshal</code>, <code>:json</code>, and <code>:json_allow_marshal</code> serializers can now fall back to deserializing with <code>ActiveSupport::MessagePack</code> when necessary. These behaviors ensure old messages can still be read so that migration is easier.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>A new <code>7.1</code> cache format is available which includes an optimization for bare string values such as view fragments.</p>

<p>The <code>7.1</code> cache format is used by default for new apps, and existing apps can enable the format by setting <code>config.load_defaults 7.1</code> or by setting <code>config.active_support.cache_format_version = 7.1</code> in <code>config/application.rb</code> or a <code>config/environments/*.rb</code> file.</p>

<p>Cache entries written using the <code>6.1</code> or <code>7.0</code> cache formats can be read when using the <code>7.1</code> format. To perform a rolling deploy of a <a href="../../../classes/Rails.html"><code>Rails</code></a> 7.1 upgrade, wherein servers that have not yet been upgraded must be able to read caches from upgraded servers, leave the cache format unchanged on the first deploy, then enable the <code>7.1</code> cache format on a subsequent deploy.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Active Support cache stores can now use a preconfigured serializer based on <code>ActiveSupport::MessagePack</code> via the <code>:serializer</code> option:</p>

<p><code>ruby   config.cache_store = :redis_cache_store, { serializer: :message_pack } </code></p>

<p>The <code>:message_pack</code> serializer can reduce cache entry sizes and improve performance, but requires the {<code>msgpack</code> gem}[https://rubygems.org/gems/msgpack] (&gt;= 1.7.0).</p>

<p>The <code>:message_pack</code> serializer can read cache entries written by the default serializer, and the default serializer can now read entries written by the <code>:message_pack</code> serializer. These behaviors make it easy to migrate between serializer without invalidating the entire cache.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p><code>Object#deep_dup</code> no longer duplicate named classes and modules.</p>

<p>Before:</p>

<pre><code>hash = { class: Object, module: Kernel }
hash.deep_dup # =&gt; {:class=&gt;#&lt;Class:0x00000001063ffc80&gt;, :module=&gt;#&lt;Module:0x00000001063ffa00&gt;}
</code></pre>

<p>After:</p>

<pre><code>hash = { class: Object, module: Kernel }
hash.deep_dup # =&gt; {:class=&gt;Object, :module=&gt;Kernel}
</code></pre>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Consistently raise an <code>ArgumentError</code> if the <code>ActiveSupport::Cache</code> key is blank.</p>

<p><em>Joshua Young</em></p>
</li><li>
<p>Deprecate usage of the singleton <code>ActiveSupport::Deprecation</code>.</p>

<p>All usage of <code>ActiveSupport::Deprecation</code> as a singleton is deprecated, the most common one being <code>ActiveSupport::Deprecation.warn</code>. Gem authors should now create their own deprecator (<code>ActiveSupport::Deprecation</code> object), and use it to emit deprecation warnings.</p>

<p>Calling any of the following without specifying a deprecator argument is also deprecated:  * <a href="../../../classes/Module.html#method-i-deprecate"><code>Module.deprecate</code></a>  * deprecate_constant  * DeprecatedObjectProxy  * DeprecatedInstanceVariableProxy  * DeprecatedConstantProxy  * deprecation-related test assertions</p>

<p>Use of <code>ActiveSupport::Deprecation.silence</code> and configuration methods like <code>behavior=</code>, <code>disallowed_behavior=</code>, <code>disallowed_warnings=</code> should now be aimed at the <a href="https://api.rubyonrails.org/classes/Rails/Application.html#method-i-deprecators">application's deprecators</a>.</p>

<pre><code>Rails.application.deprecators.silence do
  # code that emits deprecation warnings
end
</code></pre>

<p>If your gem has a Railtie or Engine, it's encouraged to add your deprecator to the application's deprecators, that way the deprecation related configuration options will apply to it as well, e.g. <code>config.active_support.report_deprecations</code> set to <code>false</code> in the production environment will also disable your deprecator.</p>

<pre><code>initializer &quot;my_gem.deprecator&quot; do |app|
  app.deprecators[:my_gem] = MyGem.deprecator
end
</code></pre>

<p><em>Étienne Barrié</em></p>
</li><li>
<p>Add <code>Object#with</code> to set and restore public attributes around a block</p>

<pre><code>client.timeout # =&gt; 5
client.with(timeout: 1) do
  client.timeout # =&gt; 1
end
client.timeout # =&gt; 5
</code></pre>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Remove deprecated support to generate incorrect RFC 4122 UUIDs when providing a namespace ID that is not one of the constants defined on <code>Digest::UUID</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecate <code>config.active_support.use_rfc4122_namespaced_uuids</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove implicit conversion of objects into <code>String</code> by <code>ActiveSupport::SafeBuffer</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>active_support/core_ext/range/include_time_with_zone</code> file.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecate <code>config.active_support.remove_deprecated_time_with_zone_name</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated override of <code>ActiveSupport::TimeWithZone.name</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecate <code>config.active_support.disable_to_s_conversion</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated option to passing a format to <code>#to_s</code> in <code>Array</code>, <code>Range</code>, <code>Date</code>, <code>DateTime</code>, <code>Time</code>, <code>BigDecimal</code>, <code>Float</code> and, <code>Integer</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveSupport::PerThreadRegistry</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated override of <code>Enumerable#sum</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecated initializing a <code>ActiveSupport::Cache::MemCacheStore</code> with an instance of <code>Dalli::Client</code>.</p>

<p>Deprecate the undocumented option of providing an already-initialized instance of <code>Dalli::Client</code> to <code>ActiveSupport::Cache::MemCacheStore</code>. Such clients could be configured with unrecognized options, which could lead to unexpected behavior. Instead, provide addresses as documented.</p>

<p><em>aledustet</em></p>
</li><li>
<p>Stub <code>Time.new()</code> in <code>TimeHelpers#travel_to</code></p>

<p><code>ruby   travel_to Time.new(2004, 11, 24) do     # Inside the `travel_to` block `Time.new` is stubbed     assert_equal 2004, Time.new.year   end </code></p>

<p><em>fatkodima</em></p>
</li><li>
<p>Raise <code>ActiveSupport::MessageEncryptor::InvalidMessage</code> from <code>ActiveSupport::MessageEncryptor#decrypt_and_verify</code> regardless of cipher. Previously, when a <code>MessageEncryptor</code> was using a non-AEAD cipher such as AES-256-CBC, a corrupt or tampered message would raise <code>ActiveSupport::MessageVerifier::InvalidSignature</code>. Now, all ciphers raise the same error:</p>

<p>"'ruby  encryptor = <a href="../../../classes/ActiveSupport/MessageEncryptor.html#method-c-new"><code>ActiveSupport::MessageEncryptor.new</code></a>("x" * 32, cipher: "aes-256-gcm")  message = encryptor.encrypt_and_sign("message")  encryptor.decrypt_and_verify(message.next)  # =&gt; raises <a href="../../../classes/ActiveSupport/MessageEncryptor/InvalidMessage.html"><code>ActiveSupport::MessageEncryptor::InvalidMessage</code></a></p>

<p>encryptor = <a href="../../../classes/ActiveSupport/MessageEncryptor.html#method-c-new"><code>ActiveSupport::MessageEncryptor.new</code></a>("x" * 32, cipher: "aes-256-cbc")  message = encryptor.encrypt_and_sign("message")  encryptor.decrypt_and_verify(message.next)  # BEFORE:  # =&gt; raises <a href="../../../classes/ActiveSupport/MessageVerifier/InvalidSignature.html"><code>ActiveSupport::MessageVerifier::InvalidSignature</code></a>  # AFTER:  # =&gt; raises <a href="../../../classes/ActiveSupport/MessageEncryptor/InvalidMessage.html"><code>ActiveSupport::MessageEncryptor::InvalidMessage</code></a>  "'</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Support <code>nil</code> original values when using <code>ActiveSupport::MessageVerifier#verify</code>. Previously, <code>MessageVerifier#verify</code> did not work with <code>nil</code> original values, though both <code>MessageVerifier#verified</code> and <code>MessageEncryptor#decrypt_and_verify</code> do:</p>

<p>"'ruby  encryptor = <a href="../../../classes/ActiveSupport/MessageEncryptor.html#method-c-new"><code>ActiveSupport::MessageEncryptor.new(secret)</code></a>  message = encryptor.encrypt_and_sign(nil)</p>

<p>encryptor.decrypt_and_verify(message)  # =&gt; nil</p>

<p>verifier = <a href="../../../classes/ActiveSupport/MessageVerifier.html#method-c-new"><code>ActiveSupport::MessageVerifier.new(secret)</code></a>  message = verifier.generate(nil)</p>

<p>verifier.verified(message)  # =&gt; nil</p>

<p>verifier.verify(message)  # BEFORE:  # =&gt; raises <a href="../../../classes/ActiveSupport/MessageVerifier/InvalidSignature.html"><code>ActiveSupport::MessageVerifier::InvalidSignature</code></a>  # AFTER:  # =&gt; nil  "'</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Maintain <code>html_safe?</code> on html_safe strings when sliced with <code>slice</code>, <code>slice!</code>, or <code>chr</code> method.</p>

<p>Previously, <code>html_safe?</code> was only maintained when the html_safe strings were sliced with <code>[]</code> method. Now, <code>slice</code>, <code>slice!</code>, and <code>chr</code> methods will maintain <code>html_safe?</code> like <code>[]</code> method.</p>

<pre><code>string = &quot;&lt;div&gt;test&lt;/div&gt;&quot;.html_safe
string.slice(0, 1).html_safe? # =&gt; true
string.slice!(0, 1).html_safe? # =&gt; true
# maintain html_safe? after the slice!
string.html_safe? # =&gt; true
string.chr.html_safe? # =&gt; true
</code></pre>

<p><em>Michael Go</em></p>
</li><li>
<p>Add <code>Object#in?</code> support for open ranges.</p>

<pre><code>assert Date.today.in?(..Date.tomorrow)
assert_not Date.today.in?(Date.tomorrow..)
</code></pre>

<p><em>Ignacio Galindo</em></p>
</li><li>
<p><code>config.i18n.raise_on_missing_translations = true</code> now raises on any missing translation.</p>

<p>Previously it would only raise when called in a view or controller. Now it will raise anytime <code>I18n.t</code> is provided an unrecognised key.</p>

<p>If you do not want this behaviour, you can customise the i18n exception handler. See the upgrading guide or i18n guide for more information.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p><code>ActiveSupport::CurrentAttributes</code> now raises if a restricted attribute name is used.</p>

<p>Attributes such as <code>set</code> and <code>reset</code> cannot be used as they clash with the <code>CurrentAttributes</code> public API.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p><code>HashWithIndifferentAccess#transform_keys</code> now takes a <a href="../../../classes/Hash.html"><code>Hash</code></a> argument, just as Ruby’s <code>Hash#transform_keys</code> does.</p>

<p><em>Akira Matsuda</em></p>
</li><li>
<p><code>delegate</code> now defines method with proper arity when delegating to a <a href="../../../classes/Class.html"><code>Class</code></a>. With this change, it defines faster method (3.5x faster with no argument). However, in order to gain this benefit, the delegation target method has to be defined before declaring the delegation.</p>

<pre><code># This defines 3.5 times faster method than before
class C
  def self.x() end
  delegate :x, to: :class
end

class C
  # This works but silently falls back to old behavior because
  # `delegate` cannot find the definition of `x`
  delegate :x, to: :class
  def self.x() end
end
</code></pre>

<p><em>Akira Matsuda</em></p>
</li><li>
<p><code>assert_difference</code> message now includes what changed.</p>

<p>This makes it easier to debug non-obvious failures.</p>

<p>Before:</p>

<pre><code>&quot;User.count&quot; didn&#39;t change by 32.
Expected: 1611
  Actual: 1579
</code></pre>

<p>After:</p>

<pre><code>&quot;User.count&quot; didn&#39;t change by 32, but by 0.
Expected: 1611
  Actual: 1579
</code></pre>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Add ability to match exception messages to <code>assert_raises</code> assertion</p>

<p>Instead of this</p>

<pre><code>error = assert_raises(ArgumentError) do
  perform_service(param: &#39;exception&#39;)
end
assert_match(/incorrect param/i, error.message)
</code></pre>

<p>you can now write this</p>

<pre><code>assert_raises(ArgumentError, match: /incorrect param/i) do
  perform_service(param: &#39;exception&#39;)
end
</code></pre>

<p><em>fatkodima</em></p>
</li><li>
<p>Add <code>Rails.env.local?</code> shorthand for <code>Rails.env.development? || Rails.env.test?</code>.</p>

<p><em>DHH</em></p>
</li><li>
<p><code>ActiveSupport::Testing::TimeHelpers</code> now accepts named <code>with_usec</code> argument to <code>freeze_time</code>, <code>travel</code>, and <code>travel_to</code> methods. Passing true prevents truncating the destination time with <code>change(usec: 0)</code>.</p>

<p><em>KevSlashNull</em>, and <em>serprex</em></p>
</li><li>
<p><code>ActiveSupport::CurrentAttributes.resets</code> now accepts a method name</p>

<p>The block API is still the recommended approach, but now both APIs are supported:</p>

<pre><code>class Current &lt; ActiveSupport::CurrentAttributes
  resets { Time.zone = nil }
  resets :clear_time_zone
end
</code></pre>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Ensure <code>ActiveSupport::Testing::Isolation::Forking</code> closes pipes</p>

<p>Previously, <code>Forking.run_in_isolation</code> opened two ends of a pipe. The fork process closed the read end, wrote to it, and then terminated (which presumably closed the file descriptors on its end). The parent process closed the write end, read from it, and returned, never closing the read end.</p>

<p>This resulted in an accumulation of open file descriptors, which could cause errors if the limit is reached.</p>

<p><em>Sam Bostock</em></p>
</li><li>
<p>Fix <code>Time#change</code> and <code>Time#advance</code> for times around the end of Daylight Saving <a href="../../../classes/Time.html"><code>Time</code></a>.</p>

<p>Previously, when <code>Time#change</code> or <code>Time#advance</code> constructed a time inside the final stretch of Daylight Saving <a href="../../../classes/Time.html"><code>Time</code></a> (DST), the non-DST offset would always be chosen for local times:</p>

<pre><code># DST ended just before 2021-11-07 2:00:00 AM in US/Eastern.
ENV[&quot;TZ&quot;] = &quot;US/Eastern&quot;

time = Time.local(2021, 11, 07, 00, 59, 59) + 1
# =&gt; 2021-11-07 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0500

time = Time.local(2021, 11, 06, 01, 00, 00)
# =&gt; 2021-11-06 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(days: 1)
# =&gt; 2021-11-07 01:00:00 -0500
</code></pre>

<p>And the DST offset would always be chosen for times with a <code>TimeZone</code> object:</p>

<pre><code>Time.zone = &quot;US/Eastern&quot;

time = Time.new(2021, 11, 07, 02, 00, 00, Time.zone) - 3600
# =&gt; 2021-11-07 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0400

time = Time.new(2021, 11, 8, 01, 00, 00, Time.zone)
# =&gt; 2021-11-08 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(days: -1)
# =&gt; 2021-11-07 01:00:00 -0400
</code></pre>

<p>Now, <code>Time#change</code> and <code>Time#advance</code> will choose the offset that matches the original time's offset when possible:</p>

<pre><code>ENV[&quot;TZ&quot;] = &quot;US/Eastern&quot;

time = Time.local(2021, 11, 07, 00, 59, 59) + 1
# =&gt; 2021-11-07 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0400

time = Time.local(2021, 11, 06, 01, 00, 00)
# =&gt; 2021-11-06 01:00:00 -0400
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0400
time.advance(days: 1)
# =&gt; 2021-11-07 01:00:00 -0400

Time.zone = &quot;US/Eastern&quot;

time = Time.new(2021, 11, 07, 02, 00, 00, Time.zone) - 3600
# =&gt; 2021-11-07 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(seconds: 0)
# =&gt; 2021-11-07 01:00:00 -0500

time = Time.new(2021, 11, 8, 01, 00, 00, Time.zone)
# =&gt; 2021-11-08 01:00:00 -0500
time.change(day: 07)
# =&gt; 2021-11-07 01:00:00 -0500
time.advance(days: -1)
# =&gt; 2021-11-07 01:00:00 -0500
</code></pre>

<p><em>Kevin Hall</em>, <em>Takayoshi Nishida</em>, and <em>Jonathan Hefner</em></p>
</li><li>
<p>Fix MemoryStore to preserve entries TTL when incrementing or decrementing</p>

<p>This is to be more consistent with how MemCachedStore and RedisCacheStore behaves.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p><code>Rails.error.handle</code> and <code>Rails.error.record</code> filter now by multiple error classes.</p>

<pre><code>Rails.error.handle(IOError, ArgumentError) do
  1 + &#39;1&#39; # raises TypeError
end
1 + 1 # TypeErrors are not IOErrors or ArgumentError, so this will *not* be handled
</code></pre>

<p><em>Martin Spickermann</em></p>
</li><li>
<p><code>Class#subclasses</code> and <code>Class#descendants</code> now automatically filter reloaded classes.</p>

<p>Previously they could return old implementations of reloadable classes that have been dereferenced but not yet garbage collected.</p>

<p>They now automatically filter such classes like <code>DescendantTracker#subclasses</code> and <code>DescendantTracker#descendants</code>.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p><code>Rails.error.report</code> now marks errors as reported to avoid reporting them twice.</p>

<p>In some cases, users might want to report errors explicitly with some extra context before letting it bubble up.</p>

<p>This also allows to safely catch and report errors outside of the execution context.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Add <code>assert_error_reported</code> and <code>assert_no_error_reported</code></p>

<p>Allows to easily asserts an error happened but was handled</p>

<pre><code>report = assert_error_reported(IOError) do
  # ...
end
assert_equal &quot;Oops&quot;, report.error.message
assert_equal &quot;admin&quot;, report.context[:section]
assert_equal :warning, report.severity
assert_predicate report, :handled?
</code></pre>

<p><em>Jean Boussier</em></p>
</li><li>
<p><code>ActiveSupport::Deprecation</code> behavior callbacks can now receive the deprecator instance as an argument. This makes it easier for such callbacks to change their behavior based on the deprecator’s state. For example, based on the deprecator’s <code>debug</code> flag.</p>

<p>3-arity and splat-args callbacks such as the following will now be passed the deprecator instance as their third argument:</p>
<ul><li>
<p><code>-&gt;(message, callstack, deprecator) { ... }</code></p>
</li><li>
<p><code>-&gt;(*args) { ... }</code></p>
</li><li>
<p><code>-&gt;(message, *other_args) { ... }</code></p>
</li></ul>

<p>2-arity and 4-arity callbacks such as the following will continue to behave the same as before:</p>
<ul><li>
<p><code>-&gt;(message, callstack) { ... }</code></p>
</li><li>
<p><code>-&gt;(message, callstack, deprecation_horizon, gem_name) { ... }</code></p>
</li><li>
<p><code>-&gt;(message, callstack, *deprecation_details) { ... }</code></p>
</li></ul>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p><code>ActiveSupport::Deprecation#disallowed_warnings</code> now affects the instance on which it is configured.</p>

<p>This means that individual <code>ActiveSupport::Deprecation</code> instances can be configured with their own disallowed warnings, and the global <code>ActiveSupport::Deprecation.disallowed_warnings</code> now only affects the global <code>ActiveSupport::Deprecation.warn</code>.</p>

<p><strong>Before</strong></p>

<pre><code>ActiveSupport::Deprecation.disallowed_warnings = [&quot;foo&quot;]
deprecator = ActiveSupport::Deprecation.new(&quot;2.0&quot;, &quot;MyCoolGem&quot;)
deprecator.disallowed_warnings = [&quot;bar&quot;]

ActiveSupport::Deprecation.warn(&quot;foo&quot;) # =&gt; raise ActiveSupport::DeprecationException
ActiveSupport::Deprecation.warn(&quot;bar&quot;) # =&gt; print &quot;DEPRECATION WARNING: bar&quot;
deprecator.warn(&quot;foo&quot;)                 # =&gt; raise ActiveSupport::DeprecationException
deprecator.warn(&quot;bar&quot;)                 # =&gt; print &quot;DEPRECATION WARNING: bar&quot;
</code></pre>

<p><strong>After</strong></p>

<pre><code>ActiveSupport::Deprecation.disallowed_warnings = [&quot;foo&quot;]
deprecator = ActiveSupport::Deprecation.new(&quot;2.0&quot;, &quot;MyCoolGem&quot;)
deprecator.disallowed_warnings = [&quot;bar&quot;]

ActiveSupport::Deprecation.warn(&quot;foo&quot;) # =&gt; raise ActiveSupport::DeprecationException
ActiveSupport::Deprecation.warn(&quot;bar&quot;) # =&gt; print &quot;DEPRECATION WARNING: bar&quot;
deprecator.warn(&quot;foo&quot;)                 # =&gt; print &quot;DEPRECATION WARNING: foo&quot;
deprecator.warn(&quot;bar&quot;)                 # =&gt; raise ActiveSupport::DeprecationException
</code></pre>

<p>Note that global <code>ActiveSupport::Deprecation</code> methods such as <code>ActiveSupport::Deprecation.warn</code> and <code>ActiveSupport::Deprecation.disallowed_warnings</code> have been deprecated.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Add italic and underline support to <code>ActiveSupport::LogSubscriber#color</code></p>

<p>Previously, only bold text was supported via a positional argument. This allows for bold, italic, and underline options to be specified for colored logs.</p>

<pre><code>info color(&quot;Hello world!&quot;, :red, bold: true, underline: true)
</code></pre>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Add <code>String#downcase_first</code> method.</p>

<p>This method is the corollary of <code>String#upcase_first</code>.</p>

<p><em>Mark Schneider</em></p>
</li><li>
<p><code>thread_mattr_accessor</code> will call <code>.dup.freeze</code> on non-frozen default values.</p>

<p>This provides a basic level of protection against different threads trying to mutate a shared default object.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Add <code>raise_on_invalid_cache_expiration_time</code> config to <code>ActiveSupport::Cache::Store</code></p>

<p>Specifies if an <code>ArgumentError</code> should be raised if <code>Rails.cache</code> <code>fetch</code> or <code>write</code> are given an invalid <code>expires_at</code> or <code>expires_in</code> time.</p>

<p>Options are <code>true</code>, and <code>false</code>. If <code>false</code>, the exception will be reported as <code>handled</code> and logged instead. Defaults to <code>true</code> if <code>config.load_defaults &gt;= 7.1</code>.</p>

<p> <em>Trevor Turk</em></p>
</li><li>
<p><code>ActiveSupport::Cache::Store#fetch</code> now passes an options accessor to the block.</p>

<p>It makes possible to override cache options:</p>

<pre><code>Rails.cache.fetch(&quot;3rd-party-token&quot;) do |name, options|
  token = fetch_token_from_remote
  # set cache&#39;s TTL to match token&#39;s TTL
  options.expires_in = token.expires_in
  token
end
</code></pre>

<p><em>Andrii Gladkyi</em>, <em>Jean Boussier</em></p>
</li><li>
<p><code>default</code> option of <code>thread_mattr_accessor</code> now applies through inheritance and also across new threads.</p>

<p>Previously, the <code>default</code> value provided was set only at the moment of defining the attribute writer, which would cause the attribute to be uninitialized in descendants and in other threads.</p>

<p>Fixes #43312.</p>

<p><em>Thierry Deo</em></p>
</li><li>
<p>Redis cache store is now compatible with redis-rb 5.0.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Add <code>skip_nil:</code> support to <code>ActiveSupport::Cache::Store#fetch_multi</code>.</p>

<p><em>Daniel Alfaro</em></p>
</li><li>
<p>Add <code>quarter</code> method to date/time</p>

<p><em>Matt Swanson</em></p>
</li><li>
<p>Fix <code>NoMethodError</code> on custom <code>ActiveSupport::Deprecation</code> behavior.</p>

<p><code>ActiveSupport::Deprecation.behavior=</code> was supposed to accept any object that responds to <code>call</code>, but in fact its internal implementation assumed that this object could respond to <code>arity</code>, so it was restricted to only <code>Proc</code> objects.</p>

<p>This change removes this <code>arity</code> restriction of custom behaviors.</p>

<p><em>Ryo Nakamura</em></p>
</li><li>
<p>Support <code>:url_safe</code> option for <code>MessageEncryptor</code>.</p>

<p>The <code>MessageEncryptor</code> constructor now accepts a <code>:url_safe</code> option, similar to the <code>MessageVerifier</code> constructor. When enabled, this option ensures that messages use a URL-safe encoding.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Add <code>url_safe</code> option to <code>ActiveSupport::MessageVerifier</code> initializer</p>

<p><code>ActiveSupport::MessageVerifier.new</code> now takes optional <code>url_safe</code> argument. It can generate URL-safe strings by passing <code>url_safe: true</code>.</p>

<pre><code>verifier = ActiveSupport::MessageVerifier.new(url_safe: true)
message = verifier.generate(data) # =&gt; URL-safe string
</code></pre>

<p>This option is <code>false</code> by default to be backwards compatible.</p>

<p><em>Shouichi Kamiya</em></p>
</li><li>
<p>Enable connection pooling by default for <code>MemCacheStore</code> and <code>RedisCacheStore</code>.</p>

<p>If you want to disable connection pooling, set <code>:pool</code> option to <code>false</code> when configuring the cache store:</p>

<pre><code>config.cache_store = :mem_cache_store, &quot;cache.example.com&quot;, pool: false
</code></pre>

<p><em>fatkodima</em></p>
</li><li>
<p>Add <code>force:</code> support to <code>ActiveSupport::Cache::Store#fetch_multi</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Deprecated <code>:pool_size</code> and <code>:pool_timeout</code> options for configuring connection pooling in cache stores.</p>

<p>Use <code>pool: true</code> to enable pooling with default settings:</p>

<pre><code>config.cache_store = :redis_cache_store, pool: true
</code></pre>

<p>Or pass individual options via <code>:pool</code> option:</p>

<pre><code>config.cache_store = :redis_cache_store, pool: { size: 10, timeout: 2 }
</code></pre>

<p><em>fatkodima</em></p>
</li><li>
<p>Allow increment and decrement methods of <code>ActiveSupport::Cache::Store</code> subclasses to set new values.</p>

<p>Previously incrementing or decrementing an unset key would fail and return nil. A default will now be assumed and the key will be created.</p>

<p><em>Andrej Blagojević</em>, <em>Eugene Kenny</em></p>
</li><li>
<p>Add <code>skip_nil:</code> support to <code>RedisCacheStore</code></p>

<p><em>Joey Paris</em></p>
</li><li>
<p><code>ActiveSupport::Cache::MemoryStore#write(name, val, unless_exist:true)</code> now correctly writes expired keys.</p>

<p><em>Alan Savage</em></p>
</li><li>
<p><code>ActiveSupport::ErrorReporter</code> now accepts and forward a <code>source:</code> parameter.</p>

<p>This allow libraries to signal the origin of the errors, and reporters to easily ignore some sources.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix and add protections for XSS in <code>ActionView::Helpers</code> and <code>ERB::Util</code>.</p>

<p>Add the method <code>ERB::Util.xml_name_escape</code> to escape dangerous characters in names of tags and names of attributes, following the specification of XML.</p>

<p><em>Álvaro Martín Fraguas</em></p>
</li><li>
<p>Respect <code>ActiveSupport::Logger.new</code>'s <code>:formatter</code> keyword argument</p>

<p>The stdlib <code>Logger::new</code> allows passing a <code>:formatter</code> keyword argument to set the logger's formatter. Previously <code>ActiveSupport::Logger.new</code> ignored that argument by always setting the formatter to an instance of <code>ActiveSupport::Logger::SimpleFormatter</code>.</p>

<p><em>Steven Harman</em></p>
</li><li>
<p>Deprecate preserving the pre-Ruby 2.4 behavior of <code>to_time</code></p>

<p>With Ruby 2.4+ the default for <code>to_time</code> changed from converting to the local system time to preserving the offset of the receiver. At the time <a href="../../../classes/Rails.html"><code>Rails</code></a> supported older versions of Ruby so a compatibility layer was added to assist in the migration process. From <a href="../../../classes/Rails.html"><code>Rails</code></a> 5.0 new applications have defaulted to the Ruby 2.4+ behavior and since <a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0 now only supports Ruby 2.7+ this compatibility layer can be safely removed.</p>

<p>To minimize any noise generated the deprecation warning only appears when the setting is configured to <code>false</code> as that is the only scenario where the removal of the compatibility layer has any effect.</p>

<p><em>Andrew White</em></p>
</li><li>
<p><code>Pathname.blank?</code> only returns true for <code>Pathname.new(&quot;&quot;)</code></p>

<p>Previously it would end up calling <code>Pathname#empty?</code> which returned true if the path existed and was an empty directory or file.</p>

<p>That behavior was unlikely to be expected.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Deprecate <code>Notification::Event</code>'s <code>#children</code> and <code>#parent_of?</code></p>

<p><em>John Hawthorn</em></p>
</li><li>
<p>Change the default serializer of <code>ActiveSupport::MessageVerifier</code> from <code>Marshal</code> to <code>ActiveSupport::JSON</code> when using <code>config.load_defaults 7.1</code>.</p>

<p>Messages serialized with <code>Marshal</code> can still be read, but new messages will be serialized with <code>ActiveSupport::JSON</code>. For more information, see <a href="https://guides.rubyonrails.org/v7.1/configuring.html#config-active-support-message-serializer">guides.rubyonrails.org/v7.1/configuring.html#config-active-support-message-serializer</a>.</p>

<p><em>Saba Kiaei</em>, <em>David Buckley</em>, and <em>Jonathan Hefner</em></p>
</li><li>
<p>Change the default serializer of <code>ActiveSupport::MessageEncryptor</code> from <code>Marshal</code> to <code>ActiveSupport::JSON</code> when using <code>config.load_defaults 7.1</code>.</p>

<p>Messages serialized with <code>Marshal</code> can still be read, but new messages will be serialized with <code>ActiveSupport::JSON</code>. For more information, see <a href="https://guides.rubyonrails.org/v7.1/configuring.html#config-active-support-message-serializer">guides.rubyonrails.org/v7.1/configuring.html#config-active-support-message-serializer</a>.</p>

<p><em>Zack Deveau</em>, <em>Martin Gingras</em>, and <em>Jonathan Hefner</em></p>
</li><li>
<p>Add <code>ActiveSupport::TestCase#stub_const</code> to stub a constant for the duration of a yield.</p>

<p><em>DHH</em></p>
</li><li>
<p>Fix <code>ActiveSupport::EncryptedConfiguration</code> to be compatible with Psych 4</p>

<p><em>Stephen Sugden</em></p>
</li><li>
<p>Improve <code>File.atomic_write</code> error handling</p>

<p><em>Daniel Pepper</em></p>
</li><li>
<p>Fix <code>Class#descendants</code> and <code>DescendantsTracker#descendants</code> compatibility with Ruby 3.1.</p>

<p>{The native <code>Class#descendants</code> was reverted prior to Ruby 3.1 release}[https://bugs.ruby-lang.org/issues/14394#note-33], but <code>Class#subclasses</code> was kept, breaking the feature detection.</p>

<p><em>Jean Boussier</em></p>
</li></ul>

<p>Please check <a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/CHANGELOG.md">7-0-stable</a> for previous changes.</p>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
    
    
    
  
</div>

    </main>
  </body>
</html>
