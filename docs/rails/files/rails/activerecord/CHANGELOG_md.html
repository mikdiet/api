<!DOCTYPE html>
<html lang="en">
<head>
    <title>CHANGELOG.md</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='[]'>

</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            CHANGELOG.md
        </h2>
        <ul class="files">
            
            <li>
                rails/activerecord/CHANGELOG.md
                
                    <a href="https://github.com/rails/rails/blob/7b55c452b7d9a295d148ff882e0197cd139a9f8f/activerecord/CHANGELOG.md" target="_blank" class="github_url">on GitHub</a>
                
            </li>
            <li>Last modified: 2024-05-24 23:57:10 +0300</li>
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h2 id="label-Rails+7.0.8.3+-28May+17-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.8.3 (May 17, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.8.2+-28May+16-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.8.2 (May 16, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.8.1+-28February+21-2C+2024-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.8.1 (February 21, 2024)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.8+-28September+09-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.8 (September 09, 2023)</h2>
<ul><li>
<p>Fix <code>change_column</code> not setting <code>precision: 6</code> on <code>datetime</code> columns when using 7.0+ Migrations and SQLite.</p>

<p><em>Hartley McGuire</em></p>
</li><li>
<p>Fix unscope is not working in specific case</p>

<p>Before:</p>

<pre><code>Post.where(id: 1...3).unscope(where: :id).to_sql # &quot;SELECT `posts`.* FROM `posts` WHERE `posts`.`id` &gt;= 1 AND `posts`.`id` &lt; 3&quot;
</code></pre>

<p>After:</p>

<pre><code>Post.where(id: 1...3).unscope(where: :id).to_sql # &quot;SELECT `posts`.* FROM `posts`&quot;
</code></pre>

<p>Fixes #48094.</p>

<p><em>Kazuya Hatanaka</em></p>
</li><li>
<p>Fix associations to a STI model including a <code>class_name</code> parameter</p>

<pre><code>class Product &lt; ApplicationRecord
  has_many :requests, as: :requestable, class_name: &quot;ProductRequest&quot;, dependent: :destroy
end

# STI tables
class Request &lt; ApplicationRecord
  belongs_to :requestable, polymorphic: true

  validate :request_type, presence: true
end

class ProductRequest &lt; Request
  belongs_to :user
end
</code></pre>

<p>Accessing such association would lead to:</p>

<pre><code>table_metadata.rb:22:in `has_column?&#39;: undefined method `key?&#39; for nil:NilClass (NoMethodError)
</code></pre>

<p><em>Romain Filinto</em></p>
</li><li>
<p>Fix <code>change_table</code> setting datetime precision for 6.1 Migrations</p>

<p><em>Hartley McGuire</em></p>
</li><li>
<p>Fix change_column setting datetime precision for 6.1 Migrations</p>

<p><em>Hartley McGuire</em></p>
</li></ul>

<h2 id="label-Rails+7.0.7.2+-28August+22-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.7.2 (August 22, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.7.1+-28August+22-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.7.1 (August 22, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.7+-28August+09-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.7 (August 09, 2023)</h2>
<ul><li>
<p>Restores functionality to the missing method when using enums and fixes.</p>

<p><em>paulreece</em></p>
</li><li>
<p>Fix <code>StatementCache::Substitute</code> with serialized type.</p>

<p><em>ywenc</em></p>
</li><li>
<p>Fix <code>:db_runtime</code> on notification payload when application have multiple databases.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Correctly dump check constraints for MySQL 8.0.16+.</p>

<p><em>Steve Hill</em></p>
</li><li>
<p>Fix <code>ActiveRecord::QueryMethods#in_order_of</code> to include <code>nil</code>s, to match the behavior of <code>Enumerable#in_order_of</code>.</p>

<p>For example, <code>Post.in_order_of(:title, [nil, &quot;foo&quot;])</code> will now include posts with <code>nil</code> titles, the same as <code>Post.all.to_a.in_order_of(:title, [nil, &quot;foo&quot;])</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Revert "Fix autosave associations with validations added on <code>:base</code> of the associated objects."</p>

<p>This change intended to remove the :base attribute from the message, but broke many assumptions which key these errors were stored.</p>

<p><em>zzak</em></p>
</li><li>
<p>Fix <code>#previously_new_record?</code> to return true for destroyed records.</p>

<p>Before, if a record was created and then destroyed, <code>#previously_new_record?</code> would return true. Now, any UPDATE or DELETE to a record is considered a change, and will result in <code>#previously_new_record?</code> returning false.</p>

<p><em>Adrianna Chang</em></p>
</li><li>
<p>Revert breaking changes to <code>has_one</code> relationship deleting the old record before the new one is validated.</p>

<p><em>zzak</em></p>
</li><li>
<p>Fix support for Active Record instances being uses in queries.</p>

<p>As of <code>7.0.5</code>, query arguments were deep duped to avoid mutations impacting the query cache, but this had the adverse effect to clearing the primary key when the query argument contained an <code>ActiveRecord::Base</code> instance.</p>

<p>This broke the <code>noticed</code> gem.</p>

<p><em>Jean Boussier</em></p>
</li></ul>

<h2 id="label-Rails+7.0.6+-28June+29-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.6 (June 29, 2023)</h2>
<ul><li>
<p>Fix autosave associations with validations added on <code>:base</code> of the associated objects.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix result with anonymous PostgreSQL columns of different type from json.</p>

<p><em>Oleksandr Avoiants</em></p>
</li><li>
<p>Preserve timestamp when setting an <code>ActiveSupport::TimeWithZone</code> value to <code>timestamptz</code> attribute.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix assignment into an <code>has_one</code> relationship deleting the old record before the new one is validated.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix where on association with has_one/has_many polymorphic relations.</p>

<p>Before:</p>

<pre><code>Treasure.where(price_estimates: PriceEstimate.all)
#=&gt; SELECT (...) WHERE &quot;treasures&quot;.&quot;id&quot; IN (SELECT &quot;price_estimates&quot;.&quot;estimate_of_id&quot; FROM &quot;price_estimates&quot;)
</code></pre>

<p>Later:</p>

<pre><code>Treasure.where(price_estimates: PriceEstimate.all)
#=&gt; SELECT (...) WHERE &quot;treasures&quot;.&quot;id&quot; IN (SELECT &quot;price_estimates&quot;.&quot;estimate_of_id&quot; FROM &quot;price_estimates&quot; WHERE &quot;price_estimates&quot;.&quot;estimate_of_type&quot; = &#39;Treasure&#39;)
</code></pre>

<p><em>Lázaro Nixon</em></p>
</li><li>
<p>Fix decrementing counter caches on optimistically locked record deletion</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Ensure binary-destined values have binary encoding during type cast.</p>

<p><em>Matthew Draper</em></p>
</li><li>
<p>Preserve existing column default functions when altering table in SQLite.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Remove table alias added when using <code>where.missing</code> or <code>where.associated</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix <code>Enumerable#in_order_of</code> to only flatten first level to preserve nesting.</p>

<p><em>Miha Rekar</em></p>
</li></ul>

<h2 id="label-Rails+7.0.5.1+-28June+26-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.5.1 (June 26, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.5+-28May+24-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.5 (May 24, 2023)</h2>
<ul><li>
<p>Type cast <code>#attribute_changed?</code> <code>:from</code> and <code>:to</code> options.</p>

<p><em>Andrew Novoselac</em></p>
</li><li>
<p>Fix <code>index_exists?</code> when column is an array.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Handle <code>Date</code> objects for PostgreSQL <code>timestamptz</code> columns.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Fix collation for changing column to non-string.</p>

<p><em>Hartley McGuire</em></p>
</li><li>
<p>Map through subtype in <code>PostgreSQL::OID::Array</code>.</p>

<p><em>Jonathan Hefner</em></p>
</li><li>
<p>Store correct environment in <code>internal_metadata</code> when run rails <code>db:prepare</code>.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Make sure <code>ActiveRecord::Relation#sum</code> works with objects that implement <code>#coerce</code> without deprecation.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Fix retrieving foreign keys referencing tables named like keywords in PostgreSQL and MySQL.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Support UUIDs in Disable Joins.</p>

<p><em>Samuel Cochran</em></p>
</li><li>
<p>Fix Active Record's explain for queries starting with comments.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix incorrectly preloading through association records when middle association has been loaded.</p>

<p><em>Joshua Young</em></p>
</li><li>
<p>Fix where.missing and where.associated for parent/child associations.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix <a href="../../../classes/Enumerable.html#method-i-in_order_of"><code>Enumerable#in_order_of</code></a> to preserve duplicates.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix autoincrement on primary key for mysql.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Restore ability to redefine column in <code>create_table</code> for <a href="../../../classes/Rails.html"><code>Rails</code></a> 5.2 migrations.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix schema cache dumping of virtual columns.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix Active Record grouped calculations on joined tables on column present in both tables.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix mutation detection for serialized attributes backed by binary columns.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix a bug where using groups and counts with long table names would return incorrect results.</p>

<p><em>Shota Toguchi</em>, <em>Yusaku Ono</em></p>
</li><li>
<p>Fix erroneous nil default precision on virtual datetime columns.</p>

<p>Prior to this change, virtual datetime columns did not have the same default precision as regular datetime columns, resulting in the following being erroneously equivalent:</p>

<pre><code>t.virtual :name, type: datetime,                 as: &quot;expression&quot;
t.virtual :name, type: datetime, precision: nil, as: &quot;expression&quot;
</code></pre>

<p>This change fixes the default precision lookup, so virtual and regular datetime column default precisions match.</p>

<p><em>Sam Bostock</em></p>
</li><li>
<p>Fix a case where the query cache can return wrong values. See #46044</p>

<p><em>Aaron Patterson</em></p>
</li></ul>

<h2 id="label-Rails+7.0.4.3+-28March+13-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.4.3 (March 13, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.4.2+-28January+24-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.4.2 (January 24, 2023)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.4.1+-28January+17-2C+2023-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.4.1 (January 17, 2023)</h2>
<ul><li>
<p>Make sanitize_as_sql_comment more strict</p>

<p>Though this method was likely never meant to take user input, it was attempting sanitization. That sanitization could be bypassed with carefully crafted input.</p>

<p>This commit makes the sanitization more robust by replacing any occurrences of "/<em>" or "</em>/" with "/ <em>" or "</em> /". It also performs a first pass to remove one surrounding comment to avoid compatibility issues for users relying on the existing removal.</p>

<p>This also clarifies in the documentation of annotate that it should not be provided user input.</p>

<p>[CVE-2023-22794]</p>
</li><li>
<p>Added integer width check to PostgreSQL::Quoting</p>

<p>Given a value outside the range for a 64bit signed integer type PostgreSQL will treat the column type as numeric. Comparing integer values against numeric values can result in a slow sequential scan.</p>

<p>This behavior is configurable via ActiveRecord::Base.raise_int_wider_than_64bit which defaults to true.</p>

<p>[CVE-2022-44566]</p>
</li></ul>

<h2 id="label-Rails+7.0.4+-28September+09-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.4 (September 09, 2022)</h2>
<ul><li>
<p><a href="../../../classes/Symbol.html"><code>Symbol</code></a> is allowed by default for YAML columns</p>

<p><em>Étienne Barrié</em></p>
</li><li>
<p>Fix <code>ActiveRecord::Store</code> to serialize as a regular <a href="../../../classes/Hash.html"><code>Hash</code></a></p>

<p>Previously it would serialize as an <code>ActiveSupport::HashWithIndifferentAccess</code> which is wasteful and cause problem with YAML safe_load.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Add <code>timestamptz</code> as a time zone aware type for PostgreSQL</p>

<p>This is required for correctly parsing <code>timestamp with time zone</code> values in your database.</p>

<p>If you don't want this, you can opt out by adding this initializer:</p>

<pre><code>ActiveRecord::Base.time_zone_aware_types -= [:timestamptz]
</code></pre>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Fix supporting timezone awareness for <code>tsrange</code> and <code>tstzrange</code> array columns.</p>

<pre><code># In database migrations
add_column :shops, :open_hours, :tsrange, array: true
# In app config
ActiveRecord::Base.time_zone_aware_types += [:tsrange]
# In the code times are properly converted to app time zone
Shop.create!(open_hours: [Time.current..8.hour.from_now])
</code></pre>

<p><em>Wojciech Wnętrzak</em></p>
</li><li>
<p>Resolve issue where a relation cache_version could be left stale.</p>

<p>Previously, when <code>reset</code> was called on a relation object it did not reset the cache_versions ivar. This led to a confusing situation where despite having the correct data the relation still reported a stale cache_version.</p>

<p>Usage:</p>

<pre><code>developers = Developer.all
developers.cache_version

Developer.update_all(updated_at: Time.now.utc + 1.second)

developers.cache_version # Stale cache_version
developers.reset
developers.cache_version # Returns the current correct cache_version
</code></pre>

<p>Fixes #45341.</p>

<p><em>Austen Madden</em></p>
</li><li>
<p>Fix <code>load_async</code> when called on an association proxy.</p>

<p>Calling <code>load_async</code> directly an association would schedule a query but never use it.</p>

<pre><code>comments = post.comments.load_async # schedule a query
comments.to_a # perform an entirely new sync query
</code></pre>

<p>Now it does use the async query, however note that it doesn't cause the association to be loaded.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix eager loading for models without primary keys.</p>

<p><em>Anmol Chopra</em>, <em>Matt Lawrence</em>, and <em>Jonathan Hefner</em></p>
</li><li>
<p><code>rails db:schema:{dump,load}</code> now checks <code>ENV[&quot;SCHEMA_FORMAT&quot;]</code> before config</p>

<p>Since <code>rails db:structure:{dump,load}</code> was deprecated there wasn't a simple way to dump a schema to both SQL and Ruby formats. You can now do this with an environment variable. For example:</p>

<pre><code>SCHEMA_FORMAT=sql rake db:schema:dump
</code></pre>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Fix Hstore deserialize regression.</p>

<p><em>edsharp</em></p>
</li></ul>

<h2 id="label-Rails+7.0.3.1+-28July+12-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.3.1 (July 12, 2022)</h2>
<ul><li>
<p>Change ActiveRecord::Coders::YAMLColumn default to safe_load</p>

<p>This adds two new configuration options The configuration options are as follows:</p>
<ul><li>
<p><code>config.active_record.use_yaml_unsafe_load</code></p>
</li></ul>

<p>When set to true, this configuration option tells <a href="../../../classes/Rails.html"><code>Rails</code></a> to use the old "unsafe" YAML loading strategy, maintaining the existing behavior but leaving the possible escalation vulnerability in place. Setting this option to true is <em>not</em> recommended, but can aid in upgrading.</p>
<ul><li>
<p><code>config.active_record.yaml_column_permitted_classes</code></p>
</li></ul>

<p>The "safe YAML" loading method does not allow all classes to be deserialized by default. This option allows you to specify classes deemed "safe" in your application. For example, if your application uses <a href="../../../classes/Symbol.html"><code>Symbol</code></a> and <a href="../../../classes/Time.html"><code>Time</code></a> in serialized data, you can add <a href="../../../classes/Symbol.html"><code>Symbol</code></a> and <a href="../../../classes/Time.html"><code>Time</code></a> to the allowed list as follows:</p>

<pre><code>config.active_record.yaml_column_permitted_classes = [Symbol, Date, Time]
</code></pre>

<p>[CVE-2022-32224]</p>
</li></ul>

<h2 id="label-Rails+7.0.3+-28May+09-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.3 (May 09, 2022)</h2>
<ul><li>
<p>Some internal housekeeping on reloads could break custom <code>respond_to?</code> methods in class objects that referenced reloadable constants. See <a href="https://github.com/rails/rails/issues/44125">#44125</a> for details.</p>

<p><em>Xavier Noria</em></p>
</li><li>
<p>Fixed MariaDB default function support.</p>

<p>Defaults would be written wrong in "db/schema.rb" and not work correctly if using <code>db:schema:load</code>. Further more the function name would be added as string content when saving new records.</p>

<p><em>kaspernj</em></p>
</li><li>
<p>Fix <code>remove_foreign_key</code> with <code>:if_exists</code> option when foreign key actually exists.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Remove <code>--no-comments</code> flag in structure dumps for PostgreSQL</p>

<p>This broke some apps that used custom schema comments. If you don't want comments in your structure dump, you can use:</p>

<pre><code>ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = [&#39;--no-comments&#39;]
</code></pre>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Use the model name as a prefix when filtering encrypted attributes from logs.</p>

<p>For example, when encrypting <code>Person#name</code> it will add <code>person.name</code> as a filter parameter, instead of just <code>name</code>. This prevents unintended filtering of parameters with a matching name in other models.</p>

<p><em>Jorge Manrubia</em></p>
</li><li>
<p>Fix quoting of <code>ActiveSupport::Duration</code> and <code>Rational</code> numbers in the MySQL adapter.</p>

<p><em>Kevin McPhillips</em></p>
</li><li>
<p>Fix <code>change_column_comment</code> to preserve column's AUTO_INCREMENT in the MySQL adapter</p>

<p><em>fatkodima</em></p>
</li></ul>

<h2 id="label-Rails+7.0.2.4+-28April+26-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.2.4 (April 26, 2022)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.2.3+-28March+08-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.2.3 (March 08, 2022)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.2.2+-28February+11-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.2.2 (February 11, 2022)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.2.1+-28February+11-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.2.1 (February 11, 2022)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.2+-28February+08-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.2 (February 08, 2022)</h2>
<ul><li>
<p>Fix <code>PG.connect</code> keyword arguments deprecation warning on ruby 2.7.</p>

<p><em>Nikita Vasilevsky</em></p>
</li><li>
<p>Fix the ability to exclude encryption params from being autofiltered.</p>

<p><em>Mark Gangl</em></p>
</li><li>
<p>Dump the precision for datetime columns following the new defaults.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Make sure encrypted attributes are not being filtered twice.</p>

<p><em>Nikita Vasilevsky</em></p>
</li><li>
<p>Dump the database schema containing the current <a href="../../../classes/Rails.html"><code>Rails</code></a> version.</p>

<p>Since <a href="https://github.com/rails/rails/pull/42297">github.com/rails/rails/pull/42297</a>, <a href="../../../classes/Rails.html"><code>Rails</code></a> now generate datetime columns with a default precision of 6. This means that users upgrading to <a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0 from 6.1, when loading the database schema, would get the new precision value, which would not match the production schema.</p>

<p>To avoid this the schema dumper will generate the new format which will include the <a href="../../../classes/Rails.html"><code>Rails</code></a> version and will look like this:</p>

<pre><code>ActiveRecord::Schema[7.0].define
</code></pre>

<p>When upgrading from <a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 to <a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0, you can run the <code>rails app:update</code> task that will set the current schema version to 6.1.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Fix parsing expression for PostgreSQL generated column.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix <code>Mysql2::Error: Commands out of sync; you can&#39;t run this command now</code> when bulk-inserting fixtures that exceed <code>max_allowed_packet</code> configuration.</p>

<p><em>Nikita Vasilevsky</em></p>
</li><li>
<p>Fix error when saving an association with a relation named <code>record</code>.</p>

<p><em>Dorian Marié</em></p>
</li><li>
<p>Fix <code>MySQL::SchemaDumper</code> behavior about datetime precision value.</p>

<p><em>y0t4</em></p>
</li><li>
<p>Improve associated with no reflection error.</p>

<p><em>Nikolai</em></p>
</li><li>
<p>Fix PG.connect keyword arguments deprecation warning on ruby 2.7.</p>

<p>Fixes #44307.</p>

<p><em>Nikita Vasilevsky</em></p>
</li><li>
<p>Fix passing options to <code>check_constraint</code> from <code>change_table</code>.</p>

<p><em>Frederick Cheung</em></p>
</li></ul>

<h2 id="label-Rails+7.0.1+-28January+06-2C+2022-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.1 (January 06, 2022)</h2>
<ul><li>
<p>Change <code>QueryMethods#in_order_of</code> to drop records not listed in values.</p>

<p><code>in_order_of</code> now filters down to the values provided, to match the behavior of the <code>Enumerable</code> version.</p>

<p><em>Kevin Newton</em></p>
</li><li>
<p>Allow named expression indexes to be revertible.</p>

<p>Previously, the following code would raise an error in a reversible migration executed while rolling back, due to the index name not being used in the index removal.</p>

<pre><code>add_index(:settings, &quot;(data-&gt;&#39;property&#39;)&quot;, using: :gin, name: :index_settings_data_property)
</code></pre>

<p>Fixes #43331.</p>

<p><em>Oliver Günther</em></p>
</li><li>
<p>Better error messages when association name is invalid in the argument of <code>ActiveRecord::QueryMethods::WhereChain#missing</code>.</p>

<p><em>ykpythemind</em></p>
</li><li>
<p>Fix ordered migrations for single db in multi db environment.</p>

<p><em>Himanshu</em></p>
</li><li>
<p>Extract <code>on update CURRENT_TIMESTAMP</code> for mysql2 adapter.</p>

<p><em>Kazuhiro Masuda</em></p>
</li><li>
<p>Fix incorrect argument in PostgreSQL structure dump tasks.</p>

<p>Updating the <code>--no-comment</code> argument added in <a href="../../../classes/Rails.html"><code>Rails</code></a> 7 to the correct <code>--no-comments</code> argument.</p>

<p><em>Alex Dent</em></p>
</li><li>
<p>Fix schema dumping column default SQL values for sqlite3.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Correctly parse complex check constraint expressions for PostgreSQL.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Fix <code>timestamptz</code> attributes on PostgreSQL handle blank inputs.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Fix migration compatibility to create SQLite references/belongs_to column as integer when migration version is 6.0.</p>

<p>Reference/belongs_to in migrations with version 6.0 were creating columns as bigint instead of integer for the SQLite Adapter.</p>

<p><em>Marcelo Lauxen</em></p>
</li><li>
<p>Fix joining through a polymorphic association.</p>

<p><em>Alexandre Ruban</em></p>
</li><li>
<p>Fix <code>QueryMethods#in_order_of</code> to handle empty order list.</p>

<pre><code>Post.in_order_of(:id, []).to_a
</code></pre>

<p>Also more explicitly set the column as secondary order, so that any other value is still ordered.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix <code>rails dbconsole</code> for 3-tier config.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Fix quoting of column aliases generated by calculation methods.</p>

<p>Since the alias is derived from the table name, we can't assume the result is a valid identifier.</p>

<pre><code>class Test &lt; ActiveRecord::Base
  self.table_name = &#39;1abc&#39;
end
Test.group(:id).count
# syntax error at or near &quot;1&quot; (ActiveRecord::StatementInvalid)
# LINE 1: SELECT COUNT(*) AS count_all, &quot;1abc&quot;.&quot;id&quot; AS 1abc_id FROM &quot;1...
</code></pre>

<p><em>Jean Boussier</em></p>
</li></ul>

<h2 id="label-Rails+7.0.0+-28December+15-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0 (December 15, 2021)</h2>
<ul><li>
<p>Better handle SQL queries with invalid encoding.</p>

<pre><code>Post.create(name: &quot;broken \xC8 UTF-8&quot;)
</code></pre>

<p>Would cause all adapters to fail in a non controlled way in the code responsible to detect write queries.</p>

<p>The query is now properly passed to the database connection, which might or might not be able to handle it, but will either succeed or failed in a more correct way.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Move database and shard selection config options to a generator.</p>

<p>Rather than generating the config options in <code>production.rb</code> when applications are created, applications can now run a generator to create an initializer and uncomment / update options as needed. All multi-db configuration can be implemented in this initializer.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li></ul>

<h2 id="label-Rails+7.0.0.rc3+-28December+14-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0.rc3 (December 14, 2021)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.0.rc2+-28December+14-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0.rc2 (December 14, 2021)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.0.rc1+-28December+06-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0.rc1 (December 06, 2021)</h2>
<ul><li>
<p>Remove deprecated <code>ActiveRecord::DatabaseConfigurations::DatabaseConfig#spec_name</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Connection#in_clause_length</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Connection#allowed_index_name_length</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base#remove_connection</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Load STI Models in fixtures</p>

<p>Data from Fixtures now loads based on the specific class for models with Single Table Inheritance. This affects enums defined in subclasses, previously the value of these fields was not parsed and remained <code>nil</code></p>

<p><em>Andres Howard</em></p>
</li><li>
<p><code>#authenticate</code> returns false when the password is blank instead of raising an error.</p>

<p><em>Muhammad Muhammad Ibrahim</em></p>
</li><li>
<p>Fix <code>ActiveRecord::QueryMethods#in_order_of</code> behavior for integer enums.</p>

<p><code>ActiveRecord::QueryMethods#in_order_of</code> didn’t work as expected for enums stored as integers in the database when passing an array of strings or symbols as the order argument. This unexpected behavior occurred because the string or symbol values were not casted to match the integers in the database.</p>

<p>The following example now works as expected:</p>

<pre><code>class Book &lt; ApplicationRecord
  enum status: [:proposed, :written, :published]
end

Book.in_order_of(:status, %w[written published proposed])
</code></pre>

<p><em>Alexandre Ruban</em></p>
</li><li>
<p>Ignore persisted in-memory records when merging target lists.</p>

<p><em>Kevin Sjöberg</em></p>
</li><li>
<p>Add a new option <code>:update_only</code> to <code>upsert_all</code> to configure the list of columns to update in case of conflict.</p>

<p>Before, you could only customize the update SQL sentence via <code>:on_duplicate</code>. There is now a new option <code>:update_only</code> that lets you provide a list of columns to update in case of conflict:</p>

<pre><code>Commodity.upsert_all(
  [
    { id: 2, name: &quot;Copper&quot;, price: 4.84 },
    { id: 4, name: &quot;Gold&quot;, price: 1380.87 },
    { id: 6, name: &quot;Aluminium&quot;, price: 0.35 }
  ],
  update_only: [:price] # Only prices will be updated
)
</code></pre>

<p><em>Jorge Manrubia</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Result#map!</code> and <code>ActiveRecord::Result#collect!</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base.configurations.to_h</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base.configurations.default_hash</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base.arel_attribute</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base.connection_config</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Filter attributes in SQL logs</p>

<p>Previously, SQL queries in logs containing <code>ActiveRecord::Base.filter_attributes</code> were not filtered.</p>

<p>Now, the filter attributes will be masked <code>[FILTERED]</code> in the logs when <code>prepared_statement</code> is enabled.</p>

<pre><code># Before:
  Foo Load (0.2ms)  SELECT &quot;foos&quot;.* FROM &quot;foos&quot; WHERE &quot;foos&quot;.&quot;passw&quot; = ? LIMIT ?  [[&quot;passw&quot;, &quot;hello&quot;], [&quot;LIMIT&quot;, 1]]

# After:
  Foo Load (0.5ms)  SELECT &quot;foos&quot;.* FROM &quot;foos&quot; WHERE &quot;foos&quot;.&quot;passw&quot; = ? LIMIT ?  [[&quot;passw&quot;, &quot;[FILTERED]&quot;], [&quot;LIMIT&quot;, 1]]
</code></pre>

<p><em>Aishwarya Subramanian</em></p>
</li><li>
<p>Remove deprecated <code>Tasks::DatabaseTasks.spec</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>Tasks::DatabaseTasks.current_config</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Deprecate <code>Tasks::DatabaseTasks.schema_file_type</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>Tasks::DatabaseTasks.dump_filename</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>Tasks::DatabaseTasks.schema_file</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>environment</code> and <code>name</code> arguments from <code>Tasks::DatabaseTasks.schema_up_to_date?</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Merging conditions on the same column no longer maintain both conditions, and will be consistently replaced by the latter condition.</p>

<p>“‘ruby</p>

<h1 id="label-Rails+6.1+-28IN+clause+is+replaced+by+merger+side+equality+condition-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 (IN clause is replaced by merger side equality condition)</h1>

<p>Author.where(id: [david.id, mary.id]).merge(Author.where(id: bob)) # =&gt; [bob]</p>

<h1 id="label-Rails+6.1+-28both+conflict+conditions+exists-2C+deprecated-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 (both conflict conditions exists, deprecated)</h1>

<p>Author.where(id: david.id..mary.id).merge(Author.where(id: bob)) # =&gt; []</p>

<h1 id="label-Rails+6.1+with+rewhere+to+migrate+to+Rails+7.0-27s+behavior"><a href="../../../classes/Rails.html"><code>Rails</code></a> 6.1 with rewhere to migrate to <a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0’s behavior</h1>

<p>Author.where(id: david.id..mary.id).merge(Author.where(id: bob), rewhere: true) # =&gt; [bob]</p>

<h1 id="label-Rails+7.0+-28same+behavior+with+IN+clause-2C+mergee+side+condition+is+consistently+replaced-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0 (same behavior with IN clause, mergee side condition is consistently replaced)</h1>

<p>Author.where(id: [david.id, mary.id]).merge(Author.where(id: bob)) # =&gt; [bob] Author.where(id: david.id..mary.id).merge(Author.where(id: bob)) # =&gt; [bob]</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated support to <code>Model.reorder(nil).first</code> to search using non-deterministic order.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated rake tasks:</p>
<ul><li>
<p><code>db:schema:load_if_ruby</code></p>
</li><li>
<p><code>db:structure:dump</code></p>
</li><li>
<p><code>db:structure:load</code></p>
</li><li>
<p><code>db:structure:load_if_sql</code></p>
</li><li>
<p><code>db:structure:dump:#{name}</code></p>
</li><li>
<p><code>db:structure:load:#{name}</code></p>
</li><li>
<p><code>db:test:load_structure</code></p>
</li><li>
<p><code>db:test:load_structure:#{name}</code></p>
</li></ul>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>DatabaseConfig#config</code> method.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Rollback transactions when the block returns earlier than expected.</p>

<p>Before this change, when a transaction block returned early, the transaction would be committed.</p>

<p>The problem is that timeouts triggered inside the transaction block was also making the incomplete transaction to be committed, so in order to avoid this mistake, the transaction block is rolled back.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Add middleware for automatic shard swapping.</p>

<p>Provides a basic middleware to perform automatic shard swapping. Applications will provide a resolver which will determine for an individual request which shard should be used. Example:</p>

<pre><code>config.active_record.shard_resolver = -&gt;(request) {
  subdomain = request.subdomain
  tenant = Tenant.find_by_subdomain!(subdomain)
  tenant.shard
}
</code></pre>

<p>See guides for more details.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p>
</li><li>
<p>Remove deprecated support to pass a column to <code>type_cast</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated support to type cast to database values <code>ActiveRecord::Base</code> objects.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated support to quote <code>ActiveRecord::Base</code> objects.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecacated support to resolve connection using <code>&quot;primary&quot;</code> as connection specification name.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecation warning when using <code>:interval</code> column is used in PostgreSQL database.</p>

<p>Now, interval columns will return <code>ActiveSupport::Duration</code> objects instead of strings.</p>

<p>To keep the old behavior, you can add this line to your model:</p>

<pre><code>attribute :column, :string
</code></pre>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated support to YAML load <code>ActiveRecord::Base</code> instance in the <a href="../../../classes/Rails.html"><code>Rails</code></a> 4.2 and 4.1 formats.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated option <code>:spec_name</code> in the <code>configs_for</code> method.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Remove deprecated <code>ActiveRecord::Base.allow_unsafe_raw_sql</code>.</p>

<p><em>Rafael Mendonça França</em></p>
</li><li>
<p>Fix regression bug that caused ignoring additional conditions for preloading has_many-through relations.</p>

<p>Fixes #43132</p>

<p><em>Alexander Pauly</em></p>
</li><li>
<p>Fix <code>has_many</code> inversing recursion on models with recursive associations.</p>

<p><em>Gannon McGibbon</em></p>
</li><li>
<p>Add <code>accepts_nested_attributes_for</code> support for <code>delegated_type</code></p>

<pre><code>class Entry &lt; ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ]
  accepts_nested_attributes_for :entryable
end

entry = Entry.create(entryable_type: &#39;Message&#39;, entryable_attributes: { content: &#39;Hello world&#39; })
# =&gt; #&lt;Entry:0x00&gt;
# id: 1
# entryable_id: 1,
# entryable_type: &#39;Message&#39;
# ...&gt;

entry.entryable
# =&gt; #&lt;Message:0x01&gt;
# id: 1
# content: &#39;Hello world&#39;
# ...&gt;
</code></pre>

<p>Previously it would raise an error:</p>

<pre><code>Entry.create(entryable_type: &#39;Message&#39;, entryable_attributes: { content: &#39;Hello world&#39; })
# ArgumentError: Cannot build association `entryable&#39;. Are you trying to build a polymorphic one-to-one association?
</code></pre>

<p><em>Sjors Baltus</em></p>
</li><li>
<p>Use subquery for DELETE with GROUP_BY and HAVING clauses.</p>

<p>Prior to this change, deletes with GROUP_BY and HAVING were returning an error.</p>

<p>After this change, GROUP_BY and HAVING are valid clauses in DELETE queries, generating the following query:</p>

<pre><code>DELETE FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; IN (
    SELECT &quot;posts&quot;.&quot;id&quot; FROM &quot;posts&quot; INNER JOIN &quot;comments&quot; ON &quot;comments&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot; GROUP BY &quot;posts&quot;.&quot;id&quot; HAVING (count(comments.id) &gt;= 2))
)  [[&quot;flagged&quot;, &quot;t&quot;]]
</code></pre>

<p><em>Ignacio Chiazzo Cardarello</em></p>
</li><li>
<p>Use subquery for UPDATE with GROUP_BY and HAVING clauses.</p>

<p>Prior to this change, updates with GROUP_BY and HAVING were being ignored, generating a SQL like this:</p>

<pre><code>UPDATE &quot;posts&quot; SET &quot;flagged&quot; = ? WHERE &quot;posts&quot;.&quot;id&quot; IN (
    SELECT &quot;posts&quot;.&quot;id&quot; FROM &quot;posts&quot; INNER JOIN &quot;comments&quot; ON &quot;comments&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot;
)  [[&quot;flagged&quot;, &quot;t&quot;]]
</code></pre>

<p>After this change, GROUP_BY and HAVING clauses are used as a subquery in updates, like this:</p>

<pre><code>UPDATE &quot;posts&quot; SET &quot;flagged&quot; = ? WHERE &quot;posts&quot;.&quot;id&quot; IN (
    SELECT &quot;posts&quot;.&quot;id&quot; FROM &quot;posts&quot; INNER JOIN &quot;comments&quot; ON &quot;comments&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot;
    GROUP BY posts.id HAVING (count(comments.id) &gt;= 2)
)  [[&quot;flagged&quot;, &quot;t&quot;]]
</code></pre>

<p><em>Ignacio Chiazzo Cardarello</em></p>
</li><li>
<p>Add support for setting the filename of the schema or structure dump in the database config.</p>

<p>Applications may now set their the filename or path of the schema / structure dump file in their database configuration.</p>

<pre><code>production:
  primary:
    database: my_db
    schema_dump: my_schema_dump_filename.rb
  animals:
    database: animals_db
    schema_dump: false
</code></pre>

<p>The filename set in <code>schema_dump</code> will be used by the application. If set to <code>false</code> the schema will not be dumped. The database tasks are responsible for adding the database directory to the filename. If a full path is provided, the <a href="../../../classes/Rails.html"><code>Rails</code></a> tasks will use that instead of <code>ActiveRecord::DatabaseTasks.db_dir</code>.</p>

<p><em>Eileen M. Uchitelle</em>, <em>Ryan Kerr</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base.prohibit_shard_swapping</code> to prevent attempts to change the shard within a block.</p>

<p><em>John Crepezzi</em>, <em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Filter unchanged attributes with default function from insert query when <code>partial_inserts</code> is disabled.</p>

<p><em>Akshay Birajdar</em>, <em>Jacopo Beschi</em></p>
</li><li>
<p>Add support for FILTER clause (SQL:2003) to <a href="../../../classes/Arel.html"><code>Arel</code></a>.</p>

<p>Currently supported by PostgreSQL 9.4+ and SQLite 3.30+.</p>

<p><em>Andrey Novikov</em></p>
</li><li>
<p>Automatically set timestamps on record creation during bulk insert/upsert</p>

<p>Prior to this change, only updates during an upsert operation (e.g. <code>upsert_all</code>) would touch timestamps (<code>updated_{at,on}</code>). Now, record creations also touch timestamp columns (<code>{created,updated}_{at,on}</code>).</p>

<p>This behaviour is controlled by the <code>&lt;model&gt;.record_timestamps</code> config, matching the behaviour of <code>create</code>, <code>update</code>, etc. It can also be overridden by using the <code>record_timestamps:</code> keyword argument.</p>

<p>Note that this means <code>upsert_all</code> on models with <code>record_timestamps = false</code> will no longer touch <code>updated_{at,on}</code> automatically.</p>

<p><em>Sam Bostock</em></p>
</li><li>
<p>Don't require <code>role</code> when passing <code>shard</code> to <code>connected_to</code>.</p>

<p><code>connected_to</code> can now be called with a <code>shard</code> only. Note that <code>role</code> is still inherited if <code>connected_to</code> calls are nested.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Add option to lazily load the schema cache on the connection.</p>

<p>Previously, the only way to load the schema cache in Active Record was through the Railtie on boot. This option provides the ability to load the schema cache on the connection after it's been established. Loading the cache lazily on the connection can be beneficial for <a href="../../../classes/Rails.html"><code>Rails</code></a> applications that use multiple databases because it will load the cache at the time the connection is established. Currently Railties doesn't have access to the connections before boot.</p>

<p>To use the cache, set <code>config.active_record.lazily_load_schema_cache = true</code> in your application configuration. In addition a <code>schema_cache_path</code> should be set in your database configuration if you don’t want to use the default “db/schema_cache.yml” path.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Allow automatic <code>inverse_of</code> detection for associations with scopes.</p>

<p>Automatic <code>inverse_of</code> detection now works for associations with scopes. For example, the <code>comments</code> association here now automatically detects <code>inverse_of: :post</code>, so we don't need to pass that option:</p>

<pre><code>class Post &lt; ActiveRecord::Base
  has_many :comments, -&gt; { visible }
end

class Comment &lt; ActiveRecord::Base
  belongs_to :post
end
</code></pre>

<p>Note that the automatic detection still won't work if the inverse association has a scope. In this example a scope on the <code>post</code> association would still prevent <a href="../../../classes/Rails.html"><code>Rails</code></a> from finding the inverse for the <code>comments</code> association.</p>

<p>This will be the default for new apps in <a href="../../../classes/Rails.html"><code>Rails</code></a> 7. To opt in:</p>

<pre><code>config.active_record.automatic_scope_inversing = true
</code></pre>

<p><em>Daniel Colson</em>, <em>Chris Bloom</em></p>
</li><li>
<p>Accept optional transaction args to <code>ActiveRecord::Locking::Pessimistic#with_lock</code></p>

<p><code>#with_lock</code> now accepts transaction options like <code>requires_new:</code>, <code>isolation:</code>, and <code>joinable:</code></p>

<p><em>John Mileham</em></p>
</li><li>
<p>Adds support for deferrable foreign key constraints in PostgreSQL.</p>

<p>By default, foreign key constraints in PostgreSQL are checked after each statement. This works for most use cases, but becomes a major limitation when creating related records before the parent record is inserted into the database. One example of this is looking up / creating a person via one or more unique alias.</p>

<pre><code>Person.transaction do
  alias = Alias
    .create_with(user_id: SecureRandom.uuid)
    .create_or_find_by(name: &quot;DHH&quot;)

  person = Person
    .create_with(name: &quot;David Heinemeier Hansson&quot;)
    .create_or_find_by(id: alias.user_id)
end
</code></pre>

<p>Using the default behavior, the transaction would fail when executing the first <code>INSERT</code> statement.</p>

<p>By passing the <code>:deferrable</code> option to the <code>add_foreign_key</code> statement in migrations, it's possible to defer this check.</p>

<pre><code>add_foreign_key :aliases, :person, deferrable: true
</code></pre>

<p>Passing <code>deferrable: true</code> doesn't change the default behavior, but allows manually deferring the check using <code>SET CONSTRAINTS ALL DEFERRED</code> within a transaction. This will cause the foreign keys to be checked after the transaction.</p>

<p>It's also possible to adjust the default behavior from an immediate check (after the statement), to a deferred check (after the transaction):</p>

<pre><code>add_foreign_key :aliases, :person, deferrable: :deferred
</code></pre>

<p><em>Benedikt Deicke</em></p>
</li><li>
<p>Allow configuring Postgres password through the socket URL.</p>

<p>For example:</p>

<pre><code>ActiveRecord::DatabaseConfigurations::UrlConfig.new(
  :production, :production, &#39;postgres:///?user=user&amp;password=secret&amp;dbname=app&#39;, {}
).configuration_hash
</code></pre>

<p>will now return,</p>

<pre><code>{ :user=&gt;&quot;user&quot;, :password=&gt;&quot;secret&quot;, :dbname=&gt;&quot;app&quot;, :adapter=&gt;&quot;postgresql&quot; }
</code></pre>

<p><em>Abeid Ahmed</em></p>
</li><li>
<p>PostgreSQL: support custom enum types</p>

<p>In migrations, use <code>create_enum</code> to add a new enum type, and <code>t.enum</code> to add a column.</p>

<pre><code>def up
  create_enum :mood, [&quot;happy&quot;, &quot;sad&quot;]

  change_table :cats do |t|
    t.enum :current_mood, enum_type: &quot;mood&quot;, default: &quot;happy&quot;, null: false
  end
end
</code></pre>

<p>Enums will be presented correctly in <code>schema.rb</code>. Note that this is only supported by the PostgreSQL adapter.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Avoid COMMENT statements in PostgreSQL structure dumps</p>

<p>COMMENT statements are now omitted from the output of <code>db:structure:dump</code> when using PostgreSQL &gt;= 11. This allows loading the dump without a pgsql superuser account.</p>

<p>Fixes #36816, #43107.</p>

<p><em>Janosch Müller</em></p>
</li><li>
<p>Add support for generated columns in PostgreSQL adapter</p>

<p>Generated columns are supported since version 12.0 of PostgreSQL. This adds support of those to the PostgreSQL adapter.</p>

<pre><code>create_table :users do |t|
  t.string :name
  t.virtual :name_upcased, type: :string, as: &#39;upper(name)&#39;, stored: true
end
</code></pre>

<p><em>Michał Begejowicz</em></p>
</li></ul>

<h2 id="label-Rails+7.0.0.alpha2+-28September+15-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0.alpha2 (September 15, 2021)</h2>
<ul><li>
<p>No changes.</p>
</li></ul>

<h2 id="label-Rails+7.0.0.alpha1+-28September+15-2C+2021-29"><a href="../../../classes/Rails.html"><code>Rails</code></a> 7.0.0.alpha1 (September 15, 2021)</h2>
<ul><li>
<p>Remove warning when overwriting existing scopes</p>

<p>Removes the following unnecessary warning message that appeared when overwriting existing scopes</p>

<pre><code>Creating scope :my_scope_name. Overwriting existing method &quot;MyClass.my_scope_name&quot; when overwriting existing scopes
</code></pre>

<p> <em>Weston Ganger</em></p>
</li><li>
<p>Use full precision for <code>updated_at</code> in <code>insert_all</code>/<code>upsert_all</code></p>

<p><code>CURRENT_TIMESTAMP</code> provides differing precision depending on the database, and not all databases support explicitly specifying additional precision.</p>

<p>Instead, we delegate to the new <code>connection.high_precision_current_timestamp</code> for the SQL to produce a high precision timestamp on the current database.</p>

<p>Fixes #42992</p>

<p><em>Sam Bostock</em></p>
</li><li>
<p>Add ssl support for postgresql database tasks</p>

<p>Add <code>PGSSLMODE</code>, <code>PGSSLCERT</code>, <code>PGSSLKEY</code> and <code>PGSSLROOTCERT</code> to pg_env from database config when running postgresql database tasks.</p>

<pre><code># config/database.yml

production:
  sslmode: verify-full
  sslcert: client.crt
  sslkey: client.key
  sslrootcert: ca.crt
</code></pre>

<p>Environment variables</p>

<pre><code>PGSSLMODE=verify-full
PGSSLCERT=client.crt
PGSSLKEY=client.key
PGSSLROOTCERT=ca.crt
</code></pre>

<p>Fixes #42994</p>

<p><em>Michael Bayucot</em></p>
</li><li>
<p>Avoid scoping update callbacks in <code>ActiveRecord::Relation#update!</code>.</p>

<p>Making it consistent with how scoping is applied only to the query in <code>ActiveRecord::Relation#update</code> and not also to the callbacks from the update itself.</p>

<p><em>Dylan Thacker-Smith</em></p>
</li><li>
<p>Fix 2 cases that inferred polymorphic class from the association's <code>foreign_type</code> using <code>String#constantize</code> instead of the model's <code>polymorphic_class_for</code>.</p>

<p>When updating a polymorphic association, the old <code>foreign_type</code> was not inferred correctly when: 1. <code>touch</code>ing the previously associated record 2. updating the previously associated record's <code>counter_cache</code></p>

<p><em>Jimmy Bourassa</em></p>
</li><li>
<p>Add config option for ignoring tables when dumping the schema cache.</p>

<p>Applications can now be configured to ignore certain tables when dumping the schema cache.</p>

<p>The configuration option can table an array of tables:</p>

<pre><code>config.active_record.schema_cache_ignored_tables = [&quot;ignored_table&quot;, &quot;another_ignored_table&quot;]
</code></pre>

<p>Or a regex:</p>

<pre><code>config.active_record.schema_cache_ignored_tables = [/^_/]
</code></pre>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Make schema cache methods return consistent results.</p>

<p>Previously the schema cache methods <code>primary_keys</code>, <code>columns</code>, <code>columns_hash</code>, and <code>indexes</code> would behave differently than one another when a table didn't exist and differently across database adapters. This change unifies the behavior so each method behaves the same regardless of adapter.</p>

<p>The behavior now is:</p>

<p><code>columns</code>: (unchanged) raises a db error if the table does not exist. <code>columns_hash</code>: (unchanged) raises a db error if the table does not exist. <code>primary_keys</code>: (unchanged) returns <code>nil</code> if the table does not exist. <code>indexes</code>: (changed for mysql2) returns <code>[]</code> if the table does not exist.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Reestablish connection to previous database after after running <code>db:schema:load:name</code></p>

<p>After running <code>db:schema:load:name</code> the previous connection is restored.</p>

<p><em>Jacopo Beschi</em></p>
</li><li>
<p>Add database config option <code>database_tasks</code></p>

<p>If you would like to connect to an external database without any database management tasks such as schema management, migrations, seeds, etc. you can set the per database config option <code>database_tasks: false</code></p>

<pre><code># config/database.yml

production:
  primary:
    database: my_database
    adapter: mysql2
  animals:
    database: my_animals_database
    adapter: mysql2
    database_tasks: false
</code></pre>

<p><em>Weston Ganger</em></p>
</li><li>
<p>Fix <code>ActiveRecord::InternalMetadata</code> to not be broken by <code>config.active_record.record_timestamps = false</code></p>

<p>Since the model always create the timestamp columns, it has to set them, otherwise it breaks various DB management tasks.</p>

<p>Fixes #42983</p>
</li><li>
<p>Add <code>ActiveRecord::QueryLogs</code>.</p>

<p>Configurable tags can be automatically added to all SQL queries generated by Active Record.</p>

<pre><code># config/application.rb
module MyApp
  class Application &lt; Rails::Application
    config.active_record.query_log_tags_enabled = true
  end
end
</code></pre>

<p>By default the application, controller and action details are added to the query tags:</p>

<pre><code>class BooksController &lt; ApplicationController
  def index
    @books = Book.all
  end
end
</code></pre>

<pre><code>GET /books
# SELECT * FROM books /*application:MyApp;controller:books;action:index*/
</code></pre>

<p>Custom tags containing static values and Procs can be defined in the application configuration:</p>

<pre><code>config.active_record.query_log_tags = [
  :application,
  :controller,
  :action,
  {
    custom_static: &quot;foo&quot;,
    custom_dynamic: -&gt; { Time.now }
  }
]
</code></pre>

<p><em>Keeran Raj Hawoldar</em>, <em>Eileen M. Uchitelle</em>, <em>Kasper Timm Hansen</em></p>
</li><li>
<p>Added support for multiple databases to <code>rails db:setup</code> and <code>rails db:reset</code>.</p>

<p><em>Ryan Hall</em></p>
</li><li>
<p>Add <code>ActiveRecord::Relation#structurally_compatible?</code>.</p>

<p>Adds a query method by which a user can tell if the relation that they're about to use for <code>#or</code> or <code>#and</code> is structurally compatible with the receiver.</p>

<p><em>Kevin Newton</em></p>
</li><li>
<p>Add <code>ActiveRecord::QueryMethods#in_order_of</code>.</p>

<p>This allows you to specify an explicit order that you'd like records returned in based on a SQL expression. By default, this will be accomplished using a case statement, as in:</p>

<pre><code>Post.in_order_of(:id, [3, 5, 1])
</code></pre>

<p>will generate the SQL:</p>

<pre><code>SELECT &quot;posts&quot;.* FROM &quot;posts&quot; ORDER BY CASE &quot;posts&quot;.&quot;id&quot; WHEN 3 THEN 1 WHEN 5 THEN 2 WHEN 1 THEN 3 ELSE 4 END ASC
</code></pre>

<p>However, because this functionality is built into MySQL in the form of the <code>FIELD</code> function, that connection adapter will generate the following SQL instead:</p>

<pre><code>SELECT &quot;posts&quot;.* FROM &quot;posts&quot; ORDER BY FIELD(&quot;posts&quot;.&quot;id&quot;, 1, 5, 3) DESC
</code></pre>

<p><em>Kevin Newton</em></p>
</li><li>
<p>Fix <code>eager_loading?</code> when ordering with <code>Symbol</code>.</p>

<p><code>eager_loading?</code> is triggered correctly when using <code>order</code> with symbols.</p>

<pre><code>scope = Post.includes(:comments).order(:&quot;comments.label&quot;)
=&gt; true
</code></pre>

<p><em>Jacopo Beschi</em></p>
</li><li>
<p>Two change tracking methods are added for <code>belongs_to</code> associations.</p>

<p>The <code>association_changed?</code> method (assuming an association named <code>:association</code>) returns true if a different associated object has been assigned and the foreign key will be updated in the next save.</p>

<p>The <code>association_previously_changed?</code> method returns true if the previous save updated the association to reference a different associated object.</p>

<p><em>George Claghorn</em></p>
</li><li>
<p>Add option to disable schema dump per-database.</p>

<p>Dumping the schema is on by default for all databases in an application. To turn it off for a specific database, use the <code>schema_dump</code> option:</p>

<pre><code># config/database.yml

production:
  schema_dump: false
</code></pre>

<p><em>Luis Vasconcellos</em>, <em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Fix <code>eager_loading?</code> when ordering with <code>Hash</code> syntax.</p>

<p><code>eager_loading?</code> is triggered correctly when using <code>order</code> with hash syntax on an outer table.</p>

<pre><code>Post.includes(:comments).order({ &quot;comments.label&quot;: :ASC }).eager_loading?
# =&gt; true
</code></pre>

<p><em>Jacopo Beschi</em></p>
</li><li>
<p>Move the forcing of clear text encoding to the <code>ActiveRecord::Encryption::Encryptor</code>.</p>

<p>Fixes #42699.</p>

<p><em>J Smith</em></p>
</li><li>
<p><code>partial_inserts</code> is now disabled by default in new apps.</p>

<p>This will be the default for new apps in <a href="../../../classes/Rails.html"><code>Rails</code></a> 7. To opt in:</p>

<pre><code>config.active_record.partial_inserts = true
</code></pre>

<p>If a migration removes the default value of a column, this option would cause old processes to no longer be able to create new records.</p>

<p>If you need to remove a column, you should first use <code>ignored_columns</code> to stop using it.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p><a href="../../../classes/Rails.html"><code>Rails</code></a> can now verify foreign keys after loading fixtures in tests.</p>

<p>This will be the default for new apps in <a href="../../../classes/Rails.html"><code>Rails</code></a> 7. To opt in:</p>

<pre><code>config.active_record.verify_foreign_keys_for_fixtures = true
</code></pre>

<p>Tests will not run if there is a foreign key constraint violation in your fixture data.</p>

<p>The feature is supported by SQLite and PostgreSQL, other adapters can also add support for it.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Clear cached <code>has_one</code> association after setting <code>belongs_to</code> association to <code>nil</code>.</p>

<p>After setting a <code>belongs_to</code> relation to <code>nil</code> and updating an unrelated attribute on the owner, the owner should still return <code>nil</code> on the <code>has_one</code> relation.</p>

<p>Fixes #42597.</p>

<p><em>Michiel de Mare</em></p>
</li><li>
<p>OpenSSL constants are now used for <a href="../../../classes/Digest.html"><code>Digest</code></a> computations.</p>

<p><em>Dirkjan Bussink</em></p>
</li><li>
<p>Adds support for <code>if_not_exists</code> to <code>add_foreign_key</code> and <code>if_exists</code> to <code>remove_foreign_key</code>.</p>

<p>Applications can set their migrations to ignore exceptions raised when adding a foreign key that already exists or when removing a foreign key that does not exist.</p>

<p>Example Usage:</p>

<pre><code>class AddAuthorsForeignKeyToArticles &lt; ActiveRecord::Migration[7.0]
  def change
    add_foreign_key :articles, :authors, if_not_exists: true
  end
end
</code></pre>

<pre><code>class RemoveAuthorsForeignKeyFromArticles &lt; ActiveRecord::Migration[7.0]
  def change
    remove_foreign_key :articles, :authors, if_exists: true
  end
end
</code></pre>

<p><em>Roberto Miranda</em></p>
</li><li>
<p>Prevent polluting ENV during postgresql structure dump/load.</p>

<p>Some configuration parameters were provided to pg_dump / psql via environment variables which persisted beyond the command being run, and may have caused subsequent commands and connections to fail. Tasks running across multiple postgresql databases like <code>rails db:test:prepare</code> may have been affected.</p>

<p><em>Samuel Cochran</em></p>
</li><li>
<p>Set precision 6 by default for <code>datetime</code> columns.</p>

<p>By default, datetime columns will have microseconds precision instead of seconds precision.</p>

<p><em>Roberto Miranda</em></p>
</li><li>
<p>Allow preloading of associations with instance dependent scopes.</p>

<p><em>John Hawthorn</em>, <em>John Crepezzi</em>, <em>Adam Hess</em>, <em>Eileen M. Uchitelle</em>, <em>Dinah Shi</em></p>
</li><li>
<p>Do not try to rollback transactions that failed due to a <code>ActiveRecord::TransactionRollbackError</code>.</p>

<p><em>Jamie McCarthy</em></p>
</li><li>
<p>Active Record Encryption will now encode values as UTF-8 when using deterministic encryption. The encoding is part of the encrypted payload, so different encodings for different values result in different ciphertexts. This can break unique constraints and queries.</p>

<p>The new behavior is configurable via <code>active_record.encryption.forced_encoding_for_deterministic_encryption</code> that is <code>Encoding::UTF_8</code> by default. It can be disabled by setting it to <code>nil</code>.</p>

<p><em>Jorge Manrubia</em></p>
</li><li>
<p>The MySQL adapter now cast numbers and booleans bind parameters to string for safety reasons.</p>

<p>When comparing a string and a number in a query, MySQL converts the string to a number. So for instance <code>&quot;foo&quot; = 0</code>, will implicitly cast <code>&quot;foo&quot;</code> to <code>0</code> and will evaluate to <code>TRUE</code> which can lead to security vulnerabilities.</p>

<p>Active Record already protect against that vulnerability when it knows the type of the column being compared, however until now it was still vulnerable when using bind parameters:</p>

<pre><code>User.where(&quot;login_token = ?&quot;, 0).first
</code></pre>

<p>Would perform:</p>

<pre><code>SELECT * FROM `users` WHERE `login_token` = 0 LIMIT 1;
</code></pre>

<p>Now it will perform:</p>

<pre><code>SELECT * FROM `users` WHERE `login_token` = &#39;0&#39; LIMIT 1;
</code></pre>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fixture configurations (<code>_fixture</code>) are now strictly validated.</p>

<p>If an error will be raised if that entry contains unknown keys while previously it would silently have no effects.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base.update!</code> that works like <code>ActiveRecord::Base.update</code> but raises exceptions.</p>

<p>This allows for the same behavior as the instance method <code>#update!</code> at a class level.</p>

<pre><code>Person.update!(:all, state: &quot;confirmed&quot;)
</code></pre>

<p><em>Dorian Marié</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base#attributes_for_database</code>.</p>

<p>Returns attributes with values for assignment to the database.</p>

<p><em>Chris Salzberg</em></p>
</li><li>
<p>Use an empty query to check if the PostgreSQL connection is still active.</p>

<p>An empty query is faster than <code>SELECT 1</code>.</p>

<p><em>Heinrich Lee Yu</em></p>
</li><li>
<p>Add <code>ActiveRecord::Base#previously_persisted?</code>.</p>

<p>Returns <code>true</code> if the object has been previously persisted but now it has been deleted.</p>
</li><li>
<p>Deprecate <code>partial_writes</code> in favor of <code>partial_inserts</code> and <code>partial_updates</code>.</p>

<p>This allows to have a different behavior on update and create.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Fix compatibility with <code>psych &gt;= 4</code>.</p>

<p>Starting in Psych 4.0.0 <code>YAML.load</code> behaves like <code>YAML.safe_load</code>. To preserve compatibility, Active Record's schema cache loader and <code>YAMLColumn</code> now uses <code>YAML.unsafe_load</code> if available.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p><code>ActiveRecord::Base.logger</code> is now a <code>class_attribute</code>.</p>

<p>This means it can no longer be accessed directly through <code>@@logger</code>, and that setting <code>logger =</code> on a subclass won't change the parent's logger.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Add <code>.asc.nulls_first</code> for all databases. Unfortunately MySQL still doesn't like <code>nulls_last</code>.</p>

<p><em>Keenan Brock</em></p>
</li><li>
<p>Improve performance of <code>one?</code> and <code>many?</code> by limiting the generated count query to 2 results.</p>

<p><em>Gonzalo Riestra</em></p>
</li><li>
<p>Don't check type when using <code>if_not_exists</code> on <code>add_column</code>.</p>

<p>Previously, if a migration called <code>add_column</code> with the <code>if_not_exists</code> option set to true the <code>column_exists?</code> check would look for a column with the same name and type as the migration.</p>

<p>Recently it was discovered that the type passed to the migration is not always the same type as the column after migration. For example a column set to <code>:mediumblob</code> in the migration will be casted to <code>binary</code> when calling <code>column.type</code>. Since there is no straightforward way to cast the type to the database type without running the migration, we opted to drop the type check from <code>add_column</code>. This means that migrations adding a duplicate column with a different type will no longer raise an error.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Log a warning message when running SQLite in production.</p>

<p>Using SQLite in production ENV is generally discouraged. SQLite is also the default adapter in a new <a href="../../../classes/Rails.html"><code>Rails</code></a> application. For the above reasons log a warning message when running SQLite in production.</p>

<p>The warning can be disabled by setting <code>config.active_record.sqlite3_production_warning=false</code>.</p>

<p><em>Jacopo Beschi</em></p>
</li><li>
<p>Add option to disable joins for <code>has_one</code> associations.</p>

<p>In a multiple database application, associations can't join across databases. When set, this option instructs <a href="../../../classes/Rails.html"><code>Rails</code></a> to generate 2 or more queries rather than generating joins for <code>has_one</code> associations.</p>

<p>Set the option on a has one through association:</p>

<pre><code>class Person
  has_one :dog
  has_one :veterinarian, through: :dog, disable_joins: true
end
</code></pre>

<p>Then instead of generating join SQL, two queries are used for <code>@person.veterinarian</code>:</p>

<pre><code>SELECT &quot;dogs&quot;.&quot;id&quot; FROM &quot;dogs&quot; WHERE &quot;dogs&quot;.&quot;person_id&quot; = ?  [[&quot;person_id&quot;, 1]]
SELECT &quot;veterinarians&quot;.* FROM &quot;veterinarians&quot; WHERE &quot;veterinarians&quot;.&quot;dog_id&quot; = ?  [[&quot;dog_id&quot;, 1]]
</code></pre>

<p><em>Sarah Vessels</em>, <em>Eileen M. Uchitelle</em></p>
</li><li>
<p><code>Arel::Visitors::Dot</code> now renders a complete set of properties when visiting <code>Arel::Nodes::SelectCore</code>, <code>SelectStatement</code>, <code>InsertStatement</code>, <code>UpdateStatement</code>, and <code>DeleteStatement</code>, which fixes #42026. Previously, some properties were omitted.</p>

<p><em>Mike Dalessio</em></p>
</li><li>
<p><code>Arel::Visitors::Dot</code> now supports <code>Arel::Nodes::Bin</code>, <code>Case</code>, <code>CurrentRow</code>, <code>Distinct</code>, <code>DistinctOn</code>, <code>Else</code>, <code>Except</code>, <code>InfixOperation</code>, <code>Intersect</code>, <code>Lock</code>, <code>NotRegexp</code>, <code>Quoted</code>, <code>Regexp</code>, <code>UnaryOperation</code>, <code>Union</code>, <code>UnionAll</code>, <code>When</code>, and <code>With</code>. Previously, these node types caused an exception to be raised by <code>Arel::Visitors::Dot#accept</code>.</p>

<p><em>Mike Dalessio</em></p>
</li><li>
<p>Optimize <code>remove_columns</code> to use a single SQL statement.</p>

<pre><code>remove_columns :my_table, :col_one, :col_two
</code></pre>

<p>Now results in the following SQL:</p>

<pre><code>ALTER TABLE &quot;my_table&quot; DROP COLUMN &quot;col_one&quot;, DROP COLUMN &quot;col_two&quot;
</code></pre>

<p><em>Jon Dufresne</em></p>
</li><li>
<p>Ensure <code>has_one</code> autosave association callbacks get called once.</p>

<p>Change the <code>has_one</code> autosave callback to be non cyclic as well. By doing this the autosave callback are made more consistent for all 3 cases: <code>has_many</code>, <code>has_one</code>, and <code>belongs_to</code>.</p>

<p><em>Petrik de Heus</em></p>
</li><li>
<p>Add option to disable joins for associations.</p>

<p>In a multiple database application, associations can't join across databases. When set, this option instructs <a href="../../../classes/Rails.html"><code>Rails</code></a> to generate 2 or more queries rather than generating joins for associations.</p>

<p>Set the option on a has many through association:</p>

<pre><code>class Dog
  has_many :treats, through: :humans, disable_joins: true
  has_many :humans
end
</code></pre>

<p>Then instead of generating join SQL, two queries are used for <code>@dog.treats</code>:</p>

<pre><code>SELECT &quot;humans&quot;.&quot;id&quot; FROM &quot;humans&quot; WHERE &quot;humans&quot;.&quot;dog_id&quot; = ?  [[&quot;dog_id&quot;, 1]]
SELECT &quot;treats&quot;.* FROM &quot;treats&quot; WHERE &quot;treats&quot;.&quot;human_id&quot; IN (?, ?, ?)  [[&quot;human_id&quot;, 1], [&quot;human_id&quot;, 2], [&quot;human_id&quot;, 3]]
</code></pre>

<p><em>Eileen M. Uchitelle</em>, <em>Aaron Patterson</em>, <em>Lee Quarella</em></p>
</li><li>
<p>Add setting for enumerating column names in SELECT statements.</p>

<p>Adding a column to a PostgreSQL database, for example, while the application is running can change the result of wildcard <code>SELECT *</code> queries, which invalidates the result of cached prepared statements and raises a <code>PreparedStatementCacheExpired</code> error.</p>

<p>When enabled, Active Record will avoid wildcards and always include column names in <code>SELECT</code> queries, which will return consistent results and avoid prepared statement errors.</p>

<p>Before:</p>

<pre><code>Book.limit(5)
# SELECT * FROM books LIMIT 5
</code></pre>

<p>After:</p>

<pre><code># config/application.rb
module MyApp
  class Application &lt; Rails::Application
    config.active_record.enumerate_columns_in_select_statements = true
  end
end

# or, configure per-model
class Book &lt; ApplicationRecord
  self.enumerate_columns_in_select_statements = true
end
</code></pre>

<pre><code>Book.limit(5)
# SELECT id, author_id, name, format, status, language, etc FROM books LIMIT 5
</code></pre>

<p><em>Matt Duszynski</em></p>
</li><li>
<p>Allow passing SQL as <code>on_duplicate</code> value to <code>#upsert_all</code> to make it possible to use raw SQL to update columns on conflict:</p>

<pre><code>Book.upsert_all(
  [{ id: 1, status: 1 }, { id: 2, status: 1 }],
  on_duplicate: Arel.sql(&quot;status = GREATEST(books.status, EXCLUDED.status)&quot;)
)
</code></pre>

<p><em>Vladimir Dementyev</em></p>
</li><li>
<p>Allow passing SQL as <code>returning</code> statement to <code>#upsert_all</code>:</p>

<pre><code>Article.insert_all(
  [
    { title: &quot;Article 1&quot;, slug: &quot;article-1&quot;, published: false },
    { title: &quot;Article 2&quot;, slug: &quot;article-2&quot;, published: false }
  ],
  returning: Arel.sql(&quot;id, (xmax = &#39;0&#39;) as inserted, name as new_name&quot;)
)
</code></pre>

<p><em>Vladimir Dementyev</em></p>
</li><li>
<p>Deprecate <code>legacy_connection_handling</code>.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Add attribute encryption support.</p>

<p>Encrypted attributes are declared at the model level. These are regular Active Record attributes backed by a column with the same name. The system will transparently encrypt these attributes before saving them into the database and will decrypt them when retrieving their values.</p>

<pre><code>class Person &lt; ApplicationRecord
  encrypts :name
  encrypts :email_address, deterministic: true
end
</code></pre>

<p>You can learn more in the <a href="https://edgeguides.rubyonrails.org/active_record_encryption.html">Active Record Encryption guide</a>.</p>

<p><em>Jorge Manrubia</em></p>
</li><li>
<p>Changed <a href="../../../classes/Arel.html"><code>Arel</code></a> predications <code>contains</code> and <code>overlaps</code> to use <code>quoted_node</code> so that PostgreSQL arrays are quoted properly.</p>

<p><em>Bradley Priest</em></p>
</li><li>
<p>Add mode argument to record level <code>strict_loading!</code>.</p>

<p>This argument can be used when enabling strict loading for a single record to specify that we only want to raise on n plus one queries.</p>

<pre><code>developer.strict_loading!(mode: :n_plus_one_only)

developer.projects.to_a # Does not raise
developer.projects.first.client # Raises StrictLoadingViolationError
</code></pre>

<p>Previously, enabling strict loading would cause any lazily loaded association to raise an error. Using <code>n_plus_one_only</code> mode allows us to lazily load belongs_to, has_many, and other associations that are fetched through a single query.</p>

<p><em>Dinah Shi</em></p>
</li><li>
<p>Fix Float::INFINITY assignment to datetime column with postgresql adapter.</p>

<p>Before:</p>

<pre><code># With this config
ActiveRecord::Base.time_zone_aware_attributes = true

# and the following schema:
create_table &quot;postgresql_infinities&quot; do |t|
  t.datetime &quot;datetime&quot;
end

# This test fails
record = PostgresqlInfinity.create!(datetime: Float::INFINITY)
assert_equal Float::INFINITY, record.datetime # record.datetime gets nil
</code></pre>

<p>After this commit, <code>record.datetime</code> gets <code>Float::INFINITY</code> as expected.</p>

<p><em>Shunichi Ikegami</em></p>
</li><li>
<p>Type cast enum values by the original attribute type.</p>

<p>The notable thing about this change is that unknown labels will no longer match 0 on MySQL.</p>

<pre><code>class Book &lt; ActiveRecord::Base
  enum :status, { proposed: 0, written: 1, published: 2 }
end
</code></pre>

<p>Before:</p>

<pre><code># SELECT `books`.* FROM `books` WHERE `books`.`status` = &#39;prohibited&#39; LIMIT 1
Book.find_by(status: :prohibited)
# =&gt; #&lt;Book id: 1, status: &quot;proposed&quot;, ...&gt; (for mysql2 adapter)
# =&gt; ActiveRecord::StatementInvalid: PG::InvalidTextRepresentation: ERROR:  invalid input syntax for type integer: &quot;prohibited&quot; (for postgresql adapter)
# =&gt; nil (for sqlite3 adapter)
</code></pre>

<p>After:</p>

<pre><code># SELECT `books`.* FROM `books` WHERE `books`.`status` IS NULL LIMIT 1
Book.find_by(status: :prohibited)
# =&gt; nil (for all adapters)
</code></pre>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Fixtures for <code>has_many :through</code> associations now load timestamps on join tables.</p>

<p>Given this fixture:</p>

<pre><code>### monkeys.yml
george:
  name: George the Monkey
  fruits: apple

### fruits.yml
apple:
  name: apple
</code></pre>

<p>If the join table (<code>fruit_monkeys</code>) contains <code>created_at</code> or <code>updated_at</code> columns, these will now be populated when loading the fixture. Previously, fixture loading would crash if these columns were required, and leave them as null otherwise.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Allow applications to configure the thread pool for async queries.</p>

<p>Some applications may want one thread pool per database whereas others want to use a single global thread pool for all queries. By default, <a href="../../../classes/Rails.html"><code>Rails</code></a> will set <code>async_query_executor</code> to <code>nil</code> which will not initialize any executor. If <code>load_async</code> is called and no executor has been configured, the query will be executed in the foreground.</p>

<p>To create one thread pool for all database connections to use applications can set <code>config.active_record.async_query_executor</code> to <code>:global_thread_pool</code> and optionally define <code>config.active_record.global_executor_concurrency</code>. This defaults to 4. For applications that want to have a thread pool for each database connection, <code>config.active_record.async_query_executor</code> can be set to <code>:multi_thread_pool</code>. The configuration for each thread pool is set in the database configuration.</p>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Allow new syntax for <code>enum</code> to avoid leading <code>_</code> from reserved options.</p>

<p>Before:</p>

<pre><code>class Book &lt; ActiveRecord::Base
  enum status: [ :proposed, :written ], _prefix: true, _scopes: false
  enum cover: [ :hard, :soft ], _suffix: true, _default: :hard
end
</code></pre>

<p>After:</p>

<pre><code>class Book &lt; ActiveRecord::Base
  enum :status, [ :proposed, :written ], prefix: true, scopes: false
  enum :cover, [ :hard, :soft ], suffix: true, default: :hard
end
</code></pre>

<p><em>Ryuta Kamizono</em></p>
</li><li>
<p>Add <code>ActiveRecord::Relation#load_async</code>.</p>

<p>This method schedules the query to be performed asynchronously from a thread pool.</p>

<p>If the result is accessed before a background thread had the opportunity to perform the query, it will be performed in the foreground.</p>

<p>This is useful for queries that can be performed long enough before their result will be needed, or for controllers which need to perform several independent queries.</p>

<pre><code>def index
  @categories = Category.some_complex_scope.load_async
  @posts = Post.some_complex_scope.load_async
end
</code></pre>

<p>Active Record logs will also include timing info for the duration of how long the main thread had to wait to access the result. This timing is useful to know whether or not it's worth to load the query asynchronously.</p>

<pre><code>DEBUG -- :   Category Load (62.1ms)  SELECT * FROM `categories` LIMIT 50
DEBUG -- :   ASYNC Post Load (64ms) (db time 126.1ms)  SELECT * FROM `posts` LIMIT 100
</code></pre>

<p>The duration in the first set of parens is how long the main thread was blocked waiting for the results, and the second set of parens with "db time" is how long the entire query took to execute.</p>

<p><em>Jean Boussier</em></p>
</li><li>
<p>Implemented <code>ActiveRecord::Relation#excluding</code> method.</p>

<p>This method excludes the specified record (or collection of records) from the resulting relation:</p>

<pre><code>Post.excluding(post)
Post.excluding(post_one, post_two)
</code></pre>

<p>Also works on associations:</p>

<pre><code>post.comments.excluding(comment)
post.comments.excluding(comment_one, comment_two)
</code></pre>

<p>This is short-hand for <code>Post.where.not(id: post.id)</code> (for a single record) and <code>Post.where.not(id: [post_one.id, post_two.id])</code> (for a collection).</p>

<p><em>Glen Crawford</em></p>
</li><li>
<p>Skip optimised exist? query when include? is called on a relation with a having clause.</p>

<p>Relations that have aliased select values AND a having clause that references an aliased select value would generate an error when</p>

<h1 id="label-include-3F+was+called-2C+due+to+an+optimisation+that+would+generate">include? was called, due to an optimisation that would generate</h1>

<p>call exists? on the relation instead, which effectively alters the select values of the query (and thus removes the aliased select values), but leaves the having clause intact. Because the having clause is then referencing an aliased column that is no longer present in the simplified query, an ActiveRecord::InvalidStatement error was raised.</p>

<p>A sample query affected by this problem:</p>

<pre><code>Author.select(&#39;COUNT(*) as total_posts&#39;, &#39;authors.*&#39;)
      .joins(:posts)
      .group(:id)
      .having(&#39;total_posts &gt; 2&#39;)
      .include?(Author.first)
</code></pre>

<p>This change adds an addition check to the condition that skips the simplified exists? query, which simply checks for the presence of a having clause.</p>

<p>Fixes #41417.</p>

<p><em>Michael Smart</em></p>
</li><li>
<p>Increment postgres prepared statement counter before making a prepared statement, so if the statement is aborted without <a href="../../../classes/Rails.html"><code>Rails</code></a> knowledge (e.g., if app gets killed during long-running query or due to Rack::Timeout), app won't end up in perpetual crash state for being inconsistent with PostgreSQL.</p>

<p><em>wbharding</em>, <em>Martin Tepper</em></p>
</li><li>
<p>Add ability to apply <code>scoping</code> to <code>all_queries</code>.</p>

<p>Some applications may want to use the <code>scoping</code> method but previously it only worked on certain types of queries. This change allows the <code>scoping</code> method to apply to all queries for a model in a block.</p>

<pre><code>Post.where(blog_id: post.blog_id).scoping(all_queries: true) do
  post.update(title: &quot;a post title&quot;) # adds `posts.blog_id = 1` to the query
end
</code></pre>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p><code>ActiveRecord::Calculations.calculate</code> called with <code>:average</code> (aliased as <code>ActiveRecord::Calculations.average</code>) will now use column-based type casting. This means that floating-point number columns will now be aggregated as <code>Float</code> and decimal columns will be aggregated as <code>BigDecimal</code>.</p>

<p>Integers are handled as a special case returning <code>BigDecimal</code> always (this was the case before already).</p>

<pre><code># With the following schema:
create_table &quot;measurements&quot; do |t|
  t.float &quot;temperature&quot;
end

# Before:
Measurement.average(:temperature).class
# =&gt; BigDecimal

# After:
Measurement.average(:temperature).class
# =&gt; Float
</code></pre>

<p>Before this change, <a href="../../../classes/Rails.html"><code>Rails</code></a> just called <code>to_d</code> on average aggregates from the database adapter. This is not the case anymore. If you relied on that kind of magic, you now need to register your own <code>ActiveRecord::Type</code> (see <code>ActiveRecord::Attributes::ClassMethods</code> for documentation).</p>

<p><em>Josua Schmid</em></p>
</li><li>
<p>PostgreSQL: introduce <code>ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type</code>.</p>

<p>This setting controls what native type Active Record should use when you call <code>datetime</code> in a migration or schema. It takes a symbol which must correspond to one of the configured <code>NATIVE_DATABASE_TYPES</code>. The default is <code>:timestamp</code>, meaning <code>t.datetime</code> in a migration will create a "timestamp without time zone" column. To use "timestamp with time zone", change this to <code>:timestamptz</code> in an initializer.</p>

<p>You should run <code>bin/rails db:migrate</code> to rebuild your schema.rb if you change this.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>PostgreSQL: handle <code>timestamp with time zone</code> columns correctly in <code>schema.rb</code>.</p>

<p>Previously they dumped as <code>t.datetime :column_name</code>, now they dump as <code>t.timestamptz :column_name</code>, and are created as <code>timestamptz</code> columns when the schema is loaded.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Removing trailing whitespace when matching columns in <code>ActiveRecord::Sanitization.disallow_raw_sql!</code>.</p>

<p><em>Gannon McGibbon</em>, <em>Adrian Hirt</em></p>
</li><li>
<p>Expose a way for applications to set a <code>primary_abstract_class</code>.</p>

<p>Multiple database applications that use a primary abstract class that is not named <code>ApplicationRecord</code> can now set a specific class to be the <code>primary_abstract_class</code>.</p>

<pre><code>class PrimaryApplicationRecord
  self.primary_abstract_class
end
</code></pre>

<p>When an application boots it automatically connects to the primary or first database in the database configuration file. In a multiple database application that then call <code>connects_to</code> needs to know that the default connection is the same as the <code>ApplicationRecord</code> connection. However, some applications have a differently named <code>ApplicationRecord</code>. This prevents Active Record from opening duplicate connections to the same database.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p>
</li><li>
<p>Support hash config for <code>structure_dump_flags</code> and <code>structure_load_flags</code> flags. Now that Active Record supports multiple databases configuration, we need a way to pass specific flags for dump/load databases since the options are not the same for different adapters. We can use in the original way:</p>

<pre><code>ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = [&#39;--no-defaults&#39;, &#39;--skip-add-drop-table&#39;]
# or
ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = &#39;--no-defaults --skip-add-drop-table&#39;
</code></pre>

<p>And also use it passing a hash, with one or more keys, where the key is the adapter</p>

<pre><code>ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = {
  mysql2: [&#39;--no-defaults&#39;, &#39;--skip-add-drop-table&#39;],
  postgres: &#39;--no-tablespaces&#39;
}
</code></pre>

<p><em>Gustavo Gonzalez</em></p>
</li><li>
<p>Connection specification now passes the "url" key as a configuration for the adapter if the "url" protocol is "jdbc", "http", or "https". Previously only urls with the "jdbc" prefix were passed to the Active Record Adapter, others are assumed to be adapter specification urls.</p>

<p>Fixes #41137.</p>

<p><em>Jonathan Bracy</em></p>
</li><li>
<p>Allow to opt-out of <code>strict_loading</code> mode on a per-record base.</p>

<p>This is useful when strict loading is enabled application wide or on a model level.</p>

<pre><code>class User &lt; ApplicationRecord
  has_many :bookmarks
  has_many :articles, strict_loading: true
end

user = User.first
user.articles                        # =&gt; ActiveRecord::StrictLoadingViolationError
user.bookmarks                       # =&gt; #&lt;ActiveRecord::Associations::CollectionProxy&gt;

user.strict_loading!(true)           # =&gt; true
user.bookmarks                       # =&gt; ActiveRecord::StrictLoadingViolationError

user.strict_loading!(false)          # =&gt; false
user.bookmarks                       # =&gt; #&lt;ActiveRecord::Associations::CollectionProxy&gt;
user.articles.strict_loading!(false) # =&gt; #&lt;ActiveRecord::Associations::CollectionProxy&gt;
</code></pre>

<p><em>Ayrton De Craene</em></p>
</li><li>
<p>Add <code>FinderMethods#sole</code> and <code>#find_sole_by</code> to find and assert the presence of exactly one record.</p>

<p>Used when you need a single row, but also want to assert that there aren't multiple rows matching the condition; especially for when database constraints aren't enough or are impractical.</p>

<pre><code>Product.where([&quot;price = %?&quot;, price]).sole
# =&gt; ActiveRecord::RecordNotFound      (if no Product with given price)
# =&gt; #&lt;Product ...&gt;                    (if one Product with given price)
# =&gt; ActiveRecord::SoleRecordExceeded  (if more than one Product with given price)

user.api_keys.find_sole_by(key: key)
# as above
</code></pre>

<p><em>Asherah Connor</em></p>
</li><li>
<p>Makes <code>ActiveRecord::AttributeMethods::Query</code> respect the getter overrides defined in the model.</p>

<p>Before:</p>

<pre><code>class User
  def admin
    false # Overriding the getter to always return false
  end
end

user = User.first
user.update(admin: true)

user.admin # false (as expected, due to the getter overwrite)
user.admin? # true (not expected, returned the DB column value)
</code></pre>

<p>After this commit, <code>user.admin?</code> above returns false, as expected.</p>

<p>Fixes #40771.</p>

<p><em>Felipe</em></p>
</li><li>
<p>Allow delegated_type to be specified primary_key and foreign_key.</p>

<p>Since delegated_type assumes that the foreign_key ends with <code>_id</code>, <code>singular_id</code> defined by it does not work when the foreign_key does not end with <code>id</code>. This change fixes it by taking into account <code>primary_key</code> and <code>foreign_key</code> in the options.</p>

<p><em>Ryota Egusa</em></p>
</li><li>
<p>Expose an <code>invert_where</code> method that will invert all scope conditions.</p>

<pre><code>class User
  scope :active, -&gt; { where(accepted: true, locked: false) }
end

User.active
# ... WHERE `accepted` = 1 AND `locked` = 0

User.active.invert_where
# ... WHERE NOT (`accepted` = 1 AND `locked` = 0)
</code></pre>

<p><em>Kevin Deisz</em></p>
</li><li>
<p>Restore possibility of passing <code>false</code> to :polymorphic option of <code>belongs_to</code>.</p>

<p>Previously, passing <code>false</code> would trigger the option validation logic to throw an error saying :polymorphic would not be a valid option.</p>

<p><em>glaszig</em></p>
</li><li>
<p>Remove deprecated <code>database</code> kwarg from <code>connected_to</code>.</p>

<p><em>Eileen M. Uchitelle</em>, <em>John Crepezzi</em></p>
</li><li>
<p>Allow adding nonnamed expression indexes to be revertible.</p>

<p>Previously, the following code would raise an error, when executed while rolling back, and the index name should be specified explicitly. Now, the index name is inferred automatically.</p>

<pre><code>add_index(:items, &quot;to_tsvector(&#39;english&#39;, description)&quot;)
</code></pre>

<p>Fixes #40732.</p>

<p><em>fatkodima</em></p>
</li><li>
<p>Only warn about negative enums if a positive form that would cause conflicts exists.</p>

<p>Fixes #39065.</p>

<p><em>Alex Ghiculescu</em></p>
</li><li>
<p>Add option to run <code>default_scope</code> on all queries.</p>

<p>Previously, a <code>default_scope</code> would only run on select or insert queries. In some cases, like non-Rails tenant sharding solutions, it may be desirable to run <code>default_scope</code> on all queries in order to ensure queries are including a foreign key for the shard (i.e. <code>blog_id</code>).</p>

<p>Now applications can add an option to run on all queries including select, insert, delete, and update by adding an <code>all_queries</code> option to the default scope definition.</p>

<pre><code>class Article &lt; ApplicationRecord
  default_scope -&gt; { where(blog_id: Current.blog.id) }, all_queries: true
end
</code></pre>

<p><em>Eileen M. Uchitelle</em></p>
</li><li>
<p>Add <code>where.associated</code> to check for the presence of an association.</p>

<pre><code># Before:
account.users.joins(:contact).where.not(contact_id: nil)

# After:
account.users.where.associated(:contact)
</code></pre>

<p>Also mirrors <code>where.missing</code>.</p>

<p><em>Kasper Timm Hansen</em></p>
</li><li>
<p>Allow constructors (<code>build_association</code> and <code>create_association</code>) on <code>has_one :through</code> associations.</p>

<p><em>Santiago Perez Perret</em></p>
</li></ul>

<p>Please check <a href="https://github.com/rails/rails/blob/6-1-stable/activerecord/CHANGELOG.md">6-1-stable</a> for previous changes.</p>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
    
    
    
  
</div>

    </main>
  </body>
</html>
