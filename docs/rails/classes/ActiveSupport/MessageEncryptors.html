<!DOCTYPE html>
<html lang="en">
<head>
    <title>ActiveSupport::MessageEncryptors</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='["ActiveSupport", "MessageEncryptors"]'>


    <meta property="og:title" value="ActiveSupport::MessageEncryptors">

  

    <meta name="keywords" content="ActiveSupport::MessageEncryptors class, initialize, [], []=, rotate, rotate_defaults, clear_rotations, on_rotation">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            ActiveSupport::MessageEncryptors
            
                <span class="parent">&lt;
                    
                    Messages::RotationCoordinator
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../files/rails/activesupport/lib/active_support/message_encryptors_rb.html">rails/activesupport/lib/active_support/message_encryptors.rb</a></li>
            
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>#</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-5B-5D">[]</a>,
              </li>
            
              
              <li>
                <a href="#method-i-5B-5D-3D">[]=</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-clear_rotations">clear_rotations</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-initialize">initialize</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-on_rotation">on_rotation</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-rotate">rotate</a>,
              </li>
            
              
              <li>
                <a href="#method-i-rotate_defaults">rotate_defaults</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    
      <!-- Section attributes -->
      <h2 class="sectiontitle">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>transitional</td>
            <td class='attr-desc'><p>If true, the first two rotation option sets are swapped when building message encryptors. For example, with the following configuration, message encryptors will encrypt messages using <code>serializer: Marshal, url_safe: true</code>, and will able to decrypt messages that were encrypted using any of the three option sets:</p>

<pre><code>encryptors = ActiveSupport::MessageEncryptors.new { ... }
encryptors.rotate(serializer: JSON, url_safe: true)
encryptors.rotate(serializer: Marshal, url_safe: true)
encryptors.rotate(serializer: Marshal, url_safe: false)
encryptors.transitional = true
</code></pre>

<p>This can be useful when performing a rolling deploy of an application, wherein servers that have not yet been updated must still be able to decrypt messages from updated servers. In such a scenario, first perform a rolling deploy with the new rotation (e.g. <code>serializer: JSON, url_safe: true</code>) as the first rotation and <code>transitional = true</code>. Then, after all servers have been updated, perform a second rolling deploy with <code>transitional = false</code>.</p></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-5B-5D">
            
              <b>[](salt)
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-5B-5D" name="method-i-5B-5D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Returns a <a href="MessageEncryptor.html"><code>MessageEncryptor</code></a> configured with a secret derived from the given <code>salt</code>, and options from <a href="MessageEncryptors.html#method-i-rotate"><code>rotate</code></a>. <a href="MessageEncryptor.html"><code>MessageEncryptor</code></a> instances will be memoized, so the same <code>salt</code> will return the same instance.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-5B-5D_source')" id="l_method-i-5B-5D_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L48" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-5B-5D_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 48</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-5B-5D-3D">
            
              <b>[]=(salt, encryptor)
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-5B-5D-3D" name="method-i-5B-5D-3D" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Overrides a <a href="MessageEncryptor.html"><code>MessageEncryptor</code></a> instance associated with a given <code>salt</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-5B-5D-3D_source')" id="l_method-i-5B-5D-3D_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L56" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-5B-5D-3D_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 56</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-clear_rotations">
            
              <b>clear_rotations
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-clear_rotations" name="method-i-clear_rotations" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Clears the list of option sets.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-clear_rotations_source')" id="l_method-i-clear_rotations_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L117" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-clear_rotations_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 117</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-initialize">
            
              <b>initialize(&secret_generator)
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-initialize" name="method-i-initialize" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Initializes a new instance. <code>secret_generator</code> must accept a salt and a <code>secret_length</code> kwarg, and return a suitable secret (string) or secrets (array of strings). <code>secret_generator</code> may also accept other arbitrary kwargs. If <a href="MessageEncryptors.html#method-i-rotate"><code>rotate</code></a> is called with any options matching those kwargs, those options will be passed to <code>secret_generator</code> instead of to the message encryptor.</p>

<pre><code>encryptors = ActiveSupport::MessageEncryptors.new do |salt, secret_length:, base:|
  MySecretGenerator.new(base).generate(salt, secret_length)
end

encryptors.rotate(base: &quot;...&quot;)
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-initialize_source')" id="l_method-i-initialize_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L31" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-initialize_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 31</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-on_rotation">
            
              <b>on_rotation(&callback)
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-on_rotation" name="method-i-on_rotation" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Sets a callback to invoke when a message is decrypted using an option set other than the first.</p>

<p>For example, this callback could log each time it is called, and thus indicate whether old option sets are still in use or can be removed from rotation.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-on_rotation_source')" id="l_method-i-on_rotation_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L123" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-on_rotation_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 123</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rotate">
            
              <b>rotate(**options)<br />rotate(&block)
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-rotate" name="method-i-rotate" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Adds <code>options</code> to the list of option sets. <a href="Messages.html"><code>Messages</code></a> will be encrypted using the first set in the list. When decrypting, however, each set will be tried, in order, until one succeeds.</p>

<p>Notably, the <code>:secret_generator</code> option can specify a different secret generator than the one initially specified. The secret generator must respond to <code>call</code>, accept a salt and a <code>secret_length</code> kwarg, and return a suitable secret (string) or secrets (array of strings). The secret generator may also accept other arbitrary kwargs.</p>

<p>If any options match the kwargs of the operative secret generator, those options will be passed to the secret generator instead of to the message encryptor.</p>

<p>For fine-grained per-salt rotations, a block form is supported. The block will receive the salt, and should return an appropriate options <a href="../Hash.html"><code>Hash</code></a>. The block may also return <code>nil</code> to indicate that the rotation does not apply to the given salt. For example:</p>

<pre><code>encryptors = ActiveSupport::MessageEncryptors.new { ... }

encryptors.rotate do |salt|
  case salt
  when :foo
    { serializer: JSON, url_safe: true }
  when :bar
    { serializer: Marshal, url_safe: true }
  end
end

encryptors.rotate(serializer: Marshal, url_safe: false)

# Uses `serializer: JSON, url_safe: true`.
# Falls back to `serializer: Marshal, url_safe: false`.
encryptors[:foo]

# Uses `serializer: Marshal, url_safe: true`.
# Falls back to `serializer: Marshal, url_safe: false`.
encryptors[:bar]

# Uses `serializer: Marshal, url_safe: false`.
encryptors[:baz]
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-rotate_source')" id="l_method-i-rotate_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L62" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-rotate_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 62</span>
    </pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-rotate_defaults">
            
              <b>rotate_defaults
</b>
            
            <a href="../../classes/ActiveSupport/MessageEncryptors.html#method-i-rotate_defaults" name="method-i-rotate_defaults" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Invokes <a href="MessageEncryptors.html#method-i-rotate"><code>rotate</code></a> with the default options.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-rotate_defaults_source')" id="l_method-i-rotate_defaults_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activesupport/lib/active_support/message_encryptors.rb#L111" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-rotate_defaults_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activesupport/lib/active_support/message_encryptors.rb, line 111</span>
    </pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
