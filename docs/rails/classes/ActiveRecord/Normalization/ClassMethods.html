<!DOCTYPE html>
<html lang="en">
<head>
    <title>ActiveRecord::Normalization::ClassMethods</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='["ActiveRecord", "Normalization", "ClassMethods"]'>


    <meta property="og:title" value="ActiveRecord::Normalization::ClassMethods">

  

    <meta name="keywords" content="ActiveRecord::Normalization::ClassMethods class, normalizes, normalize_value_for">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Module</span>
            ActiveRecord::Normalization::ClassMethods
            
        </h2>
        <ul class="files">
            
            <li><a href="../../../files/rails/activerecord/lib/active_record/normalization_rb.html">rails/activerecord/lib/active_record/normalization.rb</a></li>
            
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-normalize_value_for">normalize_value_for</a>,
              </li>
            
              
              <li>
                <a href="#method-i-normalizes">normalizes</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
    
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-normalize_value_for">
            
              <b>normalize_value_for</b>(name, value)
            
            <a href="../../../classes/ActiveRecord/Normalization/ClassMethods.html#method-i-normalize_value_for" name="method-i-normalize_value_for" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Normalizes a given <code>value</code> using normalizations declared for <code>name</code>.</p>

<h4 id="method-i-normalize_value_for-label-Examples">Examples</h4>

<pre><code>class User &lt; ActiveRecord::Base
  normalizes :email, with: -&gt; email { email.strip.downcase }
end

User.normalize_value_for(:email, &quot; CRUISE-CONTROL@EXAMPLE.COM\n&quot;)
# =&gt; &quot;cruise-control@example.com&quot;
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-normalize_value_for_source')" id="l_method-i-normalize_value_for_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activerecord/lib/active_record/normalization.rb#L108" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-normalize_value_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activerecord/lib/active_record/normalization.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">normalize_value_for</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span>)
  <span class="ruby-identifier">type_for_attribute</span>(<span class="ruby-identifier">name</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-identifier">value</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-normalizes">
            
              <b>normalizes</b>(*names, with:, apply_to_nil: false)
            
            <a href="../../../classes/ActiveRecord/Normalization/ClassMethods.html#method-i-normalizes" name="method-i-normalizes" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Declares a normalization for one or more attributes. The normalization is applied when the attribute is assigned or updated, and the normalized value will be persisted to the database. The normalization is also applied to the corresponding keyword argument of query methods. This allows a record to be created and later queried using unnormalized values.</p>

<p>However, to prevent confusion, the normalization will not be applied when the attribute is fetched from the database. This means that if a record was persisted before the normalization was declared, the record’s attribute will not be normalized until either it is assigned a new value, or it is explicitly migrated via <a href="../Normalization.html#method-i-normalize_attribute"><code>Normalization#normalize_attribute</code></a>.</p>

<p>Because the normalization may be applied multiple times, it should be <em>idempotent</em>. In other words, applying the normalization more than once should have the same result as applying it only once.</p>

<p>By default, the normalization will not be applied to <code>nil</code> values. This behavior can be changed with the <code>:apply_to_nil</code> option.</p>

<p>Be aware that if your app was created before <a href="../../Rails.html"><code>Rails</code></a> 7.1, and your app marshals instances of the targeted model (for example, when caching), then you should set <a href="../../ActiveRecord.html#method-c-marshalling_format_version"><code>ActiveRecord.marshalling_format_version</code></a> to <code>7.1</code> or higher via either <code>config.load_defaults 7.1</code> or <code>config.active_record.marshalling_format_version = 7.1</code>. Otherwise, <code>Marshal</code> may attempt to serialize the normalization <code>Proc</code> and raise <code>TypeError</code>.</p>

<h4 id="method-i-normalizes-label-Options">Options</h4>
<ul><li>
<p><code>:with</code> - Any callable object that accepts the attribute’s value as its sole argument, and returns it normalized.</p>
</li><li>
<p><code>:apply_to_nil</code> - Whether to apply the normalization to <code>nil</code> values. Defaults to <code>false</code>.</p>
</li></ul>

<h4 id="method-i-normalizes-label-Examples">Examples</h4>

<pre><code>class User &lt; ActiveRecord::Base
  normalizes :email, with: -&gt; email { email.strip.downcase }
  normalizes :phone, with: -&gt; phone { phone.delete(&quot;^0-9&quot;).delete_prefix(&quot;1&quot;) }
end

user = User.create(email: &quot; CRUISE-CONTROL@EXAMPLE.COM\n&quot;)
user.email                  # =&gt; &quot;cruise-control@example.com&quot;

user = User.find_by(email: &quot;\tCRUISE-CONTROL@EXAMPLE.COM &quot;)
user.email                  # =&gt; &quot;cruise-control@example.com&quot;
user.email_before_type_cast # =&gt; &quot;cruise-control@example.com&quot;

User.where(email: &quot;\tCRUISE-CONTROL@EXAMPLE.COM &quot;).count         # =&gt; 1
User.where([&quot;email = ?&quot;, &quot;\tCRUISE-CONTROL@EXAMPLE.COM &quot;]).count # =&gt; 0

User.exists?(email: &quot;\tCRUISE-CONTROL@EXAMPLE.COM &quot;)         # =&gt; true
User.exists?([&quot;email = ?&quot;, &quot;\tCRUISE-CONTROL@EXAMPLE.COM &quot;]) # =&gt; false

User.normalize_value_for(:phone, &quot;+1 (555) 867-5309&quot;) # =&gt; &quot;5558675309&quot;
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-normalizes_source')" id="l_method-i-normalizes_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/activerecord/lib/active_record/normalization.rb#L88" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-normalizes_source" class="dyn-source">
                <pre><span class="ruby-comment"># File rails/activerecord/lib/active_record/normalization.rb, line 88</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">normalizes</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">names</span>, <span class="ruby-value">with:</span>, <span class="ruby-value">apply_to_nil:</span> <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">attribute</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cast_type</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">NormalizedValueType</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">cast_type:</span> <span class="ruby-identifier">cast_type</span>, <span class="ruby-value">normalizer:</span> <span class="ruby-identifier">with</span>, <span class="ruby-value">normalize_nil:</span> <span class="ruby-identifier">apply_to_nil</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">normalized_attributes</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_sym</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
