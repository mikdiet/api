<!DOCTYPE html>
<html lang="en">
<head>
    <title>SyntaxSuggest::BlockExpand</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
<link rel="stylesheet" href="/css/reset.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/panel.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/main.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<link rel="stylesheet" href="/css/github.css" type="text/css" media="screen" data-turbolinks-track="reload" />
<script src="/js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/main.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/highlight.pack.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/turbolinks.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/search_index.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searcher.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/panel/tree.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>
<script src="/js/searchdoc.js" type="text/javascript" charset="utf-8" data-turbolinks-track="reload"></script>

<meta name="data-rel-prefix" content="/">
<meta name="data-tree-keys" content='["SyntaxSuggest", "BlockExpand"]'>


    <meta property="og:title" value="SyntaxSuggest::BlockExpand">

  
    
    <meta name="description" content="This class is responsible for taking a code block that exists at a far indentaion and then iteratively increasing the block so that it captures everything within the same indentation block.">
    <meta property="og:description" content="This class is responsible for taking a code block that exists at a far indentaion and then iteratively increasing the block so that it captures everything within the same indentation block.">
  

    <meta name="keywords" content="SyntaxSuggest::BlockExpand class, new, call, expand_indent, expand_neighbors, inspect">
</head>

<body>
    <a class="sr-only sr-only-focusable" href="#content" data-turbolinks="false">Skip to Content</a>
    <a class="sr-only sr-only-focusable" href="#search" data-turbolinks="false">Skip to Search</a>

    <input type="checkbox" id="hamburger" class="panel_checkbox">
<label class="panel_mobile_button" for="hamburger"><span></span> Menu</label>
<nav class="panel panel_tree" id="panel" data-turbolinks-permanent>
  <div class="header">
    <input type="text" placeholder="Search (/) for a class, method, ..." autosave="searchdoc" results="10" id="search" autocomplete="off" tabindex="-1" />
    <label class="panel_mobile_button_close" for="hamburger"><span></span> Close</label>
  </div>
  <div class="tree">
    <ul>
    </ul>
  </div>
  <div class="result">
    <ul>
    </ul>
  </div>
  <a href="links.html" id="links">index</a>
</nav>


    <div class="banner">
        
        <h2>
            <span class="type">Class</span>
            SyntaxSuggest::BlockExpand
            
                <span class="parent">&lt;
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h2>
        <ul class="files">
            
            <li><a href="../../files/ruby/lib/syntax_suggest/block_expand_rb.html">ruby/lib/syntax_suggest/block_expand.rb</a></li>
            
        </ul>
    </div>

    <main id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>This class is responsible for taking a code block that exists at a far indentaion and then iteratively increasing the block so that it captures everything within the same indentation block.</p>

<pre><code>def dog
  puts &quot;bow&quot;
  puts &quot;wow&quot;
end
</code></pre>

<p>block = <a href="BlockExpand.html#method-c-new"><code>BlockExpand.new</code></a>(code_lines: code_lines)</p>

<pre><code>.call(CodeBlock.new(lines: code_lines[1]))
</code></pre>

<p>puts block.to_s # =&gt; puts “bow”</p>

<pre><code>puts &quot;wow&quot;
</code></pre>

<p>Once a code block has captured everything at a given indentation level then it will expand to capture surrounding indentation.</p>

<p>block = <a href="BlockExpand.html#method-c-new"><code>BlockExpand.new</code></a>(code_lines: code_lines)</p>

<pre><code>.call(block)
</code></pre>

<p>block.to_s # =&gt; def dog</p>

<pre><code>  puts &quot;bow&quot;
  puts &quot;wow&quot;
end
</code></pre>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-call">call</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-expand_indent">expand_indent</a>,
              </li>
            
              
              <li>
                <a href="#method-i-expand_neighbors">expand_neighbors</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-inspect">inspect</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
    
      <h2 class="sectiontitle">Class Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-c-new">
            
              <b>new</b>(code_lines:)
            
            <a href="../../classes/SyntaxSuggest/BlockExpand.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/lib/syntax_suggest/block_expand.rb#L34" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/syntax_suggest/block_expand.rb, line 34</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-value">code_lines:</span>)
  <span class="ruby-ivar">@code_lines</span> = <span class="ruby-identifier">code_lines</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
      <h2 class="sectiontitle">Instance Public methods</h2>
      
        <div class="method">
          <h3 class="title method-title" id="method-i-call">
            
              <b>call</b>(block)
            
            <a href="../../classes/SyntaxSuggest/BlockExpand.html#method-i-call" name="method-i-call" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Main interface. Expand current indentation, before expanding to a lower indentation</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-call_source')" id="l_method-i-call_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/lib/syntax_suggest/block_expand.rb#L40" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-call_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/syntax_suggest/block_expand.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">call</span>(<span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">next_block</span> = <span class="ruby-identifier">expand_neighbors</span>(<span class="ruby-identifier">block</span>))
    <span class="ruby-identifier">next_block</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">expand_indent</span>(<span class="ruby-identifier">block</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-expand_indent">
            
              <b>expand_indent</b>(block)
            
            <a href="../../classes/SyntaxSuggest/BlockExpand.html#method-i-expand_indent" name="method-i-expand_indent" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Expands code to the next lowest indentation</p>

<p>For example:</p>

<pre><code>1 def dog
2   print &quot;dog&quot;
3 end
</code></pre>

<p>If a block starts on line 2 then it has captured all it’s “neighbors” (code at the same indentation or higher). To continue expanding, this block must capture lines one and three which are at a different indentation level.</p>

<p>This method allows fully expanded blocks to decrease their indentation level (so they can expand to capture more code up and down). It does this conservatively as there’s no undo (currently).</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-expand_indent_source')" id="l_method-i-expand_indent_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/lib/syntax_suggest/block_expand.rb#L63" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-expand_indent_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/syntax_suggest/block_expand.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">expand_indent</span>(<span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">now</span> = <span class="ruby-constant">AroundBlockScan</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">code_lines:</span> <span class="ruby-ivar">@code_lines</span>, <span class="ruby-value">block:</span> <span class="ruby-identifier">block</span>)
    .<span class="ruby-identifier">force_add_hidden</span>
    .<span class="ruby-identifier">stop_after_kw</span>
    .<span class="ruby-identifier">scan_adjacent_indent</span>

  <span class="ruby-identifier">now</span>.<span class="ruby-identifier">lookahead_balance_one_line</span>

  <span class="ruby-identifier">now</span>.<span class="ruby-identifier">code_block</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-expand_neighbors">
            
              <b>expand_neighbors</b>(block)
            
            <a href="../../classes/SyntaxSuggest/BlockExpand.html#method-i-expand_neighbors" name="method-i-expand_neighbors" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>A neighbor is code that is at or above the current indent line.</p>

<p>First we build a block with all neighbors. If we can’t go further then we decrease the indentation threshold and expand via indentation i.e. ‘expand_indent`</p>

<p>Handles two general cases.</p>

<p>## Case #1: Check code inside of methods/classes/etc.</p>

<p>It’s important to note, that not everything in a given indentation level can be parsed as valid code even if it’s part of valid code. For example:</p>

<pre><code>1 hash = {
2   name: &quot;richard&quot;,
3   dog: &quot;cinco&quot;,
4 }
</code></pre>

<p>In this case lines 2 and 3 will be neighbors, but they’re invalid until ‘expand_indent` is called on them.</p>

<p>When we are adding code within a method or class (at the same indentation level), use the empty lines to denote the programmer intended logical chunks. Stop and check each one. For example:</p>

<pre><code>1 def dog
2   print &quot;dog&quot;
3
4   hash = {
5 end
</code></pre>

<p>If we did not stop parsing at empty newlines then the block might mistakenly grab all the contents (lines 2, 3, and 4) and report them as being problems, instead of only line 4.</p>

<p>## Case #2: Expand/grab other logical blocks</p>

<p>Once the search algorithm has converted all lines into blocks at a given indentation it will then ‘expand_indent`. Once the blocks that generates are expanded as neighbors we then begin seeing neighbors being other logical blocks i.e. a block’s neighbors may be another method or class (something with keywords/ends).</p>

<p>For example:</p>

<pre><code>1 def bark
2
3 end
4
5 def sit
6 end
</code></pre>

<p>In this case if lines 4, 5, and 6 are in a block when it tries to expand neighbors it will expand up. If it stops after line 2 or 3 it may cause problems since there’s a valid kw/end pair, but the block will be checked without it.</p>

<p>We try to resolve this edge case with ‘lookahead_balance_one_line` below.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-expand_neighbors_source')" id="l_method-i-expand_neighbors_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/lib/syntax_suggest/block_expand.rb#L130" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-expand_neighbors_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/syntax_suggest/block_expand.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">expand_neighbors</span>(<span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">now</span> = <span class="ruby-constant">AroundBlockScan</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">code_lines:</span> <span class="ruby-ivar">@code_lines</span>, <span class="ruby-value">block:</span> <span class="ruby-identifier">block</span>)

  <span class="ruby-comment"># Initial scan</span>
  <span class="ruby-identifier">now</span>
    .<span class="ruby-identifier">force_add_hidden</span>
    .<span class="ruby-identifier">stop_after_kw</span>
    .<span class="ruby-identifier">scan_neighbors_not_empty</span>

  <span class="ruby-comment"># Slurp up empties</span>
  <span class="ruby-identifier">now</span>
    .<span class="ruby-identifier">scan_while</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">empty?</span> }

  <span class="ruby-comment"># If next line is kw and it will balance us, take it</span>
  <span class="ruby-identifier">expanded_lines</span> = <span class="ruby-identifier">now</span>
    .<span class="ruby-identifier">lookahead_balance_one_line</span>
    .<span class="ruby-identifier">lines</span>

  <span class="ruby-comment"># Don&#39;t allocate a block if it won&#39;t be used</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># If nothing was taken, return nil to indicate that status</span>
  <span class="ruby-comment"># used in `def call` to determine if</span>
  <span class="ruby-comment"># we need to expand up/out (`expand_indent`)</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">lines</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">expanded_lines</span>
    <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">CodeBlock</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">lines:</span> <span class="ruby-identifier">expanded_lines</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 class="title method-title" id="method-i-inspect">
            
              <b>inspect</b>()
            
            <a href="../../classes/SyntaxSuggest/BlockExpand.html#method-i-inspect" name="method-i-inspect" class="permalink">Link</a>
          </h3>

          
            <div class="description">
              <p>Managable rspec errors</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                <a href="javascript:toggleSource('method-i-inspect_source')" id="l_method-i-inspect_source">show</a>
                
                  | <a href="https://github.com/ruby/ruby/blob/49dc0a12f185d791f1826396035b54cf3fb1771e/lib/syntax_suggest/block_expand.rb#L161" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-inspect_source" class="dyn-source">
                <pre><span class="ruby-comment"># File ruby/lib/syntax_suggest/block_expand.rb, line 161</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">inspect</span>
  <span class="ruby-string">&quot;#&lt;SyntaxSuggest::CodeBlock:0x0000123843lol &gt;&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </main>
  </body>
</html>
